# Apply: actually create Fastmail resources (labels, contact groups, mailboxes)
# for the triage categories in the configmap.
#
# Usage:
#   kubectl apply -f k8s/setup-job-apply.yaml
#   kubectl logs -n mailroom job/mailroom-setup-apply
#   kubectl delete job -n mailroom mailroom-setup-apply
#
apiVersion: batch/v1
kind: Job
metadata:
  name: mailroom-setup-apply
  namespace: mailroom
spec:
  # Don't retry on failure â€” run once, check logs if it fails.
  backoffLimit: 0
  template:
    spec:
      # Required for Jobs (Kubernetes defaults to Always, which isn't valid here).
      restartPolicy: Never
      containers:
        - name: setup
          image: ghcr.io/hellothisisflo/mailroom:latest
          tty: true
          command: ["python", "-m", "mailroom", "setup", "--apply"]
          envFrom:
            - configMapRef:
                name: mailroom-config
            - secretRef:
                name: mailroom-secrets
