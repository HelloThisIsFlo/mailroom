---
phase: 07-setup-script
plan: 04
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mailroom/setup/reporting.py
  - src/mailroom/setup/provisioner.py
  - src/mailroom/setup/sieve_guidance.py
  - tests/test_provisioner.py
  - tests/test_sieve_guidance.py
autonomous: true
requirements: [SETUP-01, SETUP-02, SETUP-03, SETUP-04, SETUP-05, SETUP-06]
gap_closure: true

must_haves:
  truths:
    - "Sieve rules section appears BEFORE resource plan so resources are at the bottom of output"
    - "Exists vs create statuses are visually distinct via ANSI color"
    - "Resources split into 4 categories: Mailboxes, Action Labels, Contact Groups, Mailroom-specific"
    - "@MailroomError and @MailroomWarning appear in a separate 'Mailroom' section, not in Mailboxes"
    - "UI guide mode highlights override names (e.g., Inbox from Imbox) in a different color than matching names"
  artifacts:
    - path: "src/mailroom/setup/reporting.py"
      provides: "Colorized terraform-style output with 4 resource categories"
      exports: ["print_plan", "ResourceAction"]
    - path: "src/mailroom/setup/sieve_guidance.py"
      provides: "Color-coded folder names in UI guide with override highlighting"
      exports: ["generate_sieve_guidance"]
  key_links:
    - from: "src/mailroom/setup/provisioner.py"
      to: "src/mailroom/setup/reporting.py"
      via: "run_setup prints sieve guidance BEFORE resource plan"
      pattern: "generate_sieve_guidance.*print_plan"
    - from: "src/mailroom/setup/reporting.py"
      to: "sys.stdout"
      via: "ANSI color codes for status differentiation"
      pattern: "\\033\\["
---

<objective>
Close two UAT gaps in the setup command output: (1) improve visual hierarchy by reordering sections, adding color, and splitting into 4 resource categories; (2) highlight override names in UI guide mode with distinct color.

Purpose: The user found the setup output too verbose and hard to scan. Sieve rules cause scrolling past the resource plan, exists/create statuses are not visually distinct, and @MailroomError/@MailroomWarning are mixed in with regular Mailboxes. Additionally, UI guide mode should highlight when a folder name differs from the category name (e.g., "Inbox" for the "Imbox" category).

Output: Improved reporting module with ANSI colors, 4 resource categories, reordered output (sieve rules first, resources last), and color-coded override names in sieve guidance.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/STATE.md
@.planning/phases/07-setup-script/07-CONTEXT.md
@.planning/phases/07-setup-script/07-02-SUMMARY.md
@.planning/phases/07-setup-script/07-03-SUMMARY.md
@.planning/phases/07-setup-script/07-UAT.md

<interfaces>
<!-- Current interfaces that this plan modifies -->

From src/mailroom/setup/reporting.py (current):
```python
@dataclass
class ResourceAction:
    kind: str           # "mailbox", "label", "contact_group"
    name: str
    status: str         # "exists", "create", "created", "failed", "skipped"
    parent: str | None = None
    error: str | None = None

def print_plan(actions: list[ResourceAction], apply: bool) -> None: ...
```

From src/mailroom/setup/provisioner.py (current):
```python
def run_setup(apply: bool = False, ui_guide: bool = False) -> int: ...
def plan_resources(settings, jmap, carddav) -> list[ResourceAction]: ...
def apply_resources(plan, jmap, carddav) -> list[ResourceAction]: ...
```

From src/mailroom/setup/sieve_guidance.py (current):
```python
def generate_sieve_guidance(settings: MailroomSettings, *, ui_guide: bool = False) -> str: ...
```

From src/mailroom/core/config.py:
```python
@dataclass(frozen=True)
class ResolvedCategory:
    name: str
    label: str
    contact_group: str
    destination_mailbox: str
    contact_type: str
    parent: str | None

class MailroomSettings(BaseSettings):
    label_mailroom_error: str = "@MailroomError"
    label_mailroom_warning: str = "@MailroomWarning"
    warnings_enabled: bool = True
    screener_mailbox: str = "Screener"
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Add ANSI coloring, 4 resource categories, and reorder output</name>
  <files>src/mailroom/setup/reporting.py, src/mailroom/setup/provisioner.py, tests/test_provisioner.py</files>
  <action>
**Gap 1 closure: Visual hierarchy improvements.**

1. Update `src/mailroom/setup/reporting.py`:

   a. **Add a new resource kind `"mailroom"`** to represent @MailroomError and @MailroomWarning. The ResourceAction `kind` field gains a 4th value: `"mailroom"` (alongside `"mailbox"`, `"label"`, `"contact_group"`).

   b. **Add ANSI color helpers** at the top of the file. Use a simple approach -- define color constants and a helper that wraps text in ANSI codes. Respect `NO_COLOR` env var (if set, skip coloring). Also detect if stdout is a TTY -- if not a TTY, skip coloring (so captured StringIO in tests gets plain text).

   ```python
   import os

   # ANSI color codes
   _GREEN = "\033[32m"
   _YELLOW = "\033[33m"
   _RED = "\033[31m"
   _DIM = "\033[2m"
   _RESET = "\033[0m"
   _CYAN = "\033[36m"

   def _use_color() -> bool:
       """Return True if ANSI color should be used."""
       if os.environ.get("NO_COLOR"):
           return False
       return hasattr(sys.stdout, "isatty") and sys.stdout.isatty()

   def _color(text: str, code: str) -> str:
       """Wrap text in ANSI color if color is enabled."""
       if not _use_color():
           return text
       return f"{code}{text}{_RESET}"
   ```

   c. **Color the status symbols and text:**
   - `"exists"` status: green checkmark and dim "exists" text -- `_color("✓", _GREEN)` and `_color("exists", _DIM)`
   - `"create"` status: yellow `+` and yellow "create" text -- `_color("+", _YELLOW)` and `_color("create", _YELLOW)`
   - `"created"` status: green checkmark and green "created" text -- `_color("✓", _GREEN)` and `_color("created", _GREEN)`
   - `"failed"` status: red X and red "FAILED: ..." text -- `_color("✗", _RED)` and `_color(f"FAILED: {error}", _RED)`
   - `"skipped"` status: dim circle-slash and dim "skipped" text -- `_color("⊘", _DIM)` and `_color(f"skipped ({error})", _DIM)`

   d. **Update `_print_section` and `print_plan`** to handle 4 sections:
   - Split actions into: `mailboxes` (kind=`"mailbox"`), `labels` (kind=`"label"`), `groups` (kind=`"contact_group"`), `mailroom` (kind=`"mailroom"`)
   - Print in this order: Mailboxes, Action Labels, Contact Groups, Mailroom
   - Section header "Mailroom" for the 4th category (containing @MailroomError, @MailroomWarning)

   e. **Update `_format_status`** to use color helpers for the status text column.

   f. **Update `_print_section`** to use colored symbol.

2. Update `src/mailroom/setup/provisioner.py`:

   a. **Reorder output in `run_setup()`**: Print sieve guidance FIRST, then the resource plan. Change both the dry-run and apply paths:

   Current order (dry-run path):
   ```python
   print_plan(resource_plan, apply=False)
   print()
   print(generate_sieve_guidance(settings, ui_guide=ui_guide))
   ```

   New order (dry-run path):
   ```python
   print(generate_sieve_guidance(settings, ui_guide=ui_guide))
   print()
   print_plan(resource_plan, apply=False)
   ```

   Same reordering for the apply path.

   b. **Categorize @MailroomError and @MailroomWarning as `kind="mailroom"`** in `plan_resources()`:

   Currently, these are in `required_mailboxes` and get categorized as `kind="mailbox"`. They need to be extracted and given `kind="mailroom"` instead.

   Add a set for mailroom-specific names: `mailroom_names = {settings.label_mailroom_error}` and if `settings.warnings_enabled`: add `settings.label_mailroom_warning`.

   In the loop that creates mailbox actions, skip names that are in `mailroom_names`. Add a separate loop after the contact groups loop:

   ```python
   # Mailroom-specific resources (error/warning labels)
   for name in sorted(mailroom_names):
       status = "exists" if name in existing_mailboxes else "create"
       actions.append(ResourceAction(kind="mailroom", name=name, status=status))
   ```

3. Update `tests/test_provisioner.py`:

   a. **Update `test_categorizes_correctly`**: Verify that `@MailroomError` and `@MailroomWarning` are now in kind=`"mailroom"`, NOT kind=`"mailbox"`. Update assertions:
   ```python
   # Mailroom-specific
   mailroom_names = {a.name for a in actions if a.kind == "mailroom"}
   assert "@MailroomError" in mailroom_names
   assert "@MailroomWarning" in mailroom_names

   # Mailboxes should NOT contain error/warning labels
   assert "@MailroomError" not in mailbox_names
   assert "@MailroomWarning" not in mailbox_names
   ```

   b. **Update reporting tests**: The `test_dry_run_output` test should also check for the "Mailroom" section header. Add `assert "Mailroom" in output` (being careful it doesn't false-positive on "Mailroom" in other text -- the section header is on its own line). Also add a ResourceAction with kind=`"mailroom"` to the test actions list:
   ```python
   ResourceAction(kind="mailroom", name="@MailroomError", status="exists"),
   ```

   c. **Add `test_output_order_sieve_before_resources`**: This is a test on `run_setup` behavior, but since we can't easily test run_setup without real clients, instead add a comment noting the ordering is tested by the human tests. Or better: add a simple test that verifies reporting output doesn't contain sieve text (confirming separation of concerns -- reporting module handles resources, provisioner handles ordering).

   d. **Ensure color tests work**: Since color is TTY-dependent and tests capture via capsys (not a TTY), the test assertions for plain text (no ANSI codes) should still work. Add one explicit test: `test_no_color_when_not_tty` -- call `print_plan` and verify output does NOT contain `\033[` escape sequences (since capsys is not a TTY).

   e. **Update the `test_dry_run_output` summary assertion**: With the 4th category, the count might change. The test currently has 6 actions (2 mailbox, 2 label, 2 contact_group). Add 1 mailroom action. Update the summary assertion from "3 to create · 3 existing" to "3 to create · 4 existing" (since the mailroom one is "exists"). Alternatively, make the new mailroom action status "create" to keep the math symmetric -- adjust as needed to match the action list.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && uv run pytest tests/test_provisioner.py -x -v</automated>
  </verify>
  <done>
    - reporting.py uses ANSI colors for status symbols and text (green for exists/created, yellow for create, red for failed, dim for skipped)
    - Color disabled when NO_COLOR env var set or stdout is not a TTY
    - Resources split into 4 sections: Mailboxes, Action Labels, Contact Groups, Mailroom
    - @MailroomError and @MailroomWarning in "Mailroom" section with kind="mailroom"
    - Sieve guidance printed BEFORE resource plan in run_setup()
    - All tests pass including updated categorization and reporting tests
  </done>
</task>

<task type="auto">
  <name>Task 2: Color-code override names in UI guide and sieve guidance output</name>
  <files>src/mailroom/setup/sieve_guidance.py, tests/test_sieve_guidance.py</files>
  <action>
**Gap 2 closure: Override name highlighting in sieve guidance.**

1. Update `src/mailroom/setup/sieve_guidance.py`:

   a. **Add the same ANSI color helpers** as reporting.py (or share them -- simplest approach is to duplicate the small helper since sieve_guidance returns a string, not printing directly). Since sieve_guidance returns a string that the caller prints, the color check should be done at generation time. Add the same `_use_color()` and `_color()` helpers.

   b. **Identify override names**: An "override" is when `category.destination_mailbox != category.name`. For example, the Imbox category has `destination_mailbox="Inbox"` which differs from name `"Imbox"` -- so "Inbox" is an override name. Feed has `destination_mailbox="Feed"` which matches name `"Feed"` -- not an override.

   c. **In `_build_ui_guide()`**: When printing the folder name in each category's step:
   - If `destination_mailbox == category.name`: print normally (or use cyan/default)
   - If `destination_mailbox != category.name`: highlight the folder name with a distinct color (use `_CYAN` for overrides) to show it differs from the category name

   Currently the line is:
   ```python
   f'      Step 3b: Set action to "Move to folder" = "{cat.destination_mailbox}"'
   ```

   Change to:
   ```python
   folder_name = cat.destination_mailbox
   if cat.destination_mailbox != cat.name:
       folder_name = _color(cat.destination_mailbox, _CYAN)
   f'      Step 3b: Set action to "Move to folder" = "{folder_name}"'
   ```

   d. **In `_build_sieve_snippets()`**: Apply the same override highlighting to the `Action: Move to folder` line and the `fileinto` sieve reference line:
   - `Action: Move to folder "{folder_name}"` where folder_name is colored if it's an override
   - `# { fileinto "INBOX.{folder_name}"; }` where folder_name is colored if override

   e. **Pass root categories with their names**: The `_build_sieve_snippets` and `_build_ui_guide` functions already receive `root_categories` which are `ResolvedCategory` objects containing both `name` and `destination_mailbox`. No API change needed -- just use the comparison.

   f. **Also color the contact_group in UI guide if it differs from name**: The Imbox category has `contact_group="Imbox"` which matches its name, so no override there. But if a custom config sets a different contact_group name, that should also be highlighted. For now, focus only on `destination_mailbox` overrides since that's what the user specifically reported about (Inbox vs Imbox).

2. Update `tests/test_sieve_guidance.py`:

   a. **Add `test_override_name_not_colored_when_not_tty`**: Generate guidance with a non-TTY stdout. Assert the output contains `"Inbox"` plainly (no ANSI codes). This confirms the override is present but not colored in non-TTY contexts.

   b. **Add `test_override_detected_for_imbox`**: Verify that when Imbox category has destination_mailbox="Inbox", the string "Inbox" appears in the guidance output (already implicitly tested, but make it explicit as an override-awareness test).

   c. **Add `test_matching_name_not_marked_as_override`**: For the Feed category (name="Feed", destination_mailbox="Feed"), verify the folder name appears without any special treatment. Since tests run in non-TTY, this is the same as no ANSI codes around "Feed".

   d. **Add a TTY simulation test** (optional but valuable): Use monkeypatch to temporarily make `sys.stdout.isatty` return True. Then check that the output for Imbox's destination contains ANSI color codes around "Inbox". Be sure to restore stdout after:
   ```python
   def test_override_name_colored_when_tty(self, settings, monkeypatch):
       """Override names get ANSI color when stdout is a TTY."""
       monkeypatch.setattr("sys.stdout.isatty", lambda: True)
       # Also need to ensure NO_COLOR is not set
       monkeypatch.delenv("NO_COLOR", raising=False)
       output = generate_sieve_guidance(settings, ui_guide=True)
       # Should contain ANSI cyan around "Inbox" (override of Imbox)
       assert "\033[36m" in output  # cyan code present
       assert "Inbox" in output
   ```
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && uv run pytest tests/test_sieve_guidance.py -x -v</automated>
  </verify>
  <done>
    - UI guide mode highlights override folder names (e.g., "Inbox" from Imbox) with cyan ANSI color
    - Default sieve snippet mode also highlights override folder names in Action and fileinto lines
    - Non-override names (e.g., "Feed" for Feed category) are not highlighted
    - Color disabled when NO_COLOR set or stdout is not a TTY
    - All sieve guidance tests pass including new override-highlighting tests
  </done>
</task>

</tasks>

<verification>
```bash
# All unit tests pass
cd /Users/flo/Work/Private/Dev/Services/mailroom && uv run pytest tests/ -x -v

# Import check
uv run python -c "from mailroom.setup.reporting import print_plan, ResourceAction; from mailroom.setup.sieve_guidance import generate_sieve_guidance; print('ok')"

# Quick visual check (will show colored output if terminal supports it)
uv run python -c "
from mailroom.setup.reporting import ResourceAction, print_plan
actions = [
    ResourceAction(kind='mailbox', name='Inbox', status='exists'),
    ResourceAction(kind='mailbox', name='Feed', status='create'),
    ResourceAction(kind='label', name='@ToFeed', status='create'),
    ResourceAction(kind='contact_group', name='Feed', status='create'),
    ResourceAction(kind='mailroom', name='@MailroomError', status='exists'),
]
print_plan(actions, apply=False)
"
```
</verification>

<success_criteria>
- Sieve rules guidance appears BEFORE resource plan (resources at bottom, easy to scan)
- Exists status uses green color, create uses yellow, failed uses red, skipped uses dim
- 4 resource sections: Mailboxes, Action Labels, Contact Groups, Mailroom
- @MailroomError and @MailroomWarning in dedicated "Mailroom" section
- Override folder names (e.g., Inbox for Imbox) highlighted with cyan in UI guide and sieve snippets
- Non-override folder names printed normally
- Color respects NO_COLOR env var and non-TTY contexts
- All existing tests pass (no regressions)
- Human tests 14 and 15 still pass (output format changes are additive)
</success_criteria>

<output>
After completion, create `.planning/phases/07-setup-script/07-04-SUMMARY.md`
</output>
