---
phase: 09-tech-debt-cleanup
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - human-tests/test_3_label.py
  - human-tests/test_7_screener_poll.py
  - human-tests/test_8_conflict_detection.py
  - human-tests/test_9_already_grouped.py
  - human-tests/test_10_retry_safety.py
  - human-tests/test_11_person_contact.py
  - human-tests/test_12_company_contact.py
  - .env.example
  - k8s/configmap.yaml
  - src/mailroom/clients/jmap.py
  - tests/test_jmap_client.py
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "Human tests 3, 7-12 reference only current settings API (no AttributeError on label_to_group_mapping, label_to_imbox, or label_to_person)"
    - ".env.example documents MAILROOM_TRIAGE_CATEGORIES, MAILROOM_DEBOUNCE_SECONDS, POLL_INTERVAL=60, and does not reference deleted label/group vars"
    - "k8s/configmap.yaml matches .env.example — same env vars, correct defaults, no stale references"
    - "JMAPClient has no session_capabilities property or _session_capabilities references"
  artifacts:
    - path: "human-tests/test_3_label.py"
      provides: "Updated label reference using current API"
      contains: "@ToImbox"
    - path: "human-tests/test_7_screener_poll.py"
      provides: "Updated mailbox resolution using label_to_category_mapping"
      contains: "label_to_category_mapping"
    - path: ".env.example"
      provides: "Current v1.1 config documentation"
      contains: "MAILROOM_TRIAGE_CATEGORIES"
    - path: "k8s/configmap.yaml"
      provides: "Current v1.1 k8s deployment config"
      contains: "MAILROOM_DEBOUNCE_SECONDS"
  key_links:
    - from: "human-tests/test_*.py"
      to: "src/mailroom/core/config.py"
      via: "settings attribute access"
      pattern: "label_to_category_mapping"
    - from: ".env.example"
      to: "k8s/configmap.yaml"
      via: "env var parity"
      pattern: "MAILROOM_TRIAGE_CATEGORIES"
---

<objective>
Fix stale human test API references, sync deployment artifacts to current config schema, and remove dead session_capabilities code.

Purpose: Human tests 3, 7-12 raise AttributeError because they reference deleted v1.0 settings attributes. Deployment artifacts (.env.example, k8s/configmap.yaml) still advertise 9 deleted env vars. JMAPClient carries unused session_capabilities code. All are mechanical fixes prescribed by the v1.1 milestone audit.

Output: 7 human tests using current API, deployment artifacts matching current config, dead code removed.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-tech-debt-cleanup/09-RESEARCH.md
@src/mailroom/core/config.py

<interfaces>
<!-- Current settings API the executor must use in human tests -->

From src/mailroom/core/config.py:

```python
class ResolvedCategory:
    name: str
    label: str           # e.g. "@ToImbox"
    contact_group: str   # e.g. "Imbox"
    destination_mailbox: str  # e.g. "Inbox"
    contact_type: str    # "company" or "person"
    parent: str | None

# Key properties on MailroomSettings:
settings.triage_labels -> list[str]                          # ["@ToImbox", "@ToFeed", ...]
settings.label_to_category_mapping -> dict[str, ResolvedCategory]  # {"@ToImbox": ResolvedCategory(...), ...}
settings.required_mailboxes -> list[str]                     # deduplicated list of all needed mailboxes
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Update human tests 3, 7-12 to use current settings API</name>
  <files>
    human-tests/test_3_label.py
    human-tests/test_7_screener_poll.py
    human-tests/test_8_conflict_detection.py
    human-tests/test_9_already_grouped.py
    human-tests/test_10_retry_safety.py
    human-tests/test_11_person_contact.py
    human-tests/test_12_company_contact.py
  </files>
  <action>
    Replace all references to deleted v1.0 settings attributes with current API equivalents. There are 3 patterns to fix:

    **Pattern A — `settings.label_to_imbox` and `settings.label_to_person` (simple string values):**

    These were convenience properties returning label strings. Replace with hardcoded strings (simpler for human tests, no functional change):

    - `test_3_label.py` line 26: `settings.label_to_imbox` → `"@ToImbox"`
    - `test_11_person_contact.py` line 226: `settings.label_to_person` → `"@ToPerson"`
    - `test_12_company_contact.py` line 245: `settings.label_to_imbox` → `"@ToImbox"`

    **Pattern B — `settings.label_to_group_mapping.values()` mailbox list (6 files):**

    The old `label_to_group_mapping` returned `dict[str, dict]` with `["destination_mailbox"]` keys. The new `label_to_category_mapping` returns `dict[str, ResolvedCategory]` with `.destination_mailbox` attribute access.

    In each file, find:
    ```python
    *[m["destination_mailbox"] for m in settings.label_to_group_mapping.values()],
    ```

    Replace with:
    ```python
    *[c.destination_mailbox for c in settings.label_to_category_mapping.values()],
    ```

    Files: test_7 (line 75), test_8 (line 84), test_9 (line 83), test_10 (line 82), test_11 (line 80), test_12 (line 80).

    **Pattern C — `settings.label_to_group_mapping[label]["group"]` (1 file):**

    - `test_9_already_grouped.py` line 133: `settings.label_to_group_mapping[test_label]["group"]` → `settings.label_to_category_mapping[test_label].contact_group`

    **Verification after all edits:** Run `grep -rn 'label_to_group_mapping\|label_to_imbox\|label_to_person' human-tests/` — must return ZERO matches (ignore __pycache__).

    IMPORTANT: Do NOT change any other test logic. Only the settings attribute access syntax changes. Same mailboxes, same workflow, same assertions.
  </action>
  <verify>
    <automated>grep -rn 'label_to_group_mapping\|label_to_imbox\|label_to_person' human-tests/ --include='*.py' | grep -v __pycache__ | wc -l | tr -d ' ' | grep -q '^0$' && echo "PASS: no stale references" || echo "FAIL: stale references remain"</automated>
  </verify>
  <done>All 7 human test files use label_to_category_mapping (or hardcoded label strings). Zero grep matches for deleted attributes. No other test logic changed.</done>
</task>

<task type="auto">
  <name>Task 2: Sync deployment artifacts to current config schema</name>
  <files>
    .env.example
    k8s/configmap.yaml
  </files>
  <action>
    **Update `.env.example`:**

    Remove the 9 deleted individual label/group env vars (MAILROOM_LABEL_TO_IMBOX, MAILROOM_LABEL_TO_FEED, MAILROOM_LABEL_TO_PAPER_TRAIL, MAILROOM_LABEL_TO_JAIL, MAILROOM_LABEL_TO_PERSON, MAILROOM_GROUP_IMBOX, MAILROOM_GROUP_FEED, MAILROOM_GROUP_PAPER_TRAIL, MAILROOM_GROUP_JAIL). These were replaced by MAILROOM_TRIAGE_CATEGORIES in Phase 6.

    Update MAILROOM_POLL_INTERVAL default from 300 to 60 (Phase 8 made push primary, poll fallback).

    Add MAILROOM_DEBOUNCE_SECONDS=3 (new in Phase 8).

    Add MAILROOM_TRIAGE_CATEGORIES with a JSON example showing the default categories.

    Keep all still-valid vars: MAILROOM_LABEL_MAILROOM_ERROR, MAILROOM_LABEL_MAILROOM_WARNING, MAILROOM_WARNINGS_ENABLED, MAILROOM_SCREENER_MAILBOX, MAILROOM_LOG_LEVEL, and auth vars (MAILROOM_JMAP_HOST, MAILROOM_AUTH_TOKEN, MAILROOM_CARDDAV_URL).

    Group into sections with comments: Auth/Connection, Polling & Push, Triage Categories, Error Handling/Other.

    **Update `k8s/configmap.yaml`:**

    Remove the same 9 deleted vars. Update to match .env.example:
    ```yaml
    data:
      MAILROOM_POLL_INTERVAL: "60"
      MAILROOM_DEBOUNCE_SECONDS: "3"
      MAILROOM_LOG_LEVEL: "info"
      MAILROOM_LABEL_MAILROOM_ERROR: "@MailroomError"
      MAILROOM_LABEL_MAILROOM_WARNING: "@MailroomWarning"
      MAILROOM_WARNINGS_ENABLED: "true"
      MAILROOM_SCREENER_MAILBOX: "Screener"
      # MAILROOM_TRIAGE_CATEGORIES: '<JSON>'  # uncomment to override defaults
    ```

    Note: Auth vars (JMAP_HOST, AUTH_TOKEN, CARDDAV_URL) go in a Secret, not ConfigMap — keep them out if they are not currently there, or add a comment noting they belong in a Secret.

    **Parity check:** After editing both files, ensure every non-secret env var in .env.example has a corresponding entry in k8s/configmap.yaml and vice versa.
  </action>
  <verify>
    <automated>grep -c 'LABEL_TO_\|GROUP_IMBOX\|GROUP_FEED\|GROUP_PAPER_TRAIL\|GROUP_JAIL' .env.example k8s/configmap.yaml | grep -v ':0$' | wc -l | tr -d ' ' | grep -q '^0$' && echo "PASS: no stale vars" || echo "FAIL: stale vars remain"</automated>
  </verify>
  <done>.env.example shows MAILROOM_TRIAGE_CATEGORIES, DEBOUNCE_SECONDS, POLL_INTERVAL=60. k8s/configmap.yaml matches. No deleted vars in either file.</done>
</task>

<task type="auto">
  <name>Task 3: Remove dead session_capabilities code from JMAPClient</name>
  <files>
    src/mailroom/clients/jmap.py
    tests/test_jmap_client.py
  </files>
  <action>
    Remove the unused `session_capabilities` property and its backing field from JMAPClient. Three removal sites:

    1. **`src/mailroom/clients/jmap.py` line ~30:** Remove `self._session_capabilities: dict = {}` from `__init__`.

    2. **`src/mailroom/clients/jmap.py` lines ~42-44:** Remove the `session_capabilities` property:
       ```python
       @property
       def session_capabilities(self) -> dict:
           return self._session_capabilities
       ```

    3. **`src/mailroom/clients/jmap.py` line ~63:** Remove `self._session_capabilities = data.get("capabilities", {})` from `connect()`. Keep all other assignments in connect() intact (_api_url, _account_id, _download_url, _event_source_url are all actively used).

    4. **`tests/test_jmap_client.py` lines ~120-145:** Remove the two tests:
       - `test_connect_stores_capabilities`
       - `test_session_capabilities_empty_before_connect`

    **Post-removal verification:** Run `grep -rn 'session_capabilities\|_session_capabilities' src/ tests/` — must return ZERO matches.

    IMPORTANT: Do NOT touch any other code in jmap.py or its test file. Only the 3 source sites and 2 tests are removed.
  </action>
  <verify>
    <automated>grep -rn 'session_capabilities\|_session_capabilities' src/ tests/ | wc -l | tr -d ' ' | grep -q '^0$' && echo "PASS: dead code removed" || echo "FAIL: references remain" ; cd /Users/flo/Work/Private/Dev/Services/mailroom && python -m pytest tests/test_jmap_client.py -x -q 2>&1 | tail -3</automated>
  </verify>
  <done>session_capabilities property, _session_capabilities field, and both associated tests removed. Zero grep matches. Remaining JMAPClient tests pass.</done>
</task>

</tasks>

<verification>
1. `grep -rn 'label_to_group_mapping\|label_to_imbox\|label_to_person' human-tests/ --include='*.py'` → zero matches
2. `grep -c 'LABEL_TO_\|GROUP_IMBOX\|GROUP_FEED\|GROUP_PAPER_TRAIL\|GROUP_JAIL' .env.example k8s/configmap.yaml` → all `:0`
3. `grep -c 'TRIAGE_CATEGORIES\|DEBOUNCE_SECONDS' .env.example k8s/configmap.yaml` → all non-zero
4. `grep -rn 'session_capabilities\|_session_capabilities' src/ tests/` → zero matches
5. `python -m pytest tests/test_jmap_client.py -x -q` → passes
6. `python -m pytest tests/ -x -q` → full suite passes
</verification>

<success_criteria>
- Human tests 3, 7-12 have zero references to deleted settings attributes
- .env.example documents MAILROOM_TRIAGE_CATEGORIES, MAILROOM_DEBOUNCE_SECONDS, POLL_INTERVAL=60
- k8s/configmap.yaml matches .env.example (no stale vars, correct defaults)
- JMAPClient.session_capabilities property and all backing code removed
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-tech-debt-cleanup/09-01-SUMMARY.md`
</output>
