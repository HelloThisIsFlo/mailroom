---
phase: 09-tech-debt-cleanup
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mailroom/setup/colors.py
  - src/mailroom/setup/reporting.py
  - src/mailroom/setup/sieve_guidance.py
  - tests/test_colors.py
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "ANSI color helpers (constants + use_color + color functions) live in a single shared module, not duplicated across reporting.py and sieve_guidance.py"
    - "reporting.py and sieve_guidance.py import color helpers from the shared module instead of defining their own"
    - "All existing color-related tests in test_provisioner.py and test_sieve_guidance.py still pass"
  artifacts:
    - path: "src/mailroom/setup/colors.py"
      provides: "Shared ANSI color helpers"
      exports: ["GREEN", "YELLOW", "RED", "DIM", "RESET", "CYAN", "use_color", "color"]
    - path: "src/mailroom/setup/reporting.py"
      provides: "Setup reporting with colors imported from shared module"
      contains: "from mailroom.setup.colors import"
    - path: "src/mailroom/setup/sieve_guidance.py"
      provides: "Sieve guidance with colors imported from shared module"
      contains: "from mailroom.setup.colors import"
  key_links:
    - from: "src/mailroom/setup/reporting.py"
      to: "src/mailroom/setup/colors.py"
      via: "import statement"
      pattern: "from mailroom.setup.colors import"
    - from: "src/mailroom/setup/sieve_guidance.py"
      to: "src/mailroom/setup/colors.py"
      via: "import statement"
      pattern: "from mailroom.setup.colors import"
---

<objective>
Extract duplicated ANSI color helpers into a shared module used by both reporting.py and sieve_guidance.py.

Purpose: reporting.py and sieve_guidance.py each define identical ANSI color constants and helper functions (_GREEN, _YELLOW, _RED, _DIM, _RESET, _CYAN, _use_color(), _color()). This duplication was flagged in the v1.1 milestone audit. Extracting into a shared module eliminates the duplication and creates a single source of truth.

Output: New src/mailroom/setup/colors.py module; both consumers updated to import from it; smoke tests for the shared module.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09-tech-debt-cleanup/09-RESEARCH.md
@src/mailroom/setup/reporting.py
@src/mailroom/setup/sieve_guidance.py

<interfaces>
<!-- Current color helpers duplicated in both files -->

From src/mailroom/setup/reporting.py (lines 22-41):
```python
_GREEN = "\033[32m"
_YELLOW = "\033[33m"
_RED = "\033[31m"
_DIM = "\033[2m"
_RESET = "\033[0m"
_CYAN = "\033[36m"

def _use_color() -> bool:
    if os.environ.get("NO_COLOR"):
        return False
    return hasattr(sys.stdout, "isatty") and sys.stdout.isatty()

def _color(text: str, code: str) -> str:
    if not _use_color():
        return text
    return f"{code}{text}{_RESET}"
```

From src/mailroom/setup/sieve_guidance.py (lines 19-34):
Same _use_color() and _color() functions. Only defines _CYAN and _RESET constants (subset).

Existing tests import consumer modules, not color helpers directly:
- tests/test_provisioner.py line 292: tests `no_color_when_not_tty` via reporting module
- tests/test_sieve_guidance.py lines 179-230: tests color behavior via sieve_guidance module
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create shared colors module and update consumers</name>
  <files>
    src/mailroom/setup/colors.py
    src/mailroom/setup/reporting.py
    src/mailroom/setup/sieve_guidance.py
  </files>
  <action>
    **Step 1: Create `src/mailroom/setup/colors.py`**

    Create a new module with the color helpers extracted from reporting.py. Drop the leading underscore since these become a public module API:

    ```python
    """Shared ANSI color helpers for setup output."""

    import os
    import sys

    GREEN = "\033[32m"
    YELLOW = "\033[33m"
    RED = "\033[31m"
    DIM = "\033[2m"
    RESET = "\033[0m"
    CYAN = "\033[36m"


    def use_color() -> bool:
        """Return True if stdout supports ANSI color."""
        if os.environ.get("NO_COLOR"):
            return False
        return hasattr(sys.stdout, "isatty") and sys.stdout.isatty()


    def color(text: str, code: str) -> str:
        """Wrap text in ANSI color code if color is enabled."""
        if not use_color():
            return text
        return f"{code}{text}{RESET}"
    ```

    **Step 2: Update `src/mailroom/setup/reporting.py`**

    Remove the inline color constants (lines ~22-27: _GREEN, _YELLOW, _RED, _DIM, _RESET, _CYAN) and functions (lines ~29-41: _use_color, _color). Remove the `import os` and `import sys` if they are ONLY used by the color helpers (check first — they may be used elsewhere in reporting.py).

    Add import at top:
    ```python
    from mailroom.setup.colors import GREEN, YELLOW, RED, DIM, RESET, CYAN, use_color, color
    ```

    Then update all references in reporting.py from `_GREEN` to `GREEN`, `_YELLOW` to `YELLOW`, `_RED` to `RED`, `_DIM` to `DIM`, `_RESET` to `RESET`, `_CYAN` to `CYAN`, `_use_color()` to `use_color()`, `_color(` to `color(`.

    IMPORTANT: Search for ALL usages of these names in reporting.py before replacing. Make sure every `_color(` call becomes `color(` and every constant reference drops the underscore.

    **Step 3: Update `src/mailroom/setup/sieve_guidance.py`**

    Remove the inline color constants and functions (lines ~19-34). Remove `import os` and `import sys` if only used by color helpers.

    Add import at top:
    ```python
    from mailroom.setup.colors import CYAN, RESET, DIM, color, use_color
    ```

    (Only import what sieve_guidance.py actually uses — check which constants appear in the file.)

    Update all references: `_CYAN` to `CYAN`, `_RESET` to `RESET`, `_DIM` to `DIM`, `_color(` to `color(`, `_use_color()` to `use_color()`.

    **Anti-pattern to avoid:** Do NOT change any logic in reporting.py or sieve_guidance.py beyond the import swap. The color behavior must remain identical.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -c "from mailroom.setup.colors import GREEN, YELLOW, RED, DIM, RESET, CYAN, use_color, color; print('PASS: colors module imports')" && python -c "from mailroom.setup.reporting import format_report; print('PASS: reporting imports')" && python -c "from mailroom.setup.sieve_guidance import generate_sieve_guidance; print('PASS: sieve_guidance imports')" && python -m pytest tests/test_provisioner.py tests/test_sieve_guidance.py -x -q 2>&1 | tail -5</automated>
  </verify>
  <done>colors.py exists with all 6 constants and 2 functions. reporting.py and sieve_guidance.py import from colors.py. No inline color definitions remain in either consumer. All existing tests pass.</done>
</task>

<task type="auto">
  <name>Task 2: Add smoke tests for shared colors module</name>
  <files>
    tests/test_colors.py
  </files>
  <action>
    Create a small test file for the shared colors module. Keep it minimal — the consumer tests already exercise color behavior indirectly. This adds direct coverage for the shared module:

    **Tests to write:**

    1. `test_use_color_returns_false_when_no_color_env_set` — Set `NO_COLOR=1` env var, assert `use_color()` returns `False`.

    2. `test_use_color_returns_false_when_not_tty` — Ensure no `NO_COLOR` env var, mock `sys.stdout.isatty` to return `False`, assert `use_color()` returns `False`.

    3. `test_use_color_returns_true_when_tty` — Mock `sys.stdout.isatty` to return `True`, ensure no `NO_COLOR`, assert `use_color()` returns `True`.

    4. `test_color_wraps_text_when_color_enabled` — Monkeypatch `use_color` to return `True`, call `color("hello", GREEN)`, assert result is `f"{GREEN}hello{RESET}"`.

    5. `test_color_returns_plain_text_when_color_disabled` — Monkeypatch `use_color` to return `False`, call `color("hello", GREEN)`, assert result is `"hello"`.

    6. `test_all_constants_are_ansi_escape_sequences` — Assert each constant (GREEN, YELLOW, RED, DIM, RESET, CYAN) starts with `\033[`.

    Use pytest fixtures and monkeypatch. Follow the existing test style in the project.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -m pytest tests/test_colors.py -x -q -v 2>&1 | tail -10</automated>
  </verify>
  <done>tests/test_colors.py exists with 6 tests covering use_color(), color(), and constants. All pass.</done>
</task>

</tasks>

<verification>
1. `python -c "from mailroom.setup.colors import GREEN, YELLOW, RED, DIM, RESET, CYAN, use_color, color"` → no errors
2. `grep -n '_GREEN\|_YELLOW\|_RED\|_DIM\|_RESET\|_CYAN\|_use_color\|_color' src/mailroom/setup/reporting.py src/mailroom/setup/sieve_guidance.py` → zero matches (no underscore-prefixed color helpers remain)
3. `python -m pytest tests/test_colors.py tests/test_provisioner.py tests/test_sieve_guidance.py -x -q` → all pass
4. `python -m pytest tests/ -x -q` → full suite passes
</verification>

<success_criteria>
- src/mailroom/setup/colors.py exists and exports GREEN, YELLOW, RED, DIM, RESET, CYAN, use_color, color
- reporting.py imports from colors.py, has no inline color definitions
- sieve_guidance.py imports from colors.py, has no inline color definitions
- tests/test_colors.py has 6 passing tests
- All existing tests in test_provisioner.py and test_sieve_guidance.py still pass
- Full test suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/09-tech-debt-cleanup/09-02-SUMMARY.md`
</output>
