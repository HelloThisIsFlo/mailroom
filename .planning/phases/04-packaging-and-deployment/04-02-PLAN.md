---
phase: 04-packaging-and-deployment
plan: 02
type: execute
wave: 1
depends_on: []
files_modified:
  - k8s/namespace.yaml
  - k8s/configmap.yaml
  - k8s/secret.yaml.example
  - k8s/deployment.yaml
  - .github/workflows/build.yaml
  - .gitignore
autonomous: true
requirements:
  - DEPLOY-02
  - DEPLOY-03
  - DEPLOY-04
  - DEPLOY-05

must_haves:
  truths:
    - "kubectl apply -f k8s/ creates the mailroom namespace, configmap, and deployment"
    - "k8s Secret template has placeholder values -- actual credentials are NOT in git"
    - "ConfigMap keys match exact MAILROOM_ env var names that pydantic-settings expects"
    - "Deployment uses envFrom for both ConfigMap and Secret injection"
    - "Deployment has liveness and readiness probes hitting /healthz"
    - "Deployment has resource requests and limits (64Mi/128Mi, 100m CPU)"
    - "GitHub Actions workflow builds and pushes to ghcr.io on push to main"
    - "k8s/secret.yaml is in .gitignore to prevent accidental credential commits"
  artifacts:
    - path: "k8s/namespace.yaml"
      provides: "Dedicated mailroom namespace"
      contains: "namespace: mailroom"
    - path: "k8s/configmap.yaml"
      provides: "All MAILROOM_ config env vars"
      contains: "MAILROOM_POLL_INTERVAL"
    - path: "k8s/secret.yaml.example"
      provides: "Template with placeholder credential values"
      contains: "your-fastmail"
    - path: "k8s/deployment.yaml"
      provides: "1-replica Deployment with envFrom, probes, resources"
      contains: "envFrom"
    - path: ".github/workflows/build.yaml"
      provides: "CI workflow for Docker build + push to ghcr.io"
      contains: "ghcr.io"
    - path: ".gitignore"
      provides: "Prevents k8s/secret.yaml from being committed"
      contains: "k8s/secret.yaml"
  key_links:
    - from: "k8s/deployment.yaml"
      to: "k8s/configmap.yaml"
      via: "envFrom configMapRef"
      pattern: "configMapRef.*mailroom-config"
    - from: "k8s/deployment.yaml"
      to: "k8s/secret.yaml.example"
      via: "envFrom secretRef"
      pattern: "secretRef.*mailroom-secrets"
    - from: "k8s/deployment.yaml"
      to: "ghcr.io"
      via: "container image reference"
      pattern: "ghcr.io/.*/mailroom"
    - from: ".github/workflows/build.yaml"
      to: "Dockerfile"
      via: "docker/build-push-action builds the Dockerfile"
      pattern: "build-push-action"
---

<objective>
Create Kubernetes manifests and GitHub Actions CI for deploying Mailroom to a home cluster.

Purpose: Provide the complete k8s deployment package (namespace, configmap, secret template, deployment with probes and resources) and CI pipeline that builds and pushes Docker images to ghcr.io on every push to main.

Output: `k8s/` directory with 4 manifests, `.github/workflows/build.yaml`, updated `.gitignore`
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-packaging-and-deployment/04-RESEARCH.md

@src/mailroom/core/config.py
@.gitignore
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Kubernetes manifests for namespace, configmap, secret template, and deployment</name>
  <files>k8s/namespace.yaml, k8s/configmap.yaml, k8s/secret.yaml.example, k8s/deployment.yaml</files>
  <action>
Create the `k8s/` directory with four manifest files. All manifests use `namespace: mailroom`.

**k8s/namespace.yaml:**
```yaml
apiVersion: v1
kind: Namespace
metadata:
  name: mailroom
```

**k8s/configmap.yaml:**
ConfigMap named `mailroom-config` in namespace `mailroom`. Keys MUST be the exact uppercase env var names that pydantic-settings expects (ConfigMap keys become env vars verbatim via envFrom — no prefix or case transformation). Include ALL non-secret MAILROOM_ settings from config.py:
- `MAILROOM_POLL_INTERVAL: "300"`
- `MAILROOM_LOG_LEVEL: "info"`
- `MAILROOM_LABEL_TO_IMBOX: "@ToImbox"`
- `MAILROOM_LABEL_TO_FEED: "@ToFeed"`
- `MAILROOM_LABEL_TO_PAPER_TRAIL: "@ToPaperTrail"`
- `MAILROOM_LABEL_TO_JAIL: "@ToJail"`
- `MAILROOM_LABEL_TO_PERSON: "@ToPerson"`
- `MAILROOM_LABEL_MAILROOM_ERROR: "@MailroomError"`
- `MAILROOM_LABEL_MAILROOM_WARNING: "@MailroomWarning"`
- `MAILROOM_WARNINGS_ENABLED: "true"`
- `MAILROOM_SCREENER_MAILBOX: "Screener"`
- `MAILROOM_GROUP_IMBOX: "Imbox"`
- `MAILROOM_GROUP_FEED: "Feed"`
- `MAILROOM_GROUP_PAPER_TRAIL: "Paper Trail"`
- `MAILROOM_GROUP_JAIL: "Jail"`

**k8s/secret.yaml.example:**
Secret named `mailroom-secrets` in namespace `mailroom`. Use `stringData` (not `data`) for human-readable placeholders. Include comment header explaining the workflow: copy to `secret.yaml`, fill in values, apply, do NOT commit. Keys:
- `MAILROOM_JMAP_TOKEN: "your-fastmail-jmap-token-here"`
- `MAILROOM_CARDDAV_USERNAME: "your-fastmail-email@fastmail.com"`
- `MAILROOM_CARDDAV_PASSWORD: "your-fastmail-app-password-here"`

**k8s/deployment.yaml:**
Deployment named `mailroom` in namespace `mailroom`:
- `replicas: 1`
- `terminationGracePeriodSeconds: 60` (generous for SIGTERM handling)
- Container image: `ghcr.io/hellothisisflo/mailroom:latest` (user's GitHub username from pyproject.toml author)
- `envFrom:` with both `configMapRef: mailroom-config` and `secretRef: mailroom-secrets`
- Health port: containerPort 8080 named "health"
- `livenessProbe:` httpGet on /healthz port health, initialDelaySeconds 10, periodSeconds 30
- `readinessProbe:` httpGet on /healthz port health, initialDelaySeconds 5, periodSeconds 30
- Resources: requests 64Mi memory + 100m CPU, limits 128Mi memory + 100m CPU
- Selector and template labels: `app: mailroom`

NOTE: The image reference uses `hellothisisflo` based on the author email domain — if the GitHub username differs, the user will update it. Use this as a reasonable default.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -c "
import yaml, sys
for f in ['k8s/namespace.yaml', 'k8s/configmap.yaml', 'k8s/secret.yaml.example', 'k8s/deployment.yaml']:
    with open(f) as fh:
        doc = yaml.safe_load(fh)
        print(f'{f}: {doc[\"kind\"]} ok')
print('All manifests valid YAML')
" 2>&1 || echo "Install pyyaml or check manually: ls -la k8s/"</automated>
    <manual>Verify ConfigMap keys match MailroomSettings field names with MAILROOM_ prefix, secret.yaml.example has placeholder values only</manual>
  </verify>
  <done>k8s/ directory contains 4 valid YAML manifests: namespace, configmap with all MAILROOM_ vars, secret template with placeholders, deployment with envFrom + probes + resources</done>
</task>

<task type="auto">
  <name>Task 2: Create GitHub Actions CI workflow and update .gitignore</name>
  <files>.github/workflows/build.yaml, .gitignore</files>
  <action>
**`.github/workflows/build.yaml`** — GitHub Actions workflow for Docker build + push:

```yaml
name: Build and push Docker image

on:
  push:
    branches: [main]

env:
  REGISTRY: ghcr.io
  IMAGE_NAME: ${{ github.repository }}

jobs:
  build-and-push:
    runs-on: ubuntu-latest
    permissions:
      contents: read
      packages: write
    steps:
      - uses: actions/checkout@v4

      - name: Log in to GHCR
        uses: docker/login-action@v3
        with:
          registry: ${{ env.REGISTRY }}
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract metadata
        id: meta
        uses: docker/metadata-action@v5
        with:
          images: ${{ env.REGISTRY }}/${{ env.IMAGE_NAME }}
          tags: |
            type=sha
            type=raw,value=latest,enable={{is_default_branch}}

      - name: Build and push
        uses: docker/build-push-action@v6
        with:
          context: .
          push: true
          tags: ${{ steps.meta.outputs.tags }}
          labels: ${{ steps.meta.outputs.labels }}
          cache-from: type=gha
          cache-to: type=gha,mode=max
```

Image tagging strategy (Claude's discretion): SHA + latest. SHA provides commit traceability, latest provides convenience. No semver for a personal service.

**`.gitignore`** — Append these entries to the EXISTING .gitignore file (do NOT overwrite existing content):
```
# Kubernetes secrets (never commit real credentials)
k8s/secret.yaml
```

Read the current .gitignore first and append the new entries at the bottom.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && test -f .github/workflows/build.yaml && grep -q "ghcr.io" .github/workflows/build.yaml && grep -q "k8s/secret.yaml" .gitignore && echo "CI workflow and gitignore OK"</automated>
    <manual>Verify GitHub Actions workflow triggers on push to main, uses docker/build-push-action v6, pushes to ghcr.io</manual>
  </verify>
  <done>.github/workflows/build.yaml builds and pushes to ghcr.io on push to main with SHA+latest tagging and GHA layer caching. .gitignore updated to exclude k8s/secret.yaml from commits.</done>
</task>

</tasks>

<verification>
1. All 4 k8s manifests are valid YAML
2. ConfigMap keys exactly match `MAILROOM_`-prefixed env var names from config.py
3. Secret template has placeholder values (not real credentials)
4. Deployment references ConfigMap and Secret via envFrom
5. Deployment has liveness and readiness probes on /healthz
6. Deployment has resource requests (64Mi, 100m) and limits (128Mi, 100m)
7. GitHub Actions workflow triggers on push to main and pushes to ghcr.io
8. .gitignore includes k8s/secret.yaml
</verification>

<success_criteria>
- `kubectl apply -f k8s/` would create namespace, configmap, and deployment (Secret applied separately from real file)
- No real credentials anywhere in the repository
- GitHub Actions workflow is ready to build and push on first push to main
- All configuration values match what MailroomSettings expects via pydantic-settings env var loading
</success_criteria>

<output>
After completion, create `.planning/phases/04-packaging-and-deployment/04-02-SUMMARY.md`
</output>
