---
phase: 09.1.1-helm-chart-migration-with-podsecurity-hardening
plan: 01
subsystem: infra
tags: [helm, kubernetes, pod-security-standards, deployment]

# Dependency graph
requires:
  - phase: 09.1-migrate-from-env-var-config-to-config-yaml
    provides: config.yaml-based configuration and MAILROOM_CONFIG env var
provides:
  - Complete Helm chart at helm/mailroom/ with 10 files
  - PSS restricted-level securityContext (shared _helpers.tpl templates)
  - Setup Job as pre-install/pre-upgrade Helm hook with dry-run default
  - secrets-values.yaml pattern for credential injection
affects: [09.1.1-02]

# Tech tracking
tech-stack:
  added: [helm-chart]
  patterns: [helm-hooks, pod-security-standards-restricted, secrets-values-file]

key-files:
  created:
    - helm/mailroom/Chart.yaml
    - helm/mailroom/values.yaml
    - helm/mailroom/secrets-values.yaml.example
    - helm/mailroom/templates/_helpers.tpl
    - helm/mailroom/templates/namespace.yaml
    - helm/mailroom/templates/configmap.yaml
    - helm/mailroom/templates/secret.yaml
    - helm/mailroom/templates/deployment.yaml
    - helm/mailroom/templates/setup-job.yaml
    - helm/mailroom/templates/NOTES.txt
  modified: []

key-decisions:
  - "Config.yaml content inline in values.yaml under config: key, rendered via toYaml in ConfigMap template"
  - "MAILROOM_CONFIG=/app/config.yaml set explicitly as env var (Dockerfile runtime has no WORKDIR)"
  - "Shared _helpers.tpl securityContext templates ensure Deployment and Job have identical PSS compliance"

patterns-established:
  - "Helm hook pattern: pre-install/pre-upgrade Job for setup preflight with dry-run default"
  - "PSS restricted: runAsNonRoot + drop ALL + readOnlyRootFilesystem + seccompProfile RuntimeDefault"
  - "secrets-values.yaml pattern: gitignored values file for credentials, example committed for onboarding"

requirements-completed: []

# Metrics
duration: 2min
completed: 2026-03-01
---

# Phase 09.1.1 Plan 01: Helm Chart Creation Summary

**Complete Helm chart with restricted PSS securityContext, inline config via toYaml, and setup Job as pre-install/pre-upgrade hook with dry-run default**

## Performance

- **Duration:** 2 min
- **Started:** 2026-03-01T21:10:35Z
- **Completed:** 2026-03-01T21:12:25Z
- **Tasks:** 2
- **Files created:** 10

## Accomplishments
- Created complete Helm chart at helm/mailroom/ with all templates, values, helpers, and examples
- All rendered resources pass restricted Pod Security Standards (runAsNonRoot, drop ALL, readOnlyRootFilesystem, seccompProfile)
- Setup Job as Helm pre-install/pre-upgrade hook with dry-run default and --apply override
- Config.yaml content inline in values.yaml, rendered into ConfigMap via toYaml

## Task Commits

Each task was committed atomically:

1. **Task 1: Create chart scaffolding** - `b48bba9` (feat)
2. **Task 2: Create all Kubernetes resource templates and NOTES.txt** - `01d7f52` (feat)

## Files Created/Modified
- `helm/mailroom/Chart.yaml` - Chart metadata (apiVersion v2, version 0.1.0, appVersion 1.1.0)
- `helm/mailroom/values.yaml` - Default values with inline config, resource defaults, setup toggle, empty secret placeholders
- `helm/mailroom/secrets-values.yaml.example` - Onboarding placeholder for secrets with usage instructions
- `helm/mailroom/templates/_helpers.tpl` - 7 named templates: name, fullname, chart, labels, selectorLabels, podSecurityContext, containerSecurityContext
- `helm/mailroom/templates/namespace.yaml` - Namespace with all 6 PSS enforce/warn/audit labels
- `helm/mailroom/templates/configmap.yaml` - ConfigMap rendering config.yaml from values via toYaml
- `helm/mailroom/templates/secret.yaml` - Secret with MAILROOM_ env vars from secrets-values via stringData
- `helm/mailroom/templates/deployment.yaml` - Deployment with PSS securityContext, probes, config mount, /tmp emptyDir, MAILROOM_CONFIG env
- `helm/mailroom/templates/setup-job.yaml` - Pre-install/pre-upgrade hook Job with backoffLimit 0 and conditional --apply arg
- `helm/mailroom/templates/NOTES.txt` - Post-install usage instructions with conditional setup mode message

## Decisions Made
- Config.yaml content inline in values.yaml under `config:` key, rendered via `toYaml` in ConfigMap template (best Helm convention -- single source of truth, --set overrides work)
- MAILROOM_CONFIG=/app/config.yaml set explicitly as env var in both Deployment and Job (Dockerfile runtime stage has no WORKDIR, per research pitfall 6)
- Shared _helpers.tpl securityContext templates ensure Deployment and Job have identical PSS compliance (DRY, consistent)

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered

None.

## User Setup Required

None - no external service configuration required.

## Next Phase Readiness
- Helm chart complete and passes `helm lint` with no errors
- Ready for Plan 02: .gitignore update, k8s/ directory deletion, and migration cleanup
- Chart can be installed with: `helm install mailroom helm/mailroom/ -n mailroom -f secrets-values.yaml`

## Self-Check: PASSED

All 10 files verified present. Both task commits (b48bba9, 01d7f52) verified in git log.

---
*Phase: 09.1.1-helm-chart-migration-with-podsecurity-hardening*
*Completed: 2026-03-01*
