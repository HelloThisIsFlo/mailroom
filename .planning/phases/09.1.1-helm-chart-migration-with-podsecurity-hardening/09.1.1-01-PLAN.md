---
phase: 09.1.1-helm-chart-migration-with-podsecurity-hardening
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - helm/mailroom/Chart.yaml
  - helm/mailroom/values.yaml
  - helm/mailroom/secrets-values.yaml.example
  - helm/mailroom/templates/_helpers.tpl
  - helm/mailroom/templates/namespace.yaml
  - helm/mailroom/templates/configmap.yaml
  - helm/mailroom/templates/secret.yaml
  - helm/mailroom/templates/deployment.yaml
  - helm/mailroom/templates/setup-job.yaml
  - helm/mailroom/templates/NOTES.txt
autonomous: true
requirements: []

must_haves:
  truths:
    - "Helm chart exists at helm/mailroom/ with valid Chart.yaml and values.yaml"
    - "helm lint passes on the chart with no errors"
    - "helm template renders all 5 resources (namespace, configmap, secret, deployment, job) with correct content"
    - "All rendered resources pass restricted Pod Security Standards (runAsNonRoot, drop ALL, readOnlyRootFilesystem, seccompProfile)"
    - "Setup Job runs mailroom setup in dry-run by default and --apply when setup.apply=true"
    - "Config.yaml content is inline in values.yaml and rendered into ConfigMap via toYaml"
    - "Secrets are parameterized via secrets-values.yaml pattern, not committed in values.yaml"
  artifacts:
    - path: "helm/mailroom/Chart.yaml"
      provides: "Chart metadata"
    - path: "helm/mailroom/values.yaml"
      provides: "Default values with config inline, resource defaults, setup toggle"
    - path: "helm/mailroom/secrets-values.yaml.example"
      provides: "Onboarding placeholder for secrets"
    - path: "helm/mailroom/templates/_helpers.tpl"
      provides: "Shared named templates for fullname, labels, securityContext"
    - path: "helm/mailroom/templates/namespace.yaml"
      provides: "Namespace with PSS enforce/warn/audit labels"
    - path: "helm/mailroom/templates/configmap.yaml"
      provides: "ConfigMap rendering config.yaml from values"
    - path: "helm/mailroom/templates/secret.yaml"
      provides: "Secret with MAILROOM_ env vars from secrets-values"
    - path: "helm/mailroom/templates/deployment.yaml"
      provides: "Deployment with PSS securityContext, probes, config mount, /tmp emptyDir"
    - path: "helm/mailroom/templates/setup-job.yaml"
      provides: "Pre-install/pre-upgrade hook Job for mailroom setup"
    - path: "helm/mailroom/templates/NOTES.txt"
      provides: "Post-install usage instructions"
  key_links:
    - from: "helm/mailroom/templates/deployment.yaml"
      to: "helm/mailroom/templates/_helpers.tpl"
      via: "include mailroom.podSecurityContext / mailroom.containerSecurityContext"
      pattern: "include.*mailroom\\.podSecurityContext"
    - from: "helm/mailroom/templates/setup-job.yaml"
      to: "helm/mailroom/templates/_helpers.tpl"
      via: "Same shared securityContext templates as deployment"
      pattern: "include.*mailroom\\.containerSecurityContext"
    - from: "helm/mailroom/templates/configmap.yaml"
      to: "helm/mailroom/values.yaml"
      via: "toYaml .Values.config renders config.yaml content"
      pattern: "toYaml .Values.config"
    - from: "helm/mailroom/templates/deployment.yaml"
      to: "helm/mailroom/templates/configmap.yaml"
      via: "Volume mount config at /app/config.yaml with subPath"
      pattern: "mountPath.*config.yaml"
---

<objective>
Create the complete Helm chart at `helm/mailroom/` with all templates, values, and helpers.

Purpose: Replace the plain `k8s/` manifests with a proper Helm chart that adds PodSecurity Standards (restricted level) hardening and a setup Job preflight check pattern.

Output: A fully functional Helm chart that can be installed with `helm install mailroom helm/mailroom/ -n mailroom -f secrets-values.yaml`.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1.1-helm-chart-migration-with-podsecurity-hardening/09.1.1-CONTEXT.md
@.planning/phases/09.1.1-helm-chart-migration-with-podsecurity-hardening/09.1.1-RESEARCH.md

# Existing manifests to translate
@k8s/deployment.yaml
@k8s/configmap.yaml
@k8s/namespace.yaml
@k8s/secret.yaml.example

# Current config
@config.yaml.example
@Dockerfile
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create chart scaffolding (Chart.yaml, values.yaml, _helpers.tpl, secrets-values.yaml.example)</name>
  <files>
    helm/mailroom/Chart.yaml,
    helm/mailroom/values.yaml,
    helm/mailroom/secrets-values.yaml.example,
    helm/mailroom/templates/_helpers.tpl
  </files>
  <action>
Create `helm/mailroom/` directory structure.

**Chart.yaml:**
- `apiVersion: v2` (Helm 3)
- `name: mailroom`
- `description: Email triage automation for Fastmail`
- `type: application`
- `version: 0.1.0` (chart version)
- `appVersion: "1.1.0"` (matches v1.1 milestone)

**values.yaml** (minimal parameterization per user decision):
- `image.repository`: `ghcr.io/hellothisisflo/mailroom`
- `image.tag`: `latest`
- `image.pullPolicy`: `Always`
- `replicaCount`: `1`
- `resources`: requests 64Mi/100m, limits 128Mi/100m (from existing deployment.yaml)
- `setup.apply`: `false` (dry-run by default)
- `config:` block: Embed the FULL config.yaml content inline (copy structure from existing `k8s/configmap.yaml` data section). This is the config that becomes the ConfigMap. Use the default 5 categories (Imbox, Feed, Paper Trail, Jail, Person) -- NOT the user's personal config.yaml which has extra categories.
- `secrets:` block with empty strings for `jmap_token`, `carddav_username`, `carddav_password` (placeholders only -- real values come from secrets-values.yaml)

**secrets-values.yaml.example:**
- Mirror the pattern from `k8s/secret.yaml.example`
- Contains `secrets.jmap_token`, `secrets.carddav_username`, `secrets.carddav_password` with placeholder values
- Header comments explaining usage: copy to `secrets-values.yaml`, fill in real credentials, pass with `helm install -f secrets-values.yaml`

**templates/_helpers.tpl:**
- `mailroom.name`: defaults to Chart.Name
- `mailroom.fullname`: standard Release.Name + Chart.Name pattern
- `mailroom.chart`: chart name + version label
- `mailroom.labels`: common labels (chart, selectorLabels, version, managed-by)
- `mailroom.selectorLabels`: app name + instance
- `mailroom.podSecurityContext`: `runAsNonRoot: true`, `seccompProfile: { type: RuntimeDefault }`
- `mailroom.containerSecurityContext`: `runAsNonRoot: true`, `allowPrivilegeEscalation: false`, `readOnlyRootFilesystem: true`, `seccompProfile: { type: RuntimeDefault }`, `capabilities: { drop: [ALL] }`

Use the complete code examples from RESEARCH.md as the starting point. These are well-researched and correct.
  </action>
  <verify>
    <automated>ls helm/mailroom/Chart.yaml helm/mailroom/values.yaml helm/mailroom/secrets-values.yaml.example helm/mailroom/templates/_helpers.tpl && echo "All scaffolding files exist"</automated>
  </verify>
  <done>
    - Chart.yaml has apiVersion v2, name mailroom, version 0.1.0
    - values.yaml has image, replicaCount, resources, setup, config (inline), secrets (empty placeholders) sections
    - secrets-values.yaml.example has placeholder credentials with usage instructions
    - _helpers.tpl has 7 named templates including both securityContext helpers
  </done>
</task>

<task type="auto">
  <name>Task 2: Create all Kubernetes resource templates and NOTES.txt</name>
  <files>
    helm/mailroom/templates/namespace.yaml,
    helm/mailroom/templates/configmap.yaml,
    helm/mailroom/templates/secret.yaml,
    helm/mailroom/templates/deployment.yaml,
    helm/mailroom/templates/setup-job.yaml,
    helm/mailroom/templates/NOTES.txt
  </files>
  <action>
Create all 5 resource templates and the NOTES.txt post-install message.

**templates/namespace.yaml:**
- Standard namespace resource using `{{ .Release.Namespace }}`
- Labels: `{{ include "mailroom.labels" . }}`
- **Pod Security Standards labels (all 3 modes, restricted level):**
  - `pod-security.kubernetes.io/enforce: restricted`
  - `pod-security.kubernetes.io/enforce-version: latest`
  - `pod-security.kubernetes.io/warn: restricted`
  - `pod-security.kubernetes.io/warn-version: latest`
  - `pod-security.kubernetes.io/audit: restricted`
  - `pod-security.kubernetes.io/audit-version: latest`

**templates/configmap.yaml:**
- Name: `{{ include "mailroom.fullname" . }}-config`
- Data: `config.yaml: |` followed by `{{ toYaml .Values.config | nindent 4 }}`
- This renders the inline config from values.yaml as the config.yaml file content

**templates/secret.yaml:**
- Name: `{{ include "mailroom.fullname" . }}-secrets`
- Type: Opaque
- Uses `stringData` (not `data`) for readability
- Maps `secrets.jmap_token` -> `MAILROOM_JMAP_TOKEN`, `secrets.carddav_username` -> `MAILROOM_CARDDAV_USERNAME`, `secrets.carddav_password` -> `MAILROOM_CARDDAV_PASSWORD`
- Quote values with `{{ .Values.secrets.jmap_token | quote }}`

**templates/deployment.yaml:**
Translate from existing `k8s/deployment.yaml`, adding:
- `replicas: {{ .Values.replicaCount }}`
- `image: "{{ .Values.image.repository }}:{{ .Values.image.tag }}"` + `imagePullPolicy: {{ .Values.image.pullPolicy }}`
- `terminationGracePeriodSeconds: 60` (from existing)
- Port 8080 named `health`
- `envFrom` referencing `{{ include "mailroom.fullname" . }}-secrets`
- **Add** `env` section with `MAILROOM_CONFIG=/app/config.yaml` (explicit path, per RESEARCH.md pitfall 6 -- Dockerfile runtime stage has no WORKDIR)
- Existing liveness/readiness probes (httpGet /healthz, port health, initialDelaySeconds, periodSeconds)
- `resources: {{ toYaml .Values.resources | nindent 12 }}`
- **Pod-level securityContext:** `{{ include "mailroom.podSecurityContext" . | nindent 8 }}`
- **Container-level securityContext:** `{{ include "mailroom.containerSecurityContext" . | nindent 12 }}`
- **Volume mounts:**
  1. `config` at `/app/config.yaml` with `subPath: config.yaml`, `readOnly: true` (from existing)
  2. `tmp` at `/tmp` (emptyDir for readOnlyRootFilesystem -- Python needs writable /tmp)
- **Volumes:**
  1. `config` from configMap `{{ include "mailroom.fullname" . }}-config`
  2. `tmp` as `emptyDir: {}`
- Labels/selectors use `{{ include "mailroom.selectorLabels" . }}`
- Metadata labels use `{{ include "mailroom.labels" . }}`

**templates/setup-job.yaml:**
- Kind: Job
- Annotations for Helm hooks:
  - `helm.sh/hook: pre-install,pre-upgrade`
  - `helm.sh/hook-weight: "-5"`
  - `helm.sh/hook-delete-policy: before-hook-creation,hook-succeeded`
- `backoffLimit: 0` (fail fast, no retries)
- `restartPolicy: Never`
- Same image, same securityContext (both pod and container level via shared _helpers.tpl templates)
- `command: ["mailroom", "setup"]`
- Conditional args: `{{- if .Values.setup.apply }}` -> `args: ["--apply"]`
- Same env (MAILROOM_CONFIG), envFrom (secrets), volumeMounts (config + tmp), volumes as deployment
- Resources from values (same as deployment)

**templates/NOTES.txt:**
- Post-install message showing:
  - What namespace mailroom was deployed to
  - Whether setup ran in dry-run or apply mode (conditional on `.Values.setup.apply`)
  - If dry-run: instructions to re-deploy with `--set setup.apply=true` if it failed
  - Status check commands: `kubectl get pods -n {{ .Release.Namespace }}` and `kubectl logs`
  </action>
  <verify>
    <automated>ls helm/mailroom/templates/namespace.yaml helm/mailroom/templates/configmap.yaml helm/mailroom/templates/secret.yaml helm/mailroom/templates/deployment.yaml helm/mailroom/templates/setup-job.yaml helm/mailroom/templates/NOTES.txt && echo "All templates exist"</automated>
  </verify>
  <done>
    - namespace.yaml has all 6 PSS labels (enforce/warn/audit, each with version)
    - configmap.yaml renders config.yaml from .Values.config via toYaml
    - secret.yaml maps 3 secret values to MAILROOM_ env vars using stringData
    - deployment.yaml has PSS securityContext (both pod and container), config volume mount, /tmp emptyDir, MAILROOM_CONFIG env var, liveness/readiness probes
    - setup-job.yaml has pre-install/pre-upgrade hook annotations, backoffLimit 0, conditional --apply arg, same securityContext as deployment
    - NOTES.txt shows conditional setup mode message and status check commands
  </done>
</task>

</tasks>

<verification>
1. All 10 files exist in helm/mailroom/ with correct structure
2. `helm lint helm/mailroom/` passes with no errors
3. `helm template mailroom helm/mailroom/ --set secrets.jmap_token=test --set secrets.carddav_username=test --set secrets.carddav_password=test` renders all resources correctly
4. Rendered deployment and job both have identical restricted PSS securityContext
5. Rendered namespace has all 6 PSS labels
6. Rendered configmap contains valid config.yaml content
7. Setup job has pre-install,pre-upgrade hook annotations
</verification>

<success_criteria>
- Helm chart at helm/mailroom/ is complete and passes `helm lint`
- `helm template` renders namespace, configmap, secret, deployment, and setup job with correct content
- All pods have restricted-level PSS compliance (runAsNonRoot, drop ALL, readOnlyRootFilesystem, seccompProfile)
- Setup job is a pre-install/pre-upgrade hook with dry-run default and --apply override
- Config is inline in values.yaml, secrets are parameterized via secrets-values.yaml pattern
</success_criteria>

<output>
After completion, create `.planning/phases/09.1.1-helm-chart-migration-with-podsecurity-hardening/09.1.1-01-SUMMARY.md`
</output>
