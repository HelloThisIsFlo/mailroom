---
phase: 09.1.1-helm-chart-migration-with-podsecurity-hardening
plan: 02
type: execute
wave: 2
depends_on: ["09.1.1-01"]
files_modified:
  - .gitignore
autonomous: false
requirements: []

must_haves:
  truths:
    - "k8s/ directory no longer exists in the repository"
    - ".gitignore references helm/mailroom/secrets-values.yaml instead of k8s/secret.yaml"
    - "helm lint passes cleanly"
    - "helm template renders all resources with correct values"
    - "User has visually verified the rendered output looks correct"
  artifacts:
    - path: ".gitignore"
      provides: "Updated gitignore with helm secrets path"
      contains: "helm/mailroom/secrets-values.yaml"
  key_links:
    - from: ".gitignore"
      to: "helm/mailroom/secrets-values.yaml"
      via: "Gitignore entry prevents accidental secret commit"
      pattern: "helm/mailroom/secrets-values.yaml"
---

<objective>
Delete the old `k8s/` directory, update `.gitignore` for the new secrets path, and validate the Helm chart renders correctly.

Purpose: Complete the migration from plain manifests to Helm chart. The old `k8s/` directory is replaced, and the chart is verified to produce correct output.

Output: Clean repository with only the Helm chart as the deployment method, validated via helm lint and helm template.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1.1-helm-chart-migration-with-podsecurity-hardening/09.1.1-CONTEXT.md
@.planning/phases/09.1.1-helm-chart-migration-with-podsecurity-hardening/09.1.1-01-SUMMARY.md

# Chart created in Plan 01
@helm/mailroom/Chart.yaml
@helm/mailroom/values.yaml
</context>

<tasks>

<task type="auto">
  <name>Task 1: Delete k8s/ directory and update .gitignore</name>
  <files>.gitignore</files>
  <action>
**Delete `k8s/` directory entirely:**
- `git rm -r k8s/` to remove all tracked files (namespace.yaml, deployment.yaml, configmap.yaml, secret.yaml.example)
- Note: `k8s/secret.yaml` is gitignored so it may need a manual `rm` if present

**Update `.gitignore`:**
- Remove the line `k8s/secret.yaml` (directory no longer exists)
- Add `helm/mailroom/secrets-values.yaml` (the new secrets file that users create from the .example)
- Keep all other entries unchanged

The `.gitignore` should look like:
```
# Environment
.env
human-tests/.env

# Python
__pycache__/
*.pyc
.venv/

# Tools
.ruff_cache/
.pytest_cache/

# Claude Code
.claude/settings.local.json

# Helm secrets (never commit real credentials)
helm/mailroom/secrets-values.yaml

.DS_Store
```
  </action>
  <verify>
    <automated>test ! -d k8s/ && grep -q "helm/mailroom/secrets-values.yaml" .gitignore && ! grep -q "k8s/secret.yaml" .gitignore && echo "Migration cleanup complete"</automated>
  </verify>
  <done>
    - k8s/ directory is completely removed from the repository
    - .gitignore no longer references k8s/secret.yaml
    - .gitignore includes helm/mailroom/secrets-values.yaml
  </done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Helm chart renders correctly</name>
  <files>helm/mailroom/</files>
  <action>
Human verifies the complete Helm chart output. What was built:
- Complete Helm chart at helm/mailroom/ replacing the old k8s/ plain manifests
- Namespace with Pod Security Standards (restricted) enforcement labels
- ConfigMap with config.yaml rendered from values.yaml
- Secret for auth credentials via secrets-values.yaml
- Deployment with restricted PSS securityContext, /tmp emptyDir, MAILROOM_CONFIG env var
- Setup Job as pre-install/pre-upgrade hook (dry-run by default, --apply override)
- NOTES.txt with post-install instructions

Steps to verify:
1. Run `helm lint helm/mailroom/` -- should pass with no errors
2. Run `helm template mailroom helm/mailroom/ -n mailroom --set secrets.jmap_token=test --set secrets.carddav_username=test --set secrets.carddav_password=test` and verify:
   - Namespace has all 6 PSS labels (enforce/warn/audit x restricted)
   - ConfigMap has valid config.yaml content
   - Secret has MAILROOM_JMAP_TOKEN, MAILROOM_CARDDAV_USERNAME, MAILROOM_CARDDAV_PASSWORD
   - Deployment has securityContext with runAsNonRoot, drop ALL, readOnlyRootFilesystem, /tmp emptyDir mount
   - Job has pre-install/pre-upgrade hook annotations, backoffLimit 0, same securityContext
3. Verify `k8s/` directory is gone: `ls k8s/` should fail
4. Verify `.gitignore` has `helm/mailroom/secrets-values.yaml` and NOT `k8s/secret.yaml`
5. Review `helm/mailroom/secrets-values.yaml.example` -- has placeholder values matching old secret.yaml.example pattern
  </action>
  <verify>
    <automated>helm lint helm/mailroom/ && helm template mailroom helm/mailroom/ -n mailroom --set secrets.jmap_token=test --set secrets.carddav_username=test --set secrets.carddav_password=test > /dev/null && echo "Chart validates successfully"</automated>
  </verify>
  <done>User has reviewed helm template output and approved the chart structure, PSS compliance, and setup hook behavior</done>
</task>

</tasks>

<verification>
1. `k8s/` directory does not exist
2. `.gitignore` references `helm/mailroom/secrets-values.yaml` (not `k8s/secret.yaml`)
3. `helm lint helm/mailroom/` passes
4. `helm template` renders all 5 resources correctly
5. User has reviewed rendered output and approved
</verification>

<success_criteria>
- Old k8s/ manifests are deleted from the repository
- .gitignore is updated for new secrets path
- helm lint passes with no errors
- helm template renders all resources with correct PSS securityContext, hooks, and config
- User has verified the chart output
</success_criteria>

<output>
After completion, create `.planning/phases/09.1.1-helm-chart-migration-with-podsecurity-hardening/09.1.1-02-SUMMARY.md`
</output>
