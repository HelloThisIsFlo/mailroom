# Phase 09.1.1: Helm Chart Migration with PodSecurity Hardening - Context

**Gathered:** 2026-03-01
**Status:** Ready for planning

<domain>
## Phase Boundary

Convert the plain `k8s/` manifests (namespace, deployment, configmap, secret) into a Helm chart at `helm/mailroom/` and add Kubernetes Pod Security Standards (restricted level) hardening. Delete the old `k8s/` directory. The chart becomes the single deployment method.

</domain>

<decisions>
## Implementation Decisions

### Values & Secrets Split
- Secrets delivered via a gitignored `secrets-values.yaml` file, passed with `helm install -f secrets-values.yaml`
- A committed `secrets-values.yaml.example` with placeholder values for onboarding (mirrors current `k8s/secret.yaml.example` pattern)
- Minimal parameterization only: image tag, resource limits/requests, replica count — this is a single-user service, not a public chart
- No external-secrets operator or manual kubectl secret management

### PodSecurity Hardening
- **Restricted** Pod Security Standard — strictest Kubernetes level
- Namespace labels: `pod-security.kubernetes.io/enforce: restricted` (reject non-compliant pods at admission)
- Container securityContext: `runAsNonRoot: true`, `allowPrivilegeEscalation: false`, `capabilities: { drop: ["ALL"] }`, `seccompProfile: { type: RuntimeDefault }`
- `readOnlyRootFilesystem: true` with an emptyDir volume mounted at `/tmp` for Python temp files
- Pod-level: `runAsNonRoot: true`, `seccompProfile: { type: RuntimeDefault }`

### Setup Job (Preflight Check Pattern)
- Helm Job template included, triggered as a `pre-install` / `pre-upgrade` hook
- **Default behavior (dry-run):** Job runs `mailroom setup` in dry-run mode — checks if required Fastmail mailboxes and contact groups exist. If anything is missing, Job exits non-zero, Helm aborts, and the currently deployed version stays running
- **Apply override:** `--set setup.apply=true` runs setup in apply mode — provisions missing resources on Fastmail, then deployment proceeds
- This creates a deployment safety gate: you can't deploy a config that references resources that don't exist on Fastmail
- Two user recovery paths when dry-run fails: (1) fix config if the change was unintentional, or (2) re-run with `setup.apply=true` if the change was intentional
- Same PodSecurity hardening as the main deployment (same image, same securityContext)

### Migration Strategy
- Delete `k8s/` directory entirely (namespace.yaml, deployment.yaml, configmap.yaml, secret.yaml, secret.yaml.example)
- Helm chart at `helm/mailroom/` (standard convention for single chart in app repo)
- Update `.gitignore`: remove `k8s/secret.yaml`, add `helm/mailroom/secrets-values.yaml`
- Current deployment uses manual `kubectl apply` — switching to `helm install/upgrade`

### Claude's Discretion
- Config.yaml handling: inline in values.yaml vs separate file (pick what works best with Helm conventions)
- Chart.yaml metadata (version, appVersion, description)
- Template structure and helper naming
- NOTES.txt content (post-install instructions)

</decisions>

<specifics>
## Specific Ideas

- Setup Job as a preflight check is the key design insight — dry-run by default prevents config drift, apply override provisions intentionally
- Follow Helm best practices and conventions throughout — don't reference the existing todo as gospel
- The todo mentioned a reverted Job manifest experiment — Helm's conditional templates solve the verbosity problem that caused the revert

</specifics>

<code_context>
## Existing Code Insights

### Reusable Assets
- `Dockerfile`: Multi-stage build, already runs as non-root user `app`, exposes 8080 — compatible with restricted PSS
- `k8s/deployment.yaml`: Resource limits (64Mi/128Mi, 100m CPU), liveness/readiness probes, terminationGracePeriodSeconds — all transferable to Helm templates
- `k8s/configmap.yaml`: Full config.yaml content with triage categories — transfers to values.yaml
- `k8s/secret.yaml.example`: Documents the 3 required env vars (JMAP_TOKEN, CARDDAV_USERNAME, CARDDAV_PASSWORD)
- `mailroom setup` CLI command: Already exists for dry-run/apply provisioning

### Established Patterns
- Config mounted as a volume at `/app/config.yaml` via ConfigMap (subPath mount, readOnly)
- Secrets injected as env vars via `envFrom: secretRef` (flat MAILROOM_ prefix)
- Single replica, no HPA, no PDB — simple single-instance service
- Health endpoint at `/healthz` on port 8080

### Integration Points
- `.gitignore` needs updating for new secret paths
- `k8s/` directory deletion
- No CI/CD pipeline to update — manual deployment

</code_context>

<deferred>
## Deferred Ideas

- Cluster migration steps (delete old kubectl-managed resources, helm install) — operational todo, not in-repo artifact
- CI/CD pipeline for automated deployments — future consideration

</deferred>

---

*Phase: 09.1.1-helm-chart-migration-with-podsecurity-hardening*
*Context gathered: 2026-03-01*
