---
phase: 01-foundation-and-jmap-client
plan: 02
type: tdd
wave: 2
depends_on:
  - 01-01
files_modified:
  - src/mailroom/clients/jmap.py
  - tests/test_jmap_client.py
autonomous: true
requirements:
  - JMAP-01
  - JMAP-02

must_haves:
  truths:
    - "The JMAP client authenticates with Fastmail using a Bearer token and retrieves a valid session (account ID + API URL)"
    - "All configured mailbox names are resolved to Fastmail mailbox IDs at startup"
    - "Missing mailboxes cause a startup failure with a clear error listing what was not found"
    - "Inbox is resolved by role (not name) to avoid parent/child name collisions"
  artifacts:
    - path: "src/mailroom/clients/jmap.py"
      provides: "JMAPClient class with connect() and resolve_mailboxes() methods"
      exports: ["JMAPClient"]
      min_lines: 60
    - path: "tests/test_jmap_client.py"
      provides: "Tests for session discovery and mailbox resolution using mocked httpx"
      min_lines: 80
  key_links:
    - from: "src/mailroom/clients/jmap.py"
      to: "https://api.fastmail.com/jmap/session"
      via: "connect() GET request with Bearer token"
      pattern: "Authorization.*Bearer"
    - from: "src/mailroom/clients/jmap.py"
      to: "Mailbox/get JMAP method"
      via: "resolve_mailboxes() calls self.call() with Mailbox/get"
      pattern: "Mailbox/get"
    - from: "src/mailroom/core/config.py"
      to: "src/mailroom/clients/jmap.py"
      via: "jmap_token and triage_labels flow into JMAPClient constructor and resolve_mailboxes"
      pattern: "jmap_token"
---

<objective>
Build and test the JMAP client's authentication and mailbox resolution capabilities using TDD (RED-GREEN-REFACTOR).

Purpose: The JMAP session and mailbox ID map are prerequisites for every email operation. Getting this right -- including edge cases like role-based Inbox lookup and missing mailbox detection -- prevents cascading failures in Plans 03+.
Output: A tested JMAPClient class that can connect to Fastmail and resolve mailbox names to IDs.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-jmap-client/01-CONTEXT.md
@.planning/phases/01-foundation-and-jmap-client/01-RESEARCH.md
@.planning/phases/01-foundation-and-jmap-client/01-01-SUMMARY.md
</context>

<feature>
  <name>JMAP Session Discovery and Mailbox Resolution</name>
  <files>src/mailroom/clients/jmap.py, tests/test_jmap_client.py</files>
  <behavior>
    **Session Discovery (JMAP-01):**
    - Input: Bearer token string
    - Action: GET https://api.fastmail.com/jmap/session with Authorization header
    - Output: JMAPClient with account_id, api_url stored internally
    - Error: httpx.HTTPStatusError on 401 (bad token) or network failure

    Cases:
    - Valid token -> connect() succeeds, account_id and api_url populated
    - Invalid token -> connect() raises (401 from Fastmail)
    - Network error -> connect() raises

    **Mailbox Resolution (JMAP-02):**
    - Input: List of required mailbox names (from config triage_labels + "Screener" + "Inbox")
    - Action: Mailbox/get with ids:null to fetch all mailboxes, match by name (or role for Inbox)
    - Output: dict[str, str] mapping name -> mailbox_id
    - Error: ValueError listing missing mailboxes if any required name not found

    Cases:
    - All mailboxes exist -> returns complete name-to-id map
    - Inbox resolved by role="inbox" (not by name) to avoid parent/child collisions
    - Missing mailbox -> raises ValueError with missing names listed
    - Duplicate names at different levels -> top-level (parentId=null) preferred for custom mailboxes
  </behavior>
  <implementation>
    Create `src/mailroom/clients/jmap.py` with:

    ```python
    class JMAPClient:
        def __init__(self, token: str, hostname: str = "api.fastmail.com"):
            # Store token, create httpx.Client with Bearer auth header
            # Session state: _api_url, _account_id (set by connect())

        @property
        def account_id(self) -> str:
            # Return _account_id, raise if not connected

        def connect(self) -> None:
            # GET /jmap/session, extract primaryAccounts["urn:ietf:params:jmap:mail"] and apiUrl

        def call(self, method_calls: list) -> list:
            # POST to api_url with JMAP request envelope, return methodResponses

        def resolve_mailboxes(self, required_names: list[str]) -> dict[str, str]:
            # Mailbox/get ids:null, build name->id map
            # Inbox: match by role="inbox" instead of name
            # Custom mailboxes: match by name, prefer parentId=null for ambiguity
            # Validate all required names found, raise ValueError for missing
    ```

    Use `pytest-httpx` to mock all HTTP calls in tests. No live Fastmail calls.

    **Pitfall awareness (from research):**
    - Session URL (/jmap/session) is NOT the API URL. API URL comes from session response's `apiUrl` field.
    - Inbox must be resolved by `role` property, not by name (Pitfall 1 from research).
    - Custom mailboxes (Screener, @ToImbox) matched by exact name. If ambiguous, prefer top-level (parentId is null).
  </implementation>
</feature>

<verification>
```bash
uv run pytest tests/test_jmap_client.py -v
uv run ruff check src/mailroom/clients/jmap.py tests/test_jmap_client.py
```

All tests pass. Test count should be at least 5 (connect success, connect auth failure, resolve all found, resolve with Inbox by role, resolve missing mailbox).
</verification>

<success_criteria>
- JMAPClient.connect() correctly discovers session from mocked Fastmail response
- JMAPClient.resolve_mailboxes() builds name-to-id map from mocked Mailbox/get response
- Inbox is resolved by role, not name
- Missing mailboxes raise ValueError with descriptive message
- All tests pass with mocked httpx (no live API calls)
- `uv run ruff check` clean on all modified files
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-jmap-client/01-02-SUMMARY.md`
</output>
