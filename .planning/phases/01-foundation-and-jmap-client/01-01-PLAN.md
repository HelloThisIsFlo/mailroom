---
phase: 01-foundation-and-jmap-client
plan: 01
type: execute
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - .python-version
  - src/mailroom/__init__.py
  - src/mailroom/core/__init__.py
  - src/mailroom/core/config.py
  - src/mailroom/core/logging.py
  - src/mailroom/clients/__init__.py
  - src/mailroom/workflows/__init__.py
  - tests/__init__.py
  - tests/conftest.py
  - tests/test_config.py
  - tests/test_logging.py
autonomous: true
requirements:
  - CONF-01
  - CONF-02
  - CONF-03
  - LOG-01
  - LOG-02

must_haves:
  truths:
    - "All config values are loaded from MAILROOM_-prefixed env vars with sensible defaults"
    - "Missing required credentials (JMAP token) cause immediate startup failure with a clear error"
    - "Structured JSON logs are produced with action, level, and ISO timestamp fields"
    - "Console-friendly dev output is used when running in a terminal (stderr is a TTY)"
    - "Log level filtering works (debug messages hidden at info level)"
  artifacts:
    - path: "pyproject.toml"
      provides: "Project metadata, dependencies (httpx, pydantic-settings, structlog), dev dependencies (ruff, pytest, pytest-httpx), ruff config"
      contains: "pydantic-settings"
    - path: "src/mailroom/core/config.py"
      provides: "MailroomSettings with MAILROOM_ prefix, required jmap_token, defaults for labels/groups/poll interval"
      exports: ["MailroomSettings"]
    - path: "src/mailroom/core/logging.py"
      provides: "structlog configuration for JSON (prod) and console (dev) output"
      exports: ["configure_logging"]
    - path: "tests/test_config.py"
      provides: "Tests for config loading, defaults, required field validation"
      min_lines: 30
    - path: "tests/test_logging.py"
      provides: "Tests for log output format and level filtering"
      min_lines: 20
  key_links:
    - from: "src/mailroom/core/config.py"
      to: "pydantic-settings BaseSettings"
      via: "env_prefix='MAILROOM_' in SettingsConfigDict"
      pattern: "env_prefix.*MAILROOM"
    - from: "src/mailroom/core/logging.py"
      to: "structlog"
      via: "configure_logging() sets up processors and renderer"
      pattern: "structlog\\.configure"
---

<objective>
Scaffold the Python project with uv, install all dependencies, and implement the configuration and logging modules that every subsequent plan depends on.

Purpose: Establish the project foundation -- dependency management, module structure, typed config from env vars, and structured logging. This is the shared base for the JMAP client and all future code.
Output: A working Python project with `uv run pytest` passing, config loading from env vars, and structured log output.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/phases/01-foundation-and-jmap-client/01-CONTEXT.md
@.planning/phases/01-foundation-and-jmap-client/01-RESEARCH.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Scaffold Python project with uv and install dependencies</name>
  <files>
    pyproject.toml
    .python-version
    src/mailroom/__init__.py
    src/mailroom/core/__init__.py
    src/mailroom/clients/__init__.py
    src/mailroom/workflows/__init__.py
    tests/__init__.py
    tests/conftest.py
  </files>
  <action>
    Initialize the project using `uv init --lib --python 3.12` (or manually create pyproject.toml if uv init doesn't produce the desired layout). The final structure must use src/ layout:

    ```
    mailroom/
    ├── pyproject.toml
    ├── .python-version          # 3.12
    ├── src/
    │   └── mailroom/
    │       ├── __init__.py
    │       ├── core/
    │       │   └── __init__.py
    │       ├── clients/
    │       │   └── __init__.py
    │       └── workflows/
    │           └── __init__.py
    └── tests/
        ├── __init__.py
        └── conftest.py
    ```

    **pyproject.toml must include:**
    - `[project]` with name="mailroom", python requires=">=3.12"
    - Dependencies: `httpx`, `pydantic-settings`, `structlog`
    - Dev dependencies group: `ruff`, `pytest`, `pytest-httpx`
    - `[tool.ruff]` section with line-length=100, target-version="py312"
    - `[tool.ruff.lint]` with select=["E", "F", "I", "UP"] (errors, pyflakes, isort, pyupgrade)
    - `[tool.pytest.ini_options]` with testpaths=["tests"]

    Run `uv sync` to install all dependencies and create uv.lock.

    **conftest.py:** Create an empty conftest.py with a docstring: `"""Shared test fixtures for mailroom."""`

    All `__init__.py` files should be empty (or have a brief module docstring).

    Verify the project compiles: `uv run python -c "import mailroom; print('ok')"` must succeed.
  </action>
  <verify>
    <automated>uv run python -c "import mailroom; print('ok')" && uv run pytest --co -q 2>&amp;1 | head -5</automated>
    <manual>pyproject.toml has all deps, src/mailroom/ structure exists, uv.lock created</manual>
  </verify>
  <done>Project structure exists, all dependencies installed, `import mailroom` works, pytest collection runs without errors</done>
</task>

<task type="auto">
  <name>Task 2: Implement configuration module with pydantic-settings</name>
  <files>
    src/mailroom/core/config.py
    tests/test_config.py
  </files>
  <action>
    Create `src/mailroom/core/config.py` with a `MailroomSettings` class using pydantic-settings:

    ```python
    from pydantic_settings import BaseSettings, SettingsConfigDict

    class MailroomSettings(BaseSettings):
        model_config = SettingsConfigDict(
            env_prefix="MAILROOM_",
            case_sensitive=False,
        )

        # Required credentials -- no defaults, fails if missing
        jmap_token: str

        # Polling
        poll_interval: int = 300  # seconds (5 min)

        # Logging
        log_level: str = "info"

        # Triage label names (Fastmail mailbox names)
        label_to_imbox: str = "@ToImbox"
        label_to_feed: str = "@ToFeed"
        label_to_paper_trail: str = "@ToPaperTrail"
        label_to_jail: str = "@ToJail"

        # Contact group names
        group_imbox: str = "Imbox"
        group_feed: str = "Feed"
        group_paper_trail: str = "Paper Trail"
        group_jail: str = "Jail"
    ```

    **Design decisions (Claude's discretion):**
    - Use individual env vars for label-to-group mapping (not a structured/nested config). Each label and group gets its own `MAILROOM_LABEL_TO_*` / `MAILROOM_GROUP_*` env var. This maps cleanly to k8s ConfigMap entries.
    - Add a helper property or method that returns the label-to-destination mapping as a dict: `{"@ToImbox": {"group": "Imbox", "destination": "Imbox"}, ...}`. This connects labels to their group names for the triage workflow.
    - Include a `triage_labels` property returning the list of all triage label names (["@ToImbox", "@ToFeed", "@ToPaperTrail", "@ToJail"]) for use in mailbox validation at startup.
    - CardDAV password field: add `carddav_password: str = ""` with empty default (not required in Phase 1, but the field is defined for forward compatibility). Do NOT fail on missing CardDAV password in Phase 1.

    Create `tests/test_config.py` with tests:
    1. **test_defaults** -- Set only MAILROOM_JMAP_TOKEN, verify all defaults are correct (poll_interval=300, log_level="info", all label/group defaults match user's Fastmail setup)
    2. **test_required_jmap_token** -- Unset MAILROOM_JMAP_TOKEN, verify ValidationError is raised
    3. **test_env_override** -- Set MAILROOM_POLL_INTERVAL=60, MAILROOM_LOG_LEVEL=debug, verify they override defaults
    4. **test_triage_labels_property** -- Verify triage_labels returns all 4 label names
    5. **test_label_group_mapping** -- Verify the mapping helper returns correct label-to-group associations

    Use `monkeypatch.setenv` / `monkeypatch.delenv` in tests to control env vars without polluting the environment.
  </action>
  <verify>
    <automated>uv run pytest tests/test_config.py -v</automated>
  </verify>
  <done>MailroomSettings loads from MAILROOM_-prefixed env vars, has sensible defaults matching user's Fastmail setup, fails on missing jmap_token, all 5 tests pass</done>
</task>

<task type="auto">
  <name>Task 3: Implement structured logging module with structlog</name>
  <files>
    src/mailroom/core/logging.py
    tests/test_logging.py
  </files>
  <action>
    Create `src/mailroom/core/logging.py` with:

    ```python
    import logging
    import sys
    import structlog

    def configure_logging(log_level: str = "info") -> None:
        """Configure structlog for JSON output (prod) or console (dev).

        Production (non-TTY stderr): structured JSON with ISO timestamps.
        Development (TTY stderr): colored console output for readability.
        """
        level = getattr(logging, log_level.upper(), logging.INFO)

        shared_processors = [
            structlog.processors.add_log_level,
            structlog.processors.TimeStamper(fmt="iso", utc=True),
            structlog.processors.format_exc_info,
        ]

        if sys.stderr.isatty():
            # Dev: pretty console
            renderer = structlog.dev.ConsoleRenderer()
        else:
            # Prod (Docker/k8s): structured JSON
            shared_processors.append(structlog.processors.dict_tracebacks)
            renderer = structlog.processors.JSONRenderer()

        structlog.configure(
            processors=[*shared_processors, renderer],
            wrapper_class=structlog.make_filtering_bound_logger(level),
            logger_factory=structlog.PrintLoggerFactory(),
            cache_logger_on_first_use=True,
        )
    ```

    **User decisions implemented:**
    - JSON output in production (non-TTY) per locked decision
    - Console output in dev (TTY) per locked decision
    - Log level controlled via parameter (fed from MAILROOM_LOG_LEVEL config)
    - ISO timestamps with UTC per LOG-01
    - Exception info serialized as structured JSON fields per LOG-02

    Add a `get_logger` convenience re-export if desired, or document that callers use `structlog.get_logger()` directly.

    Create `tests/test_logging.py` with tests:
    1. **test_json_output** -- Configure logging, capture output, verify JSON structure contains "event", "level", "timestamp" keys. Force non-TTY mode by temporarily mocking `sys.stderr.isatty` to return False.
    2. **test_log_level_filtering** -- Configure at INFO level, log a DEBUG message, verify it does NOT appear in output. Log an INFO message, verify it DOES appear.
    3. **test_bound_context** -- Create a bound logger with `log.bind(action="sweep", sender="test@example.com")`, log a message, verify context fields appear in JSON output.
    4. **test_error_logging_with_exception** -- Log an error with `exc_info=True` inside a try/except, verify the exception info appears in the structured output (LOG-02: enough context to diagnose without cluster access).

    For capturing structlog output in tests, use `structlog.testing.capture_logs()` context manager or redirect PrintLoggerFactory output to a StringIO.
  </action>
  <verify>
    <automated>uv run pytest tests/test_logging.py -v</automated>
  </verify>
  <done>configure_logging() produces JSON in prod mode and console in dev mode, level filtering works, bound context fields appear in output, exceptions are serialized -- all 4 tests pass</done>
</task>

</tasks>

<verification>
Run the full test suite and linter:
```bash
uv run pytest tests/ -v
uv run ruff check src/ tests/
uv run ruff format --check src/ tests/
```
All tests pass, no lint errors, no format issues.

Verify config integration:
```bash
MAILROOM_JMAP_TOKEN=test uv run python -c "
from mailroom.core.config import MailroomSettings
s = MailroomSettings()
print(f'token={s.jmap_token}, poll={s.poll_interval}, level={s.log_level}')
print(f'labels={s.triage_labels}')
"
```
Expected output: token=test, poll=300, level=info, labels=['@ToImbox', '@ToFeed', '@ToPaperTrail', '@ToJail']

Verify logging integration:
```bash
MAILROOM_JMAP_TOKEN=test uv run python -c "
from mailroom.core.logging import configure_logging
import structlog
configure_logging('info')
log = structlog.get_logger()
log.info('test_event', action='verify', status='ok')
"
```
Expected: structured log line with event, action, status, level, timestamp fields.
</verification>

<success_criteria>
- `uv run pytest tests/ -v` passes all tests (minimum 9 tests across test_config.py and test_logging.py)
- `uv run ruff check src/ tests/` reports no errors
- `import mailroom` works
- MailroomSettings loads MAILROOM_-prefixed env vars with correct defaults
- structlog produces JSON output with required fields (event, level, timestamp)
- Project structure matches the src/ layout specified in research
</success_criteria>

<output>
After completion, create `.planning/phases/01-foundation-and-jmap-client/01-01-SUMMARY.md`
</output>
