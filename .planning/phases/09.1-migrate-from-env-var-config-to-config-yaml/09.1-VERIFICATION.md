---
phase: 09.1-migrate-from-env-var-config-to-config-yaml
verified: 2026-03-01T17:26:48Z
status: passed
score: 6/6 must-haves verified
re_verification: false
---

# Phase 09.1: Migrate from env-var config to config.yaml — Verification Report

**Phase Goal:** Replace MAILROOM_-prefixed environment variables with a config.yaml file as the primary configuration mechanism for all non-secret settings, with nested sub-models by concern area and name-only shorthand for triage categories.
**Verified:** 2026-03-01T17:26:48Z
**Status:** PASSED
**Re-verification:** No — initial verification

## Goal Achievement

### Observable Truths

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | MailroomSettings loads non-secret config from config.yaml via pydantic-settings YamlConfigSettingsSource | VERIFIED | `YamlConfigSettingsSource` imported and wired in `settings_customise_sources`. `_resolve_config_path()` resolves the file, passed to `YamlConfigSettingsSource(settings_cls, yaml_file=config_path)`. 278 tests pass. |
| 2 | Auth credentials (3 env vars) still work as flat env vars with MAILROOM_ prefix | VERIFIED | `jmap_token`, `carddav_username`, `carddav_password` are flat fields on `MailroomSettings` with `env_prefix="MAILROOM_"`. `TestAuthEnvVarsStayFlat` test class exercises this directly. |
| 3 | All source code, tests, and human tests use nested config paths (settings.polling.interval, settings.labels.mailroom_error, etc.) | VERIFIED | Zero stale flat accesses found in `src/` or `human-tests/`. All migrated fields accessed via `settings.polling.*`, `settings.labels.*`, `settings.triage.*`, `settings.logging.*`. Human tests confirmed using nested paths (test_7, 8, 9, 10, 11, 12). |
| 4 | K8s ConfigMap contains embedded config.yaml file content; Deployment uses volume mount | VERIFIED | `k8s/configmap.yaml` has `config.yaml: |` block with full YAML content. `k8s/deployment.yaml` has `volumeMounts` + `volumes` with `configMap: name: mailroom-config`. No `configMapRef` in `envFrom` (only `secretRef`). |
| 5 | Missing config.yaml fails fast with clear error message pointing to config.yaml.example | VERIFIED | `_resolve_config_path()` prints 3-line error to stderr ("Error: Config file not found...", "Copy config.yaml.example...", "  cp config.yaml.example config.yaml") then `raise SystemExit(1)`. Tested live: single message block, exit code 1. No duplication (plan-05 fix). |
| 6 | Name-only shorthand works in YAML triage categories (e.g., `- Feed`) | VERIFIED | `TriageSettings.normalize_categories` field_validator converts plain strings to `{"name": item}`. `TestNameOnlyShorthand` test class passes. Live runtime test confirmed. `config.yaml` and `k8s/configmap.yaml` both use shorthand (`- Feed`, `- Paper Trail`, `- Jail`). |

**Score:** 6/6 truths verified

---

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `pyproject.toml` | pydantic-settings[yaml] dependency | VERIFIED | Contains `"pydantic-settings[yaml]"` in dependencies |
| `src/mailroom/core/config.py` | Rewritten MailroomSettings with nested sub-models and YAML loading | VERIFIED | 404 lines; imports `YamlConfigSettingsSource`; defines `PollingSettings`, `TriageSettings`, `LabelSettings`, `LoggingSettings`, `MailroomSettings`; `settings_customise_sources` wires YAML source |
| `config.yaml.example` | Commented example config file | VERIFIED | All 4 sections present with inline comments; `polling:` section present |
| `.env.example` | Shrunk to 3 auth lines only | VERIFIED | Contains only `MAILROOM_JMAP_TOKEN`, `MAILROOM_CARDDAV_USERNAME`, `MAILROOM_CARDDAV_PASSWORD` |
| `tests/conftest.py` | Updated test fixture with YAML config support | VERIFIED | `autouse=True` fixture creates empty `config.yaml` in `tmp_path`, sets `MAILROOM_CONFIG` env var |
| `tests/test_config.py` | Rewritten config tests for YAML-based settings | VERIFIED | 596 lines; tests for nested access, YAML overrides, name-only shorthand, missing config, MAILROOM_CONFIG override, auth env vars, computed properties |
| `src/mailroom/__main__.py` | Updated config access paths | VERIFIED | Uses `settings.logging.level`, `settings.polling.interval`, `settings.polling.debounce_seconds`; no stale flat accesses |
| `src/mailroom/workflows/screener.py` | Updated settings access for labels, screener, warnings | VERIFIED | Uses `settings.labels.mailroom_error`, `settings.labels.mailroom_warning`, `settings.labels.warnings_enabled`, `settings.triage.screener_mailbox` |
| `src/mailroom/setup/provisioner.py` | Updated settings access for labels, warnings, log_level | VERIFIED | Uses `settings.labels.mailroom_error`, `settings.labels.warnings_enabled`, `settings.labels.mailroom_warning`, `settings.logging.level` |
| `src/mailroom/setup/sieve_guidance.py` | Updated settings access for screener_mailbox | VERIFIED | Uses `settings.triage.screener_mailbox` in both `_build_sieve_snippets` and `_build_ui_guide` |
| `k8s/configmap.yaml` | Embedded config.yaml as file data | VERIFIED | `data.config.yaml: |` block with full YAML content including name-only shorthands |
| `k8s/deployment.yaml` | Volume mount for config.yaml, secretRef only for envFrom | VERIFIED | `envFrom` has `secretRef` only; `volumeMounts` mounts `/app/config.yaml` from ConfigMap; `volumes` references `mailroom-config` ConfigMap |
| `config.yaml` | Default config file at project root for human tests and local dev | VERIFIED | Exists at project root; contains all 4 sections; uses name-only shorthand |

---

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `src/mailroom/core/config.py` | `config.yaml` | `YamlConfigSettingsSource` in `settings_customise_sources` | WIRED | `_resolve_config_path()` resolves path; `YamlConfigSettingsSource(settings_cls, yaml_file=config_path)` is the third source in priority chain |
| `src/mailroom/core/config.py` | `MAILROOM_JMAP_TOKEN` env var | `env_prefix="MAILROOM_"` in `SettingsConfigDict` | WIRED | `model_config = SettingsConfigDict(env_prefix="MAILROOM_", ...)` |
| `src/mailroom/__main__.py` | `src/mailroom/core/config.py` | `MailroomSettings()` + nested field access | WIRED | `settings.polling.interval`, `settings.polling.debounce_seconds`, `settings.logging.level` all present |
| `k8s/deployment.yaml` | `k8s/configmap.yaml` | Volume mount from ConfigMap | WIRED | `volumes[0].configMap.name: mailroom-config` matches `configmap.yaml` metadata name |
| `tests/conftest.py` | `src/mailroom/core/config.py` | Autouse fixture provides YAML config + MAILROOM_CONFIG | WIRED | `monkeypatch.setenv("MAILROOM_CONFIG", str(config))` with empty YAML; used by all 278 tests |
| `human-tests/*.py` | `config.yaml` | `MailroomSettings()` reads config.yaml from cwd | WIRED | Human tests call `MailroomSettings()` with `load_dotenv()` for auth; cwd project root provides `config.yaml` |
| `_resolve_config_path` | stderr output | `print()` only; `SystemExit(1)` is int, not string | WIRED | `print(..., file=sys.stderr)` then `raise SystemExit(1)` — no string arg duplication |

---

### Requirements Coverage

No formal requirement IDs were assigned to this phase (inserted phase with no REQUIREMENTS.md entries). The phase goal and success criteria were derived from the planning context and verified directly against the codebase above.

---

### Anti-Patterns Found

None. Scanned all modified source files (`config.py`, `__main__.py`, `screener.py`, `provisioner.py`, `sieve_guidance.py`, `k8s/configmap.yaml`, `k8s/deployment.yaml`) for TODO/FIXME, placeholder returns, empty handlers, and stub patterns. No issues found.

---

### Human Verification Required

One item is operationally verifiable only with a real Fastmail account but is not a blocker for code correctness:

**1. Human integration tests run end-to-end with new config model**

- **Test:** Run `python human-tests/test_7_screener_poll.py` from project root (with `.env` containing real credentials)
- **Expected:** Script loads `config.yaml` from project root automatically, uses `settings.triage.screener_mailbox` and `settings.labels.mailroom_error` correctly, and triage pipeline executes as before
- **Why human:** Requires real Fastmail credentials and a live account to exercise the actual JMAP/CardDAV path

Note: The UAT file (`09.1-UAT.md`) already documents 5 of 6 UAT scenarios as PASSED with 1 minor cosmetic note (double error message — fixed in plan-05). The core runtime behavior has been UAT-verified by the author.

---

### Summary

Phase 09.1 goal is fully achieved. All 6 observable truths are verified against the actual codebase:

- The config model is structurally complete: `PollingSettings`, `TriageSettings`, `LabelSettings`, `LoggingSettings` sub-models exist and are wired into `MailroomSettings` via `YamlConfigSettingsSource`.
- Auth credentials remain flat on the root settings object, loaded from `MAILROOM_`-prefixed env vars.
- All source files (`__main__.py`, `screener.py`, `provisioner.py`, `sieve_guidance.py`) use nested access paths exclusively — zero stale flat field accesses remain.
- All 16 human test files use nested paths where applicable, have valid syntax, and find `config.yaml` automatically from the project root.
- The K8s deployment is fully migrated from env-var injection to volume-mount config file.
- Missing `config.yaml` exits with exactly one clear error message (plan-05 gap closure verified).
- Name-only shorthand (`- Feed`) works via `field_validator` in `TriageSettings`.
- 278 unit tests pass.

---

_Verified: 2026-03-01T17:26:48Z_
_Verifier: Claude (gsd-verifier)_
