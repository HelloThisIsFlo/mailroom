---
phase: 09.1-migrate-from-env-var-config-to-config-yaml
plan: 03
type: execute
wave: 2
depends_on: ["09.1-01"]
files_modified:
  - tests/test_screener_workflow.py
  - tests/test_provisioner.py
  - tests/test_sieve_guidance.py
  - tests/test_eventsource.py
  - tests/test_logging.py
autonomous: true
requirements: []
must_haves:
  truths:
    - "All test files create MailroomSettings via YAML config fixture (not env vars for non-secret fields)"
    - "Tests that modify config fields (e.g., warnings_enabled=False) do so through YAML content or constructor kwargs"
    - "All tests pass with the new nested config model"
  artifacts:
    - path: "tests/test_screener_workflow.py"
      provides: "Tests updated for nested config access"
    - path: "tests/test_provisioner.py"
      provides: "Tests updated for nested config access"
    - path: "tests/test_sieve_guidance.py"
      provides: "Tests updated for nested config access"
    - path: "tests/test_eventsource.py"
      provides: "Tests updated (if settings access exists)"
    - path: "tests/test_logging.py"
      provides: "Tests updated (if settings access exists)"
  key_links:
    - from: "tests/conftest.py"
      to: "src/mailroom/core/config.py"
      via: "autouse fixture provides YAML config + MailroomSettings()"
      pattern: "MAILROOM_CONFIG"
---

<objective>
Migrate all remaining test files to work with the new YAML-based config model. Tests that create or modify MailroomSettings need to use the YAML config fixture from conftest.py (established in Plan 01) and update any direct field access to use nested paths.

Purpose: Ensures the full test suite passes with the new config model. Plan 01 handled test_config.py and conftest.py; this plan handles the remaining test files.

Output: All test files pass with the new config model.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-CONTEXT.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-01-SUMMARY.md

<interfaces>
<!-- From Plan 01 conftest.py: -->
```python
# autouse fixture provides empty config.yaml via MAILROOM_CONFIG env var
# mock_settings fixture provides MailroomSettings with test auth env vars

# New nested access paths:
settings.polling.interval          # was settings.poll_interval
settings.polling.debounce_seconds  # was settings.debounce_seconds
settings.logging.level             # was settings.log_level
settings.labels.mailroom_error     # was settings.label_mailroom_error
settings.labels.mailroom_warning   # was settings.label_mailroom_warning
settings.labels.warnings_enabled   # was settings.warnings_enabled
settings.triage.screener_mailbox   # was settings.screener_mailbox
settings.triage.categories         # was settings.triage_categories
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate test_screener_workflow.py</name>
  <files>tests/test_screener_workflow.py</files>
  <action>
Update test_screener_workflow.py for the new config model. The mock_settings fixture from conftest.py already provides a valid MailroomSettings object.

Key changes needed:
1. Any direct attribute mutation like `mock_settings.warnings_enabled = False` must change to `mock_settings.labels.warnings_enabled = False` (or better: use a fresh MailroomSettings with custom YAML content that sets warnings_enabled to false).
2. Check if tests reference `mock_settings.label_mailroom_error`, `mock_settings.screener_mailbox`, etc. and update to nested paths.
3. The mock_settings fixture auto-provides valid YAML via conftest.py's autouse fixture, so MailroomSettings() construction should work.

Search for all `settings.` or `mock_settings.` references in the file and update flat field accesses to nested paths. Computed properties (triage_labels, label_to_category_mapping, required_mailboxes, contact_groups) stay on root — do not change those.

For tests that need custom config values (like warnings_enabled=False), write a custom YAML string to a temp file and set MAILROOM_CONFIG to point to it, OR construct MailroomSettings with explicit kwargs for the nested models.
  </action>
  <verify>
    <automated>pytest tests/test_screener_workflow.py -x --tb=short</automated>
  </verify>
  <done>All screener workflow tests pass with new nested config paths.</done>
</task>

<task type="auto">
  <name>Task 2: Migrate remaining test files</name>
  <files>
    tests/test_provisioner.py
    tests/test_sieve_guidance.py
    tests/test_eventsource.py
    tests/test_logging.py
  </files>
  <action>
Update all remaining test files for the new config model:

**test_provisioner.py:**
- Update any `settings.label_mailroom_error`, `settings.label_mailroom_warning`, `settings.warnings_enabled` references to nested paths.
- Update any `settings.log_level` references to `settings.logging.level`.
- Ensure MailroomSettings construction works with YAML fixture.

**test_sieve_guidance.py:**
- Update `settings.screener_mailbox` to `settings.triage.screener_mailbox` if accessed directly in tests.
- Ensure MailroomSettings construction works with YAML fixture.

**test_eventsource.py:**
- Check for any settings field access and update to nested paths.
- Most likely uses `settings.debounce_seconds` → `settings.polling.debounce_seconds`.

**test_logging.py:**
- Check for any settings field access and update.
- Most likely uses `settings.log_level` → `settings.logging.level`.

For each file:
1. Read the file
2. Search for flat field accesses
3. Update to nested paths
4. Ensure MailroomSettings() construction sites work with the YAML fixture

Note: The autouse fixture in conftest.py provides YAML config for all tests automatically. Tests that set env vars for non-secret config fields (e.g., `monkeypatch.setenv("MAILROOM_POLL_INTERVAL", "120")`) need to either:
- Write YAML with the custom value to the temp config file, OR
- Construct MailroomSettings with explicit nested model kwargs
  </action>
  <verify>
    <automated>pytest tests/test_provisioner.py tests/test_sieve_guidance.py tests/test_eventsource.py tests/test_logging.py -x --tb=short</automated>
  </verify>
  <done>All remaining test files pass with new nested config paths.</done>
</task>

</tasks>

<verification>
```bash
# Full test suite passes
pytest tests/ -x -v

# No stale flat field accesses in tests (except in test_config.py which may test old env var behavior)
grep -rn "settings\.poll_interval\|settings\.debounce_seconds\|settings\.log_level\b" tests/ | grep -v test_config | grep -v __pycache__
grep -rn "settings\.label_mailroom_error\|settings\.label_mailroom_warning\|settings\.warnings_enabled\|settings\.screener_mailbox\b" tests/ | grep -v test_config | grep -v __pycache__
```
</verification>

<success_criteria>
- All test files pass: test_screener_workflow.py, test_provisioner.py, test_sieve_guidance.py, test_eventsource.py, test_logging.py
- Full `pytest tests/` passes
- No stale flat field accesses for migrated fields remain in test files (except test_config.py which is handled by Plan 01)
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-03-SUMMARY.md`
</output>
