---
phase: 09.1-migrate-from-env-var-config-to-config-yaml
plan: 01
subsystem: config
tags: [pydantic-settings, yaml, pyyaml, nested-models]

requires:
  - phase: 09-tech-debt-cleanup
    provides: Clean codebase ready for config migration
provides:
  - YAML-based MailroomSettings with nested sub-models
  - YamlConfigSettingsSource integration for config.yaml loading
  - Name-only shorthand for triage categories in YAML
  - Test infrastructure with autouse YAML config fixture
  - config.yaml.example and shrunk .env.example
affects: [09.1-02, 09.1-03, 09.1-04]

tech-stack:
  added: [pydantic-settings[yaml], PyYAML]
  patterns: [nested-sub-models, yaml-config-source, autouse-config-fixture]

key-files:
  created: [config.yaml.example]
  modified: [src/mailroom/core/config.py, tests/test_config.py, tests/conftest.py, pyproject.toml, .env.example]

key-decisions:
  - "Auth env vars stay flat on root MailroomSettings (not nested under auth sub-model) to keep MAILROOM_JMAP_TOKEN working with env_prefix"
  - "MAILROOM_CONFIG env var overrides config.yaml path (useful for tests and K8s)"
  - "Autouse conftest fixture creates empty config.yaml in tmp_path and cleans host env vars for test isolation"
  - "Name-only shorthand via field_validator(mode='before') on TriageSettings.categories"

patterns-established:
  - "Nested sub-models: PollingSettings, TriageSettings, LabelSettings, LoggingSettings as BaseModel composed into MailroomSettings"
  - "Config file discovery via _resolve_config_path() with SystemExit on missing file"

requirements-completed: []

duration: 5min
completed: 2026-03-01
---

# Phase 9.1 Plan 01: YAML Config Foundation Summary

**Rewrote MailroomSettings to load from config.yaml via pydantic-settings YamlConfigSettingsSource with nested sub-models (PollingSettings, TriageSettings, LabelSettings, LoggingSettings)**

## Performance

- **Duration:** 5 min
- **Started:** 2026-03-01
- **Completed:** 2026-03-01
- **Tasks:** 3 (TDD RED/GREEN + example files)
- **Files modified:** 6

## Accomplishments
- Config module rewritten with nested sub-models for clean YAML organization
- Auth credentials remain as flat env vars; all other config moves to config.yaml
- Name-only shorthand (`- Feed`) works in YAML triage categories
- Missing config.yaml fails fast with SystemExit and helpful message
- Test infrastructure updated with autouse fixture for YAML config isolation
- config.yaml.example created with inline comments; .env.example shrunk to 3 auth lines

## Task Commits

1. **chore: Add pydantic-settings[yaml] dependency** - `b97ec0e`
2. **test: RED - Failing tests for nested config** - `9d08b2f`
3. **feat: GREEN - YAML config with nested sub-models** - `1cca6b1`
4. **docs: config.yaml.example and .env.example** - `59710d0`

## Files Created/Modified
- `pyproject.toml` - Changed pydantic-settings to pydantic-settings[yaml]
- `src/mailroom/core/config.py` - Rewritten with nested sub-models and YAML loading
- `tests/test_config.py` - Rewritten for YAML-based config with nested access paths
- `tests/conftest.py` - Autouse fixture for YAML config + env var cleaning
- `config.yaml.example` - Commented example config file
- `.env.example` - Shrunk to 3 auth credential lines only

## Decisions Made
- Auth fields stay flat on MailroomSettings root (no auth sub-model) for env_prefix compatibility
- MAILROOM_CONFIG env var for config path override (tests, K8s, alternate configs)
- Autouse conftest fixture approach for test isolation (tmp_path + MAILROOM_CONFIG)
- field_validator(mode="before") for name-only shorthand normalization

## Deviations from Plan

None - plan executed exactly as written.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Config model foundation complete: nested sub-models, YAML loading, test infrastructure
- Source code consumers still use old flat paths (Plan 02 migrates src/)
- Test files still use old flat paths (Plan 03 migrates tests/)
- Human tests still use old flat paths (Plan 04 migrates human-tests/)

---
*Phase: 09.1-migrate-from-env-var-config-to-config-yaml*
*Completed: 2026-03-01*
