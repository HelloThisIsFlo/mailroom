---
phase: 09.1-migrate-from-env-var-config-to-config-yaml
plan: 05
subsystem: config
tags: [systemExit, stderr, error-handling]

# Dependency graph
requires:
  - phase: 09.1-migrate-from-env-var-config-to-config-yaml
    provides: "_resolve_config_path with print + SystemExit pattern"
provides:
  - "Single error message on missing config.yaml (no duplication)"
affects: []

# Tech tracking
tech-stack:
  added: []
  patterns:
    - "SystemExit(int) for exit codes; print() for user-facing messages"

key-files:
  created: []
  modified:
    - src/mailroom/core/config.py
    - tests/test_config.py

key-decisions:
  - "SystemExit(1) instead of SystemExit(string) -- int arg suppresses Python auto-print to stderr"

patterns-established:
  - "Exit pattern: print message to stderr explicitly, then raise SystemExit(int_code)"

requirements-completed: []

# Metrics
duration: 1min
completed: 2026-03-01
---

# Phase 9.1 Plan 05: Fix Double Error Message Summary

**SystemExit arg changed from string to int(1) so missing-config error prints exactly once to stderr**

## Performance

- **Duration:** 1 min
- **Started:** 2026-03-01T17:22:17Z
- **Completed:** 2026-03-01T17:23:10Z
- **Tasks:** 1
- **Files modified:** 2

## Accomplishments
- Fixed double error message when config.yaml is missing
- `_resolve_config_path` now uses `raise SystemExit(1)` instead of `raise SystemExit(string_message)`
- Updated test to verify exit code 1 and check stderr for the error message via capsys

## Task Commits

Each task was committed atomically:

1. **Task 1: Fix double-print in _resolve_config_path** - `0f287ad` (fix)

## Files Created/Modified
- `src/mailroom/core/config.py` - Changed SystemExit argument from string to int(1)
- `tests/test_config.py` - Updated test to assert exit code and stderr content

## Decisions Made
- SystemExit(1) instead of SystemExit(string) -- Python auto-prints string args to stderr, causing the duplicate message. Int args are silent.

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated test assertion for SystemExit code**
- **Found during:** Task 1 (Fix double-print in _resolve_config_path)
- **Issue:** Existing test asserted `"config.yaml.example" in str(exc_info.value)` which fails when SystemExit arg is now `1` (int)
- **Fix:** Changed test to assert `exc_info.value.code == 1` and verify error message via `capsys.readouterr().err`
- **Files modified:** tests/test_config.py
- **Verification:** All 278 tests pass
- **Committed in:** 0f287ad (part of task commit)

---

**Total deviations:** 1 auto-fixed (1 bug fix)
**Impact on plan:** Test update was necessary consequence of the planned change. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Phase 9.1 gap closure complete -- all 5 plans finished
- Missing config.yaml now shows a clean single error message

## Self-Check: PASSED

- [x] src/mailroom/core/config.py exists
- [x] tests/test_config.py exists
- [x] 09.1-05-SUMMARY.md exists
- [x] Commit 0f287ad exists in git log

---
*Phase: 09.1-migrate-from-env-var-config-to-config-yaml*
*Completed: 2026-03-01*
