---
phase: 09.1-migrate-from-env-var-config-to-config-yaml
plan: 04
type: execute
wave: 3
depends_on: ["09.1-01"]
files_modified:
  - human-tests/test_7_screener_poll.py
  - human-tests/test_8_conflict_detection.py
  - human-tests/test_9_already_grouped.py
  - human-tests/test_10_retry_safety.py
  - human-tests/test_11_person_contact.py
  - human-tests/test_12_company_contact.py
  - human-tests/test_14_setup_dry_run.py
  - human-tests/test_15_setup_apply.py
  - human-tests/test_16_eventsource_push.py
  - human-tests/test_1_auth.py
  - human-tests/test_2_query.py
  - human-tests/test_3_label.py
  - human-tests/test_4_carddav_auth.py
  - human-tests/test_5_carddav_contacts.py
  - human-tests/test_6_carddav_groups.py
  - human-tests/test_13_docker_polling.py
  - config.yaml
autonomous: true
requirements: []
must_haves:
  truths:
    - "All human tests use nested config paths (settings.triage.screener_mailbox, settings.labels.mailroom_error, etc.)"
    - "Human tests find config.yaml in the project root (cwd default) automatically"
    - "A committable config.yaml exists at project root with default config for human tests"
    - "Human tests still load .env for auth credentials via load_dotenv()"
  artifacts:
    - path: "config.yaml"
      provides: "Default config file at project root for human tests and local dev"
      contains: "polling:"
    - path: "human-tests/test_7_screener_poll.py"
      provides: "Updated human test with nested config access"
    - path: "human-tests/test_8_conflict_detection.py"
      provides: "Updated human test with nested config access"
    - path: "human-tests/test_9_already_grouped.py"
      provides: "Updated human test with nested config access"
    - path: "human-tests/test_10_retry_safety.py"
      provides: "Updated human test with nested config access"
    - path: "human-tests/test_11_person_contact.py"
      provides: "Updated human test with nested config access"
    - path: "human-tests/test_12_company_contact.py"
      provides: "Updated human test with nested config access"
  key_links:
    - from: "human-tests/*.py"
      to: "config.yaml"
      via: "MailroomSettings() reads config.yaml from cwd"
      pattern: "MailroomSettings\\(\\)"
    - from: "human-tests/*.py"
      to: ".env"
      via: "load_dotenv() for auth credentials"
      pattern: "load_dotenv"
---

<objective>
Migrate all 16 human integration test scripts to use the new nested config access paths, and create a committable config.yaml at the project root for human tests and local development.

Purpose: Human tests are first-class citizens (per CLAUDE.md). They run from the project root directory, so they need a config.yaml there. They also need their field accesses updated to the new nested paths.

Output: All human tests use nested config paths. A default config.yaml exists at project root. Human tests can run against real Fastmail with the new config model.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-CONTEXT.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-01-SUMMARY.md

<interfaces>
<!-- Human tests access pattern (example from test_8_conflict_detection.py): -->
```python
from dotenv import load_dotenv
load_dotenv()

from mailroom.core.config import MailroomSettings
settings = MailroomSettings()

# Flat accesses that need migration:
settings.screener_mailbox      -> settings.triage.screener_mailbox
settings.label_mailroom_error  -> settings.labels.mailroom_error
settings.label_mailroom_warning -> settings.labels.mailroom_warning

# These stay unchanged (computed properties on root):
settings.triage_labels
settings.label_to_category_mapping
settings.required_mailboxes
settings.contact_groups

# Auth stays unchanged:
settings.jmap_token
settings.carddav_username
settings.carddav_password
```

NOTE per Phase 9 decision: Human tests use hardcoded label strings (like "@MailroomError") instead of settings properties in many places. Only update the places that actually access settings fields.
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create committable config.yaml and migrate human tests</name>
  <files>
    config.yaml
    human-tests/test_7_screener_poll.py
    human-tests/test_8_conflict_detection.py
    human-tests/test_9_already_grouped.py
    human-tests/test_10_retry_safety.py
    human-tests/test_11_person_contact.py
    human-tests/test_12_company_contact.py
    human-tests/test_14_setup_dry_run.py
    human-tests/test_15_setup_apply.py
    human-tests/test_16_eventsource_push.py
  </files>
  <action>
**Step 1: Create config.yaml at project root.**

This is a committable file (no secrets) with default config matching v1.0 behavior. It is used by:
- Human tests (they run from project root)
- Local development (`python -m mailroom` from project root)

Content should match config.yaml.example but without the comments (cleaner for committed file). Contains the 5 default categories with the name-only shorthand where possible.

```yaml
polling:
  interval: 60
  debounce_seconds: 3

triage:
  screener_mailbox: Screener
  categories:
    - name: Imbox
      destination_mailbox: Inbox
    - Feed
    - Paper Trail
    - Jail
    - name: Person
      parent: Imbox
      contact_type: person

labels:
  mailroom_error: "@MailroomError"
  mailroom_warning: "@MailroomWarning"
  warnings_enabled: true

logging:
  level: info
```

**Step 2: Migrate human tests 7-12, 14-16.**

For each human test file, search for flat field accesses on `settings` and update to nested paths:
- `settings.screener_mailbox` -> `settings.triage.screener_mailbox`
- `settings.label_mailroom_error` -> `settings.labels.mailroom_error`
- `settings.label_mailroom_warning` -> `settings.labels.mailroom_warning`

Do NOT change:
- `settings.jmap_token`, `settings.carddav_username`, `settings.carddav_password` (stay flat)
- `settings.triage_labels`, `settings.label_to_category_mapping`, `settings.required_mailboxes`, `settings.contact_groups` (stay on root)
- Hardcoded label strings like `"@MailroomError"` (not settings accesses)

Note: Human tests 1-6 and 13 likely don't reference migrated fields. Check them and update only if needed.
  </action>
  <verify>
    <automated>python -c "
from pathlib import Path
import re

# Check config.yaml exists and is valid YAML
import yaml
config = yaml.safe_load(Path('config.yaml').read_text())
assert 'polling' in config, 'Missing polling section'
assert 'triage' in config, 'Missing triage section'
assert 'labels' in config, 'Missing labels section'
assert 'logging' in config, 'Missing logging section'
print('config.yaml: valid')

# Check no stale flat accesses in human tests
stale = re.compile(r'settings\.(poll_interval|debounce_seconds|log_level|label_mailroom_error|label_mailroom_warning|warnings_enabled|screener_mailbox|triage_categories)\b')
for f in Path('human-tests').glob('test_*.py'):
    content = f.read_text()
    matches = stale.findall(content)
    if matches:
        print(f'STALE: {f.name}: {matches}')
        raise SystemExit(1)

print('human-tests: no stale accesses')
print('ALL OK')
"</automated>
  </verify>
  <done>config.yaml exists at project root with default settings. All human tests use nested config paths. No stale flat field accesses remain.</done>
</task>

<task type="auto">
  <name>Task 2: Verify human test imports still work</name>
  <files>
    human-tests/test_1_auth.py
    human-tests/test_2_query.py
    human-tests/test_3_label.py
    human-tests/test_4_carddav_auth.py
    human-tests/test_5_carddav_contacts.py
    human-tests/test_6_carddav_groups.py
    human-tests/test_13_docker_polling.py
  </files>
  <action>
Check human tests 1-6 and 13 for any flat field accesses on settings that need updating. These tests may:
- Only use auth fields (unchanged) -- no migration needed
- Reference computed properties (unchanged) -- no migration needed
- Reference migrated flat fields -- update to nested paths

Read each file, search for flat accesses to migrated fields, and update if found. For tests that don't reference any migrated fields, no changes needed.

Also verify that all human test files can at least be imported successfully (syntax check) with the new config model by running:
```python
python -c "import ast; ast.parse(open('human-tests/test_N_name.py').read())"
```
for each file.
  </action>
  <verify>
    <automated>python -c "
import ast
from pathlib import Path

for f in sorted(Path('human-tests').glob('test_*.py')):
    try:
        ast.parse(f.read_text())
        print(f'  {f.name}: syntax OK')
    except SyntaxError as e:
        print(f'  {f.name}: SYNTAX ERROR: {e}')
        raise SystemExit(1)

print('ALL human tests: syntax valid')
"</automated>
  </verify>
  <done>All 16 human test files have valid syntax and no stale flat field accesses for migrated fields.</done>
</task>

</tasks>

<verification>
```bash
# config.yaml exists and is valid
python -c "import yaml; c = yaml.safe_load(open('config.yaml')); print('polling:', c['polling']); print('triage:', c['triage']); print('OK')"

# No stale accesses in human tests
grep -rn "settings\.poll_interval\|settings\.debounce_seconds\|settings\.log_level\|settings\.label_mailroom_error\|settings\.label_mailroom_warning\|settings\.warnings_enabled\|settings\.screener_mailbox\|settings\.triage_categories" human-tests/ | grep -v __pycache__

# All human test files parse without syntax errors
python -c "import ast; [ast.parse(open(f).read()) for f in sorted(__import__('pathlib').Path('human-tests').glob('test_*.py'))]; print('OK')"

# Full unit test suite still passes
pytest tests/ -x
```
</verification>

<success_criteria>
- config.yaml exists at project root with default settings (no secrets)
- All 16 human test files use nested config paths where applicable
- No stale flat field accesses for migrated fields in human-tests/
- All human test files have valid Python syntax
- Full unit test suite still passes
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-04-SUMMARY.md`
</output>
