# Phase 9.1: Migrate from env var config to config.yaml - Context

**Gathered:** 2026-03-01
**Status:** Ready for planning

<domain>
## Phase Boundary

Replace `MAILROOM_`-prefixed environment variables with a `config.yaml` file as the primary configuration mechanism for all non-secret settings. Secrets (3 auth credentials) remain as env vars. No backwards compatibility — clean break.

</domain>

<decisions>
## Implementation Decisions

### Config file structure
- YAML organized by concern: `auth`, `polling`, `triage`, `labels`, `logging` sections
- Nested sub-models in pydantic: `AuthSettings`, `PollingSettings`, `TriageSettings`, `LabelSettings`, `LoggingSettings` composed into `MailroomSettings`
- Access paths change: `settings.jmap_token` → `settings.auth.jmap_token`, `settings.poll_interval` → `settings.polling.interval`, etc.
- Name-only shorthand for triage categories: a plain string (e.g., `- Feed`) is a category with just a name; dict form for overrides (e.g., `- name: Person\n  parent: Imbox`)
- Commented `config.yaml.example` ships with the project — explains each section inline, similar to current `.env.example`

### Secret handling
- Config.yaml contains all non-secret behavior settings
- 3 auth env vars survive: `MAILROOM_JMAP_TOKEN`, `MAILROOM_CARDDAV_USERNAME`, `MAILROOM_CARDDAV_PASSWORD` — kept with current flat naming (no double-underscore nesting)
- MailroomSettings merges config.yaml + env vars into one object — code accesses fields uniformly regardless of source
- K8s: Secret resource unchanged (injects 3 env vars); ConfigMap holds config.yaml as file data

### Migration approach
- Clean break: no backwards compatibility, no deprecation warnings, no detection of old env vars
- Old non-secret env vars (MAILROOM_POLL_INTERVAL, MAILROOM_TRIAGE_CATEGORIES, etc.) are silently ignored — app behaves as if they never existed
- `.env.example` shrinks to only the 3 auth credential lines
- `k8s/configmap.yaml` changes from individual env var key-value pairs to embedded config.yaml file content (Helm-friendly — maps directly to template in future Helm migration)
- `k8s/deployment.yaml` changes from `envFrom: configMapRef` to volume mount for config.yaml; keeps `envFrom: secretRef`
- `k8s/secret.yaml.example` unchanged

### File discovery & loading
- Default: look for `config.yaml` in working directory
- Override: `MAILROOM_CONFIG` env var specifies alternate path
- Missing config.yaml: error and exit with clear message pointing to config.yaml.example
- YAML parse errors: fail fast with line-level error messages
- Invalid config values: fail fast with pydantic validation errors (same philosophy as current validation)
- `mailroom-setup` command reads the same config.yaml as the main service

### Claude's Discretion
- YAML parsing library choice (PyYAML vs ruamel.yaml vs pydantic-yaml)
- Exact error message formatting for parse/validation failures
- Internal config loading architecture (custom settings source vs manual YAML load)
- Test migration strategy for the ~40 call sites

</decisions>

<specifics>
## Specific Ideas

- Config.yaml structure should match future Helm `values.yaml` — grouped by concern with clean nesting
- The `config.yaml.example` should feel like the current `.env.example` — well-commented, self-documenting
- Triage categories in YAML should be dramatically more readable than the current JSON-blob-in-env-var approach

</specifics>

<code_context>
## Existing Code Insights

### Reusable Assets
- `TriageCategory` model (config.py:20-41): Pydantic model for category config — reuse as-is, just change how it's loaded
- `ResolvedCategory` dataclass (config.py:44-53): Resolution logic is input-agnostic — works regardless of YAML vs env var source
- `resolve_categories()` (config.py:186-262): Full validation + resolution pipeline — no changes needed
- `_default_categories()` (config.py:77-88): Default factory — still used when config.yaml omits categories section

### Established Patterns
- `pydantic-settings` with `BaseSettings` + `SettingsConfigDict`: Current config loading mechanism — needs to be extended or replaced with YAML loading
- Model validators (`resolve_and_validate_categories`): Post-load validation pattern — keep this approach
- Computed properties (`triage_labels`, `required_mailboxes`, `contact_groups`): Derived from resolved categories — unchanged

### Integration Points
- `MailroomSettings()` called in ~40 locations across src/, tests/, and human-tests/
- `__main__.py:103`: Main entry point creates settings
- `setup/provisioner.py:207`: Setup command creates settings
- `tests/conftest.py:14`: Test fixture creates settings
- All human tests create `MailroomSettings()` at module level
- K8s deployment: `k8s/deployment.yaml` envFrom → needs volume mount migration
- K8s config: `k8s/configmap.yaml` → embedded config.yaml file content

</code_context>

<deferred>
## Deferred Ideas

- Helm migration — future phase: replace raw k8s manifests with Helm chart, `values.yaml` becomes single config source for k8s
- Env var override for ANY config.yaml field (not just secrets) — explicitly not doing this for simplicity

</deferred>

---

*Phase: 09.1-migrate-from-env-var-config-to-config-yaml*
*Context gathered: 2026-03-01*
