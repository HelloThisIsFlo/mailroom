---
phase: 09.1-migrate-from-env-var-config-to-config-yaml
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - pyproject.toml
  - src/mailroom/core/config.py
  - config.yaml.example
  - .env.example
  - tests/test_config.py
  - tests/conftest.py
autonomous: true
requirements: []
must_haves:
  truths:
    - "MailroomSettings loads non-secret config from config.yaml via pydantic-settings YamlConfigSettingsSource"
    - "Auth env vars (MAILROOM_JMAP_TOKEN, MAILROOM_CARDDAV_USERNAME, MAILROOM_CARDDAV_PASSWORD) still work as flat env vars"
    - "Nested sub-models exist: PollingSettings, TriageSettings, LabelSettings, LoggingSettings"
    - "Name-only shorthand ('- Feed') works in YAML triage categories"
    - "Missing config.yaml fails fast with clear error pointing to config.yaml.example"
    - "MAILROOM_CONFIG env var overrides default config.yaml path"
    - "config.yaml.example documents all sections with inline comments"
    - ".env.example contains only the 3 auth credential lines"
  artifacts:
    - path: "pyproject.toml"
      provides: "pydantic-settings[yaml] dependency"
      contains: "pydantic-settings[yaml]"
    - path: "src/mailroom/core/config.py"
      provides: "Rewritten MailroomSettings with nested sub-models and YAML loading"
      contains: "YamlConfigSettingsSource"
    - path: "config.yaml.example"
      provides: "Commented example config file"
      contains: "polling:"
    - path: ".env.example"
      provides: "Shrunk to 3 auth lines only"
    - path: "tests/conftest.py"
      provides: "Updated test fixture with YAML config support"
      contains: "MAILROOM_CONFIG"
    - path: "tests/test_config.py"
      provides: "Rewritten config tests for YAML-based settings"
  key_links:
    - from: "src/mailroom/core/config.py"
      to: "config.yaml"
      via: "YamlConfigSettingsSource in settings_customise_sources"
      pattern: "YamlConfigSettingsSource"
    - from: "src/mailroom/core/config.py"
      to: "MAILROOM_JMAP_TOKEN env var"
      via: "env_prefix in BaseSettings"
      pattern: "env_prefix.*MAILROOM_"
---

<objective>
Rewrite MailroomSettings to load config from config.yaml via pydantic-settings YamlConfigSettingsSource, with nested sub-models for each concern area. Auth credentials remain as flat env vars. Create config.yaml.example, shrink .env.example, update test infrastructure.

Purpose: This is the foundation plan -- all subsequent plans depend on the new config model shape and YAML loading mechanism being in place.

Output: Working config module with YAML loading, test infrastructure, and example files. Access paths on MailroomSettings change (e.g., `settings.poll_interval` becomes `settings.polling.interval`), but consumers are not yet updated (that's Plan 03).
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-CONTEXT.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-RESEARCH.md

<interfaces>
<!-- Current config.py exports that must be preserved (used by consumers): -->
From src/mailroom/core/config.py:
```python
class TriageCategory(BaseModel):
    name: str
    label: str | None = None
    contact_group: str | None = None
    destination_mailbox: str | None = None
    contact_type: Literal["company", "person"] = "company"
    parent: str | None = None

@dataclass(frozen=True)
class ResolvedCategory:
    name: str
    label: str
    contact_group: str
    destination_mailbox: str
    contact_type: str
    parent: str | None

class MailroomSettings(BaseSettings):
    # Current flat fields (CHANGING to nested):
    jmap_token: str                          # stays flat
    carddav_username: str = ""               # stays flat
    carddav_password: str = ""               # stays flat
    poll_interval: int = 60                  # -> polling.interval
    debounce_seconds: int = 3                # -> polling.debounce_seconds
    log_level: str = "info"                  # -> logging.level
    label_mailroom_error: str = "@MailroomError"     # -> labels.mailroom_error
    label_mailroom_warning: str = "@MailroomWarning" # -> labels.mailroom_warning
    warnings_enabled: bool = True            # -> labels.warnings_enabled
    screener_mailbox: str = "Screener"       # -> triage.screener_mailbox
    triage_categories: list[TriageCategory]  # -> triage.categories

    # Properties that STAY on root (access cross-model data):
    triage_labels -> list[str]
    label_to_category_mapping -> dict[str, ResolvedCategory]
    required_mailboxes -> list[str]
    contact_groups -> list[str]
```

From tests/conftest.py:
```python
@pytest.fixture
def mock_settings(monkeypatch):
    monkeypatch.setenv("MAILROOM_JMAP_TOKEN", "test-token")
    monkeypatch.setenv("MAILROOM_CARDDAV_USERNAME", "test@fastmail.com")
    monkeypatch.setenv("MAILROOM_CARDDAV_PASSWORD", "test-password")
    return MailroomSettings()
```
</interfaces>
</context>

<feature>
  <name>YAML-based MailroomSettings with nested sub-models</name>
  <files>
    pyproject.toml
    src/mailroom/core/config.py
    config.yaml.example
    .env.example
    tests/conftest.py
    tests/test_config.py
  </files>
  <behavior>
    Phase 1 — Dependency and infrastructure:
    - pyproject.toml: "pydantic-settings" changes to "pydantic-settings[yaml]"
    - `uv sync` installs PyYAML in venv

    Phase 2 — Config model rewrite (RED tests first, then GREEN):
    - PollingSettings(BaseModel): interval=60, debounce_seconds=3
    - TriageSettings(BaseModel): screener_mailbox="Screener", categories=Field(default_factory=_default_categories)
      - field_validator("categories", mode="before") normalizes strings to {"name": string}
    - LabelSettings(BaseModel): mailroom_error="@MailroomError", mailroom_warning="@MailroomWarning", warnings_enabled=True
    - LoggingSettings(BaseModel): level="info"
    - MailroomSettings(BaseSettings):
      - model_config: yaml_file, yaml_file_encoding, env_prefix="MAILROOM_", case_sensitive=False, arbitrary_types_allowed=True
      - Flat auth fields: jmap_token (required), carddav_username="", carddav_password=""
      - Nested sections: polling, triage, labels, logging (all with defaults)
      - settings_customise_sources: (init, env, YamlConfigSettingsSource) with MAILROOM_CONFIG path override
      - Config file existence check before constructing YamlConfigSettingsSource
      - model_validator resolves categories from self.triage.categories (not self.triage_categories)
      - Computed properties stay on root, access nested sub-models:
        - triage_labels: [c.label for c in self._resolved_categories]
        - label_to_category_mapping: {r.label: r for r in resolved}
        - required_mailboxes: uses self.triage.screener_mailbox, self.labels.mailroom_error, self.labels.warnings_enabled, self.labels.mailroom_warning
        - contact_groups: sorted unique from resolved

    Phase 3 — Test infrastructure:
    - conftest.py: autouse fixture creates empty config.yaml in tmp_path, sets MAILROOM_CONFIG env var
    - mock_settings fixture: sets 3 auth env vars + creates MailroomSettings()

    Phase 4 — Config tests rewrite:
    - Tests that used monkeypatch.setenv for non-secret config now write YAML to tmp_path
    - Tests for name-only shorthand ('- Feed' in YAML)
    - Tests for missing config.yaml (SystemExit with helpful message)
    - Tests for MAILROOM_CONFIG override
    - All existing test behaviors preserved (defaults, custom categories, validation, etc.)

    Phase 5 — Example files:
    - config.yaml.example: commented YAML with all sections (polling, triage, labels, logging)
    - .env.example: shrunk to only 3 auth credential lines with comments
  </behavior>
  <implementation>
    1. Update pyproject.toml dependency and run uv sync
    2. Write RED tests in test_config.py for new nested access paths, YAML loading, shorthand, error handling
    3. Rewrite config.py:
       - Keep TriageCategory, ResolvedCategory, derivation helpers, _default_categories, _validate_categories, resolve_categories UNCHANGED
       - Add PollingSettings, TriageSettings (with field_validator), LabelSettings, LoggingSettings as BaseModel sub-models
       - Rewrite MailroomSettings with nested sections, YAML source, env source for auth only
       - Update model_validator to access self.triage.categories
       - Update computed properties to access nested sub-model fields
    4. Update conftest.py with autouse YAML config fixture
    5. Run tests GREEN
    6. Create config.yaml.example and shrink .env.example
    7. REFACTOR if needed
  </implementation>
</feature>

<verification>
```bash
# Verify PyYAML installed
python -c "import yaml; print(yaml.__version__)"

# All config tests pass
pytest tests/test_config.py -x -v

# All existing tests still pass (conftest fixture provides YAML config)
pytest tests/ -x

# Example files exist
test -f config.yaml.example && echo "OK" || echo "MISSING"
test -f .env.example && echo "OK" || echo "MISSING"
```
</verification>

<success_criteria>
- MailroomSettings loads from config.yaml + env vars (auth only)
- Nested access paths work: settings.polling.interval, settings.triage.screener_mailbox, etc.
- Auth fields remain flat: settings.jmap_token, settings.carddav_username, settings.carddav_password
- Computed properties stay on root: settings.triage_labels, settings.required_mailboxes, etc.
- Name-only shorthand works in YAML categories
- Missing config.yaml raises SystemExit with clear message
- MAILROOM_CONFIG env var overrides config path
- All tests pass (both test_config.py and full suite via conftest autouse fixture)
- config.yaml.example and .env.example created
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-01-SUMMARY.md`
</output>
