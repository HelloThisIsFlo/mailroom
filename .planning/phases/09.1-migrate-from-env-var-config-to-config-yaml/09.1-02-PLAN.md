---
phase: 09.1-migrate-from-env-var-config-to-config-yaml
plan: 02
type: execute
wave: 2
depends_on: ["09.1-01"]
files_modified:
  - src/mailroom/__main__.py
  - src/mailroom/workflows/screener.py
  - src/mailroom/setup/provisioner.py
  - src/mailroom/setup/sieve_guidance.py
  - k8s/configmap.yaml
  - k8s/deployment.yaml
autonomous: true
requirements: []
must_haves:
  truths:
    - "All source code accesses config through new nested paths (settings.polling.interval, settings.labels.mailroom_error, etc.)"
    - "K8s ConfigMap contains embedded config.yaml file content instead of individual env var key-value pairs"
    - "K8s Deployment uses volume mount for config.yaml instead of envFrom configMapRef"
    - "K8s Deployment keeps envFrom secretRef for auth env vars"
    - "Main service starts and runs correctly with new config paths"
    - "Setup command works with new config paths"
  artifacts:
    - path: "src/mailroom/__main__.py"
      provides: "Updated config access paths"
      contains: "settings.polling.interval"
    - path: "src/mailroom/workflows/screener.py"
      provides: "Updated settings access for labels, screener, warnings"
      contains: "settings.labels.mailroom_error"
    - path: "src/mailroom/setup/provisioner.py"
      provides: "Updated settings access for labels, warnings, log_level"
      contains: "settings.labels.mailroom_error"
    - path: "src/mailroom/setup/sieve_guidance.py"
      provides: "Updated settings access for screener_mailbox"
      contains: "settings.triage.screener_mailbox"
    - path: "k8s/configmap.yaml"
      provides: "Embedded config.yaml as file data"
      contains: "config.yaml: |"
    - path: "k8s/deployment.yaml"
      provides: "Volume mount for config.yaml, secretRef only for envFrom"
      contains: "volumeMounts"
  key_links:
    - from: "src/mailroom/__main__.py"
      to: "src/mailroom/core/config.py"
      via: "MailroomSettings() constructor + nested field access"
      pattern: "settings\\.polling\\."
    - from: "k8s/deployment.yaml"
      to: "k8s/configmap.yaml"
      via: "volume mount from ConfigMap"
      pattern: "configMap.*mailroom-config"
---

<objective>
Migrate all source code access paths from flat config fields to nested sub-model paths, and update K8s deployment artifacts from env var injection to config.yaml volume mount.

Purpose: After Plan 01 established the new config model, this plan updates all consumers to use the new access paths and updates the deployment infrastructure.

Output: All `src/` files use nested paths. K8s manifests use config.yaml as a mounted file.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-CONTEXT.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-RESEARCH.md
@.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-01-SUMMARY.md

<interfaces>
<!-- New config access paths from Plan 01: -->

MailroomSettings new nested access patterns:
```
# Auth (UNCHANGED - flat on root)
settings.jmap_token
settings.carddav_username
settings.carddav_password

# Polling (was flat, now nested)
settings.poll_interval         -> settings.polling.interval
settings.debounce_seconds      -> settings.polling.debounce_seconds

# Logging (was flat, now nested)
settings.log_level             -> settings.logging.level

# Labels (was flat, now nested)
settings.label_mailroom_error  -> settings.labels.mailroom_error
settings.label_mailroom_warning -> settings.labels.mailroom_warning
settings.warnings_enabled      -> settings.labels.warnings_enabled

# Triage (was flat, now nested)
settings.screener_mailbox      -> settings.triage.screener_mailbox
settings.triage_categories     -> settings.triage.categories

# Computed properties (UNCHANGED - stay on root)
settings.triage_labels
settings.label_to_category_mapping
settings.required_mailboxes
settings.contact_groups
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Migrate source code access paths</name>
  <files>
    src/mailroom/__main__.py
    src/mailroom/workflows/screener.py
    src/mailroom/setup/provisioner.py
    src/mailroom/setup/sieve_guidance.py
  </files>
  <action>
Update all flat config field accesses to nested sub-model paths in the 4 source files. The specific changes by file:

**__main__.py** (6 changes):
- `settings.log_level` -> `settings.logging.level` (line 104)
- `settings.poll_interval` -> `settings.polling.interval` (lines 128, 169, 179)
- `settings.debounce_seconds` -> `settings.polling.debounce_seconds` (lines 170, 184)

**workflows/screener.py** (5 changes):
- `self._settings.label_mailroom_error` -> `self._settings.labels.mailroom_error` (lines 132, 202)
- `self._settings.label_mailroom_warning` -> `self._settings.labels.mailroom_warning` (line 250)
- `self._settings.warnings_enabled` -> `self._settings.labels.warnings_enabled` (line 329)
- `self._settings.screener_mailbox` -> `self._settings.triage.screener_mailbox` (line 333)

**setup/provisioner.py** (4 changes):
- `settings.label_mailroom_error` -> `settings.labels.mailroom_error` (line 58)
- `settings.warnings_enabled` -> `settings.labels.warnings_enabled` (line 59)
- `settings.label_mailroom_warning` -> `settings.labels.mailroom_warning` (line 60)
- `settings.log_level` -> `settings.logging.level` (line 212)

**setup/sieve_guidance.py** (2 changes):
- `settings.screener_mailbox` -> `settings.triage.screener_mailbox` (lines 47, 48)

Do NOT change any of these (they remain on root):
- `settings.jmap_token`, `settings.carddav_username`, `settings.carddav_password`
- `settings.triage_labels`, `settings.label_to_category_mapping`
- `settings.required_mailboxes`, `settings.contact_groups`
- `settings._resolved_categories` (used in sieve_guidance.py)
  </action>
  <verify>
    <automated>pytest tests/ -x --tb=short</automated>
  </verify>
  <done>All source files use nested config paths. No flat field accesses remain for poll_interval, debounce_seconds, log_level, label_mailroom_error, label_mailroom_warning, warnings_enabled, screener_mailbox, or triage_categories in src/.</done>
</task>

<task type="auto">
  <name>Task 2: Update K8s deployment artifacts</name>
  <files>
    k8s/configmap.yaml
    k8s/deployment.yaml
  </files>
  <action>
**k8s/configmap.yaml** — Replace individual env var key-value pairs with embedded config.yaml file content:

```yaml
apiVersion: v1
kind: ConfigMap
metadata:
  name: mailroom-config
  namespace: mailroom
data:
  config.yaml: |
    polling:
      interval: 60
      debounce_seconds: 3
    triage:
      screener_mailbox: Screener
      categories:
        - name: Imbox
          destination_mailbox: Inbox
        - Feed
        - Paper Trail
        - Jail
        - name: Person
          parent: Imbox
          contact_type: person
    labels:
      mailroom_error: "@MailroomError"
      mailroom_warning: "@MailroomWarning"
      warnings_enabled: true
    logging:
      level: info
```

Note: Auth vars (JMAP_TOKEN, CARDDAV_USERNAME, CARDDAV_PASSWORD) belong in Secret, not ConfigMap.

**k8s/deployment.yaml** — Change from envFrom configMapRef to volume mount:
- Remove `- configMapRef: name: mailroom-config` from `envFrom`
- Keep `- secretRef: name: mailroom-secrets` in `envFrom`
- Add `volumeMounts` to the container spec:
  ```yaml
  volumeMounts:
    - name: config
      mountPath: /app/config.yaml
      subPath: config.yaml
      readOnly: true
  ```
- Add `volumes` to the pod spec:
  ```yaml
  volumes:
    - name: config
      configMap:
        name: mailroom-config
  ```
  </action>
  <verify>
    <automated>python -c "import yaml; yaml.safe_load(open('k8s/configmap.yaml')); yaml.safe_load(open('k8s/deployment.yaml')); print('K8s YAML valid')"</automated>
  </verify>
  <done>ConfigMap contains embedded config.yaml. Deployment uses volume mount for config and secretRef-only for envFrom. Both files are valid YAML.</done>
</task>

</tasks>

<verification>
```bash
# All tests pass with new access paths
pytest tests/ -x -v

# Verify no stale flat field accesses remain in src/ (except auth and computed properties)
# These should return 0 matches:
grep -rn "settings\.poll_interval\|settings\.debounce_seconds\|settings\.log_level\|settings\.label_mailroom_error\|settings\.label_mailroom_warning\|settings\.warnings_enabled\|settings\.screener_mailbox\|settings\.triage_categories" src/mailroom/ | grep -v "\.pyc" | grep -v "__pycache__"

# K8s files are valid YAML
python -c "import yaml; yaml.safe_load(open('k8s/configmap.yaml')); yaml.safe_load(open('k8s/deployment.yaml')); print('OK')"
```
</verification>

<success_criteria>
- All source code uses nested config paths (settings.polling.interval, settings.labels.mailroom_error, etc.)
- No stale flat field accesses remain in src/ for migrated fields
- K8s ConfigMap has embedded config.yaml file content
- K8s Deployment has volume mount for config.yaml and secretRef-only envFrom
- All unit tests pass
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-02-SUMMARY.md`
</output>
