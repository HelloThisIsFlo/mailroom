---
phase: 09.1-migrate-from-env-var-config-to-config-yaml
plan: 05
type: execute
wave: 1
depends_on: []
files_modified:
  - src/mailroom/core/config.py
autonomous: true
requirements: []
gap_closure: true

must_haves:
  truths:
    - "Missing config.yaml exits with exactly one error message printed to stderr"
  artifacts:
    - path: "src/mailroom/core/config.py"
      provides: "_resolve_config_path raises SystemExit(1) instead of SystemExit(string)"
      contains: "raise SystemExit(1)"
  key_links:
    - from: "_resolve_config_path"
      to: "stderr output"
      via: "explicit print() only — SystemExit arg is int, not string"
      pattern: "raise SystemExit\\(1\\)"
---

<objective>
Fix the double error message printed when config.yaml is missing.

Purpose: The user reported the missing-config error message prints twice. Root cause is that `_resolve_config_path` calls `print(..., file=sys.stderr)` AND then `raise SystemExit(string_arg)` — Python automatically prints a SystemExit string argument to stderr, causing duplication. Changing the SystemExit arg to `1` (int) silences the auto-print while keeping the explicit print as the sole user-visible message.

Output: `src/mailroom/core/config.py` updated so the error prints exactly once.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
</context>

<tasks>

<task type="auto">
  <name>Task 1: Fix double-print in _resolve_config_path</name>
  <files>src/mailroom/core/config.py</files>
  <action>
    In `_resolve_config_path` (around line 318), change:

        raise SystemExit(
            f"Config file not found: {path.resolve()}\n"
            f"Copy config.yaml.example to config.yaml and edit it:\n"
            f"  cp config.yaml.example config.yaml"
        )

    to:

        raise SystemExit(1)

    The explicit `print(..., file=sys.stderr)` on the lines immediately above already outputs the full message. Passing a string to SystemExit causes Python to auto-print that string to stderr as well, producing the duplication. Passing an int suppresses the auto-print while still exiting with a non-zero code.

    Do not touch the `print()` call above it — that remains the sole output mechanism.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -c "
import sys, os, tempfile, subprocess
# Run _resolve_config_path with no config.yaml present
result = subprocess.run(
    [sys.executable, '-c',
     'import os, sys; os.chdir(\"/tmp\"); from mailroom.core.config import _resolve_config_path; _resolve_config_path()'],
    capture_output=True, text=True, env={**os.environ, 'PYTHONPATH': 'src'}
)
lines = [l for l in result.stderr.strip().splitlines() if l.strip()]
print('stderr lines:', lines)
assert result.returncode != 0, 'Should exit non-zero'
assert len(lines) == 3, f'Expected 3 stderr lines (message), got {len(lines)}: {lines}'
assert 'Error: Config file not found' in lines[0], f'Unexpected first line: {lines[0]}'
print('PASS: exactly one error message block, no duplication')
"
    </automated>
  </verify>
  <done>Running without config.yaml prints the error message exactly once (3 lines: "Error: Config file not found...", "Copy...", "  cp ...") and exits non-zero. No duplicate output.</done>
</task>

</tasks>

<verification>
pytest passes: `cd /Users/flo/Work/Private/Dev/Services/mailroom && pytest -x -q` — all tests pass (the change has no effect on normal operation; tests use the autouse fixture that provides config.yaml in tmp_path).
</verification>

<success_criteria>
- `_resolve_config_path` contains `raise SystemExit(1)` (not a string arg)
- Missing config.yaml scenario prints the error message exactly once
- Full pytest suite passes
</success_criteria>

<output>
After completion, create `.planning/phases/09.1-migrate-from-env-var-config-to-config-yaml/09.1-05-SUMMARY.md`
</output>
