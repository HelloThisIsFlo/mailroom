---
phase: 06-configurable-categories
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/mailroom/core/config.py
  - tests/test_config.py
autonomous: true
requirements:
  - CONFIG-01
  - CONFIG-02
  - CONFIG-03
  - CONFIG-06

must_haves:
  truths:
    - "TriageCategory model accepts name-only input and derives label, contact_group, destination_mailbox"
    - "ResolvedCategory is a frozen dataclass with all fields concrete (no Optional)"
    - "Default categories match v1.0 behavior: Imbox (destination Inbox), Feed, Paper Trail, Jail, Person (parent Imbox, contact_type person)"
    - "Validation rejects duplicate names, empty list, missing name, invalid contact_type, bad parent references, circular parent chains"
    - "Validation collects ALL errors and reports them at once (not fail-fast)"
    - "Parent inheritance: children inherit contact_group and destination_mailbox from parent"
    - "Pydantic-settings natively parses MAILROOM_TRIAGE_CATEGORIES JSON env var into list[TriageCategory]"
  artifacts:
    - path: "src/mailroom/core/config.py"
      provides: "TriageCategory model, ResolvedCategory dataclass, _default_categories factory, derivation functions, resolve_and_validate_categories logic"
      contains: "class TriageCategory"
    - path: "tests/test_config.py"
      provides: "TDD tests for category model, derivation rules, validation, defaults, JSON parsing"
      contains: "TriageCategory"
  key_links:
    - from: "src/mailroom/core/config.py"
      to: "TriageCategory -> ResolvedCategory"
      via: "resolve_categories function or model_validator"
      pattern: "ResolvedCategory.*name.*label.*contact_group"
---

<objective>
TDD: Build the TriageCategory input model, ResolvedCategory output dataclass, derivation rules, default factory, and validation logic.

Purpose: Establish the foundational data models that replace the 9 hardcoded label/group fields. This is pure business logic with clear I/O -- perfect for TDD. The models and validation logic are self-contained and can be tested independently before wiring into MailroomSettings.

Output: TriageCategory model, ResolvedCategory dataclass, _default_categories() factory, derivation functions, and a resolve+validate function -- all with comprehensive tests.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-configurable-categories/06-CONTEXT.md
@.planning/phases/06-configurable-categories/06-RESEARCH.md
@src/mailroom/core/config.py
@tests/test_config.py

<interfaces>
<!-- Current config.py exports that Plan 02 will consume. This plan ADDS new models alongside existing code. -->

From src/mailroom/core/config.py (current):
```python
class MailroomSettings(BaseSettings):
    # 9 individual label/group fields (to be removed in Plan 02)
    label_to_imbox: str = "@ToImbox"
    label_to_feed: str = "@ToFeed"
    # ... etc

    @property
    def triage_labels(self) -> list[str]: ...
    @property
    def label_to_group_mapping(self) -> dict[str, dict[str, str]]: ...
    @property
    def required_mailboxes(self) -> list[str]: ...
    @property
    def contact_groups(self) -> list[str]: ...
```

New models to create (this plan):
```python
class TriageCategory(BaseModel):
    name: str
    label: str | None = None
    contact_group: str | None = None
    destination_mailbox: str | None = None
    contact_type: Literal["company", "person"] = "company"
    parent: str | None = None

@dataclass(frozen=True)
class ResolvedCategory:
    name: str
    label: str
    contact_group: str
    destination_mailbox: str
    contact_type: str
    parent: str | None

def _default_categories() -> list[TriageCategory]: ...
def resolve_categories(categories: list[TriageCategory]) -> list[ResolvedCategory]: ...
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: TDD the TriageCategory model, ResolvedCategory, derivation rules, and defaults</name>
  <files>
    src/mailroom/core/config.py
    tests/test_config.py
  </files>
  <action>
**RED phase:** Add tests to `tests/test_config.py` for the new models. Keep ALL existing tests intact -- they still pass against the existing MailroomSettings. Add a new test class or section at the bottom.

Tests to write (import TriageCategory, ResolvedCategory, _default_categories from mailroom.core.config):

1. **TriageCategory name-only input:**
   - `TriageCategory(name="Receipts")` succeeds, all optional fields are None, contact_type defaults to "company"
   - `TriageCategory(name="")` raises ValidationError (empty name)
   - `TriageCategory(name="  ")` raises ValidationError (whitespace-only name)
   - `TriageCategory(name="  Receipts  ")` strips to "Receipts"

2. **Derivation rules** (test via a standalone `resolve_categories` function or equivalent):
   - Name "Receipts" -> label "@ToReceipts", group "Receipts", mailbox "Receipts"
   - Name "Paper Trail" -> label "@ToPaperTrail" (spaces removed), group "Paper Trail", mailbox "Paper Trail"
   - Explicit overrides: `TriageCategory(name="Imbox", destination_mailbox="Inbox")` -> destination_mailbox is "Inbox" (not derived "Imbox")

3. **Default factory:**
   - `_default_categories()` returns 5 TriageCategory instances
   - Names are: "Imbox", "Feed", "Paper Trail", "Jail", "Person"
   - Imbox has `destination_mailbox="Inbox"` override
   - Person has `parent="Imbox"` and `contact_type="person"`

4. **ResolvedCategory is frozen:**
   - ResolvedCategory fields are all concrete (no None except parent)
   - Attempting to mutate a field raises FrozenInstanceError/dataclasses.FrozenInstanceError

5. **Parent inheritance:**
   - Person (parent="Imbox") inherits contact_group="Imbox" and destination_mailbox="Inbox" from resolved Imbox
   - Child with explicit contact_group override does NOT inherit parent's group
   - Parent appears after child in list -- still resolves correctly (two-pass resolution)

Run tests -- they must FAIL (RED).

**GREEN phase:** Implement in `src/mailroom/core/config.py`:

1. Add `TriageCategory(BaseModel)` with `name` (required), `label`, `contact_group`, `destination_mailbox` (all `str | None = None`), `contact_type: Literal["company", "person"] = "company"`, `parent: str | None = None`. Add `@field_validator("name")` that strips whitespace and rejects empty.

2. Add `ResolvedCategory` frozen dataclass with all fields concrete: `name: str`, `label: str`, `contact_group: str`, `destination_mailbox: str`, `contact_type: str`, `parent: str | None`.

3. Add derivation functions:
   - `derive_label(name: str) -> str`: `f"@To{''.join(name.split())}"`
   - `derive_contact_group(name: str) -> str`: identity (return name)
   - `derive_destination_mailbox(name: str) -> str`: identity (return name)

4. Add `_default_categories() -> list[TriageCategory]` returning the 5 v1.0 defaults. Key overrides: Imbox gets `destination_mailbox="Inbox"`, Person gets `parent="Imbox"` and `contact_type="person"`.

5. Add `resolve_categories(categories: list[TriageCategory]) -> list[ResolvedCategory]` that:
   - First pass: resolve each category's own fields (derive from name if None, use explicit if provided)
   - Second pass: apply parent inheritance (children inherit parent's contact_group and destination_mailbox unless explicitly overridden)
   - Returns list of ResolvedCategory

Run tests -- they must PASS (GREEN).

**REFACTOR:** Clean up if needed. Ensure all functions have docstrings. Run tests again to confirm they still pass.

**Important:** Do NOT modify MailroomSettings yet. Do NOT remove any existing fields. The new models are ADDITIVE in this plan. MailroomSettings integration happens in Plan 02.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -m pytest tests/test_config.py -x -v 2>&1 | tail -30</automated>
  </verify>
  <done>
    - TriageCategory model validates name (strips, rejects empty), accepts optional overrides, defaults contact_type to "company"
    - ResolvedCategory is a frozen dataclass with all concrete fields
    - Derivation rules produce correct label/group/mailbox from name
    - _default_categories() returns 5 categories matching v1.0 behavior
    - Parent inheritance resolves correctly regardless of declaration order
    - All new tests pass alongside existing tests (no regressions)
  </done>
</task>

<task type="auto">
  <name>Task 2: TDD the validation logic (duplicate names, parent errors, circular chains, shared groups)</name>
  <files>
    src/mailroom/core/config.py
    tests/test_config.py
  </files>
  <action>
**RED phase:** Add validation tests to `tests/test_config.py`. Test a standalone `validate_categories` function (or embed validation into `resolve_categories`).

Tests to write:

1. **Empty list:** `resolve_categories([])` raises ValueError with "at least one triage category"
2. **Duplicate names:** Two categories named "Feed" -> ValueError with "Duplicate category name" mentioning "Feed"
3. **Invalid contact_type:** Already handled by Pydantic Literal -- verify `TriageCategory(name="X", contact_type="invalid")` raises ValidationError
4. **Non-existent parent:** `TriageCategory(name="Child", parent="Ghost")` -> ValueError with "non-existent parent 'Ghost'"
5. **Circular parent chain:** A -> B -> A -> ValueError with "Circular parent chain"
6. **Self-referencing parent:** A has parent="A" -> ValueError with "Circular parent chain"
7. **Shared contact groups without parent relationship:** Two unrelated categories with same explicit `contact_group` -> ValueError with message about shared groups
8. **Shared contact groups WITH parent relationship:** Parent and child sharing contact_group is allowed (no error)
9. **All errors at once:** Categories with BOTH duplicate names AND bad parent reference -> ValueError message contains BOTH errors
10. **Duplicate labels after derivation:** Two categories that derive to the same label (e.g., "PaperTrail" and custom with label="@ToPaperTrail") -> ValueError
11. **Valid custom category:** `[TriageCategory(name="Receipts")]` resolves successfully (single custom category, no defaults mixed in)
12. **Default config shown in error message:** When validation fails, the error message includes the default configuration JSON for reference

Run tests -- they must FAIL (RED).

**GREEN phase:** Add validation logic to `resolve_categories` (or a separate `validate_categories` function called by `resolve_categories`):

1. Collect errors into `errors: list[str]` -- never fail-fast
2. Check empty list
3. Check duplicate names (case-sensitive)
4. Check parent references exist
5. Check circular parent chains (visited-set walk)
6. Check duplicate labels after derivation
7. Check shared contact groups: two categories with same resolved contact_group are only allowed if one is a child of the other via parent field
8. If errors: raise ValueError with all errors listed, plus default config JSON for reference (`json.dumps` of `_default_categories()` model_dump)

Run tests -- they must PASS (GREEN).

**REFACTOR:** Extract error collection into a clean, readable structure. Ensure error messages are clear and actionable.

**Important:** The validation function should be standalone (not inside MailroomSettings yet). Plan 02 wires it into the model_validator.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -m pytest tests/test_config.py -x -v 2>&1 | tail -40</automated>
  </verify>
  <done>
    - Empty category list rejected with clear error
    - Duplicate category names detected and reported
    - Invalid parent references caught
    - Circular parent chains detected (including self-reference)
    - Shared contact groups without parent relationship flagged
    - Duplicate labels after derivation flagged
    - All errors collected and reported at once (not fail-fast)
    - Error message includes default config JSON for reference
    - All tests pass (new validation tests + all existing tests)
  </done>
</task>

</tasks>

<verification>
- All existing `test_config.py` tests still pass (no regressions)
- New TriageCategory model tests cover: name validation, optional fields, contact_type default
- New derivation tests cover: name-to-label, name-to-group, name-to-mailbox, explicit overrides
- New default factory tests cover: 5 categories, correct overrides (Imbox destination, Person parent)
- New parent inheritance tests cover: inherit group+mailbox, explicit override, out-of-order declaration
- New validation tests cover: empty list, duplicate names, bad parent, circular chains, shared groups, duplicate labels, all-at-once reporting
- `python -m pytest tests/test_config.py -x -v` passes with 0 failures
</verification>

<success_criteria>
1. TriageCategory, ResolvedCategory, _default_categories, resolve_categories are defined and exported from config.py
2. All derivation rules match CONTEXT.md decisions: label = @To{NameNoSpaces}, group = Name, mailbox = Name
3. Validation catches all 6+ error types and reports them together
4. Default categories produce the exact same behavior as v1.0 (Imbox->Inbox, Person inherits from Imbox)
5. All tests pass: existing + new = green
</success_criteria>

<output>
After completion, create `.planning/phases/06-configurable-categories/06-01-SUMMARY.md`
</output>
