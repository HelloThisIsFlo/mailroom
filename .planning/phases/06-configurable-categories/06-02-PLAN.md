---
phase: 06-configurable-categories
plan: 02
type: execute
wave: 2
depends_on:
  - 06-01
files_modified:
  - src/mailroom/core/config.py
  - src/mailroom/workflows/screener.py
  - tests/conftest.py
  - tests/test_config.py
  - tests/test_screener_workflow.py
autonomous: true
requirements:
  - CONFIG-04
  - CONFIG-05

must_haves:
  truths:
    - "MailroomSettings uses triage_categories list field with _default_categories factory (not 9 individual fields)"
    - "model_validator calls resolve_categories to build resolved categories and label-to-category lookup"
    - "triage_labels, required_mailboxes, contact_groups properties derive from resolved categories (no hardcoded refs)"
    - "label_to_category_mapping returns dict[str, ResolvedCategory] (renamed from label_to_group_mapping)"
    - "ScreenerWorkflow uses category.contact_group and category.contact_type (not dict key access)"
    - "Zero-config deployment still works: no MAILROOM_TRIAGE_CATEGORIES env var = v1.0 defaults"
    - "Custom categories via MAILROOM_TRIAGE_CATEGORIES JSON env var work end-to-end"
    - "All tests pass with updated fixtures and assertions"
  artifacts:
    - path: "src/mailroom/core/config.py"
      provides: "MailroomSettings with triage_categories field, model_validator, updated properties"
      contains: "triage_categories"
    - path: "src/mailroom/workflows/screener.py"
      provides: "Updated consumer code using ResolvedCategory attributes"
      contains: "label_to_category_mapping"
    - path: "tests/conftest.py"
      provides: "Updated mock_settings and mock_mailbox_ids fixtures"
      contains: "mock_settings"
    - path: "tests/test_config.py"
      provides: "Updated tests for new config shape plus custom category tests"
      contains: "triage_categories"
    - path: "tests/test_screener_workflow.py"
      provides: "Updated workflow tests using new config shape"
      contains: "label_to_category_mapping"
  key_links:
    - from: "src/mailroom/core/config.py"
      to: "src/mailroom/workflows/screener.py"
      via: "settings.label_to_category_mapping[label_name] -> ResolvedCategory"
      pattern: "label_to_category_mapping"
    - from: "src/mailroom/core/config.py"
      to: "src/mailroom/__main__.py"
      via: "settings.required_mailboxes, settings.contact_groups"
      pattern: "required_mailboxes|contact_groups"
    - from: "tests/conftest.py"
      to: "tests/test_screener_workflow.py"
      via: "mock_settings fixture providing MailroomSettings with new shape"
      pattern: "mock_settings"
---

<objective>
Wire the new category models into MailroomSettings, update all consumers, and rewrite tests for the new config shape.

Purpose: Replace the 9 hardcoded label/group fields with the single `triage_categories` list, wire the model_validator, update the 3 consumer sites in screener.py, and ensure all tests reflect the new structure. After this plan, the entire codebase uses the data-driven category system.

Output: Fully integrated config with no hardcoded category references remaining in service logic. All tests green.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/06-configurable-categories/06-CONTEXT.md
@.planning/phases/06-configurable-categories/06-RESEARCH.md
@.planning/phases/06-configurable-categories/06-01-SUMMARY.md
@src/mailroom/core/config.py
@src/mailroom/workflows/screener.py
@src/mailroom/__main__.py
@tests/conftest.py
@tests/test_config.py
@tests/test_screener_workflow.py

<interfaces>
<!-- From Plan 01 (must exist before this plan runs) -->

From src/mailroom/core/config.py (added by Plan 01):
```python
class TriageCategory(BaseModel):
    name: str
    label: str | None = None
    contact_group: str | None = None
    destination_mailbox: str | None = None
    contact_type: Literal["company", "person"] = "company"
    parent: str | None = None

@dataclass(frozen=True)
class ResolvedCategory:
    name: str
    label: str
    contact_group: str
    destination_mailbox: str
    contact_type: str
    parent: str | None

def _default_categories() -> list[TriageCategory]: ...
def resolve_categories(categories: list[TriageCategory]) -> list[ResolvedCategory]: ...
```

<!-- Current consumer sites in screener.py (lines 303-305, 362-363) -->

From src/mailroom/workflows/screener.py:
```python
# Line 303-305 (_process_sender):
mapping = self._settings.label_to_group_mapping[label_name]
group_name = mapping["group"]
contact_type = mapping["contact_type"]

# Line 362-363 (_get_destination_mailbox_ids):
mapping = self._settings.label_to_group_mapping[label_name]
destination_mailbox = mapping["destination_mailbox"]
```

<!-- Current __main__.py consumer sites (no changes needed) -->

From src/mailroom/__main__.py:
```python
# Line 98: mailbox_ids = jmap.resolve_mailboxes(settings.required_mailboxes)
# Line 101: carddav.validate_groups(settings.contact_groups)
# These call properties -- property internals change but call sites don't.
```
</interfaces>
</context>

<tasks>

<task type="auto">
  <name>Task 1: Integrate triage_categories into MailroomSettings and update properties</name>
  <files>
    src/mailroom/core/config.py
    src/mailroom/workflows/screener.py
  </files>
  <action>
**In `src/mailroom/core/config.py`:**

1. **Add imports** at top: `from pydantic import Field, model_validator` and `from typing_extensions import Self` (if not already present). Add `import json` for error message formatting.

2. **Replace the 9 individual fields** on MailroomSettings:
   Remove: `label_to_imbox`, `label_to_feed`, `label_to_paper_trail`, `label_to_jail`, `label_to_person`, `group_imbox`, `group_feed`, `group_paper_trail`, `group_jail`.

   Add: `triage_categories: list[TriageCategory] = Field(default_factory=_default_categories)`

   Keep unchanged: `jmap_token`, `carddav_username`, `carddav_password`, `poll_interval`, `log_level`, `label_mailroom_error`, `label_mailroom_warning`, `warnings_enabled`, `screener_mailbox`.

3. **Add model_validator** to MailroomSettings:
   ```python
   @model_validator(mode='after')
   def resolve_and_validate_categories(self) -> Self:
       resolved = resolve_categories(self.triage_categories)
       object.__setattr__(self, '_resolved_categories', resolved)
       object.__setattr__(self, '_label_to_category', {r.label: r for r in resolved})
       return self
   ```
   Use `object.__setattr__` because Pydantic models are semi-frozen after init.

4. **Update properties:**

   `triage_labels` -> return `[c.label for c in self._resolved_categories]`

   Rename `label_to_group_mapping` -> `label_to_category_mapping`, return type `dict[str, ResolvedCategory]`:
   ```python
   @property
   def label_to_category_mapping(self) -> dict[str, ResolvedCategory]:
       return dict(self._label_to_category)
   ```

   `required_mailboxes` -> compute from resolved categories:
   ```python
   @property
   def required_mailboxes(self) -> list[str]:
       mailboxes = {"Inbox", self.screener_mailbox, self.label_mailroom_error}
       for c in self._resolved_categories:
           mailboxes.add(c.label)
           mailboxes.add(c.destination_mailbox)
       if self.warnings_enabled:
           mailboxes.add(self.label_mailroom_warning)
       return sorted(mailboxes)  # sorted for deterministic output
   ```

   `contact_groups` -> compute from resolved categories:
   ```python
   @property
   def contact_groups(self) -> list[str]:
       return sorted({c.contact_group for c in self._resolved_categories})
   ```

5. **Add model_config update:** Add `arbitrary_types_allowed=True` to SettingsConfigDict if needed for storing private attributes with `object.__setattr__`.

**In `src/mailroom/workflows/screener.py`:**

Update the 3 consumer sites:

1. **_process_sender** (around line 303-305):
   ```python
   # BEFORE:
   mapping = self._settings.label_to_group_mapping[label_name]
   group_name = mapping["group"]
   contact_type = mapping["contact_type"]

   # AFTER:
   category = self._settings.label_to_category_mapping[label_name]
   group_name = category.contact_group
   contact_type = category.contact_type
   ```

2. **_get_destination_mailbox_ids** (around line 362-363):
   ```python
   # BEFORE:
   mapping = self._settings.label_to_group_mapping[label_name]
   destination_mailbox = mapping["destination_mailbox"]

   # AFTER:
   category = self._settings.label_to_category_mapping[label_name]
   destination_mailbox = category.destination_mailbox
   ```

**Verify no other references to old field names remain:**
- grep for `label_to_imbox`, `label_to_feed`, `label_to_paper_trail`, `label_to_jail`, `label_to_person`, `group_imbox`, `group_feed`, `group_paper_trail`, `group_jail`, `label_to_group_mapping` in all `.py` files (excluding test files for now -- handled in Task 2)
- The only remaining references should be in test files (updated in Task 2)
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -c "from mailroom.core.config import MailroomSettings; import os; os.environ['MAILROOM_JMAP_TOKEN']='test'; s=MailroomSettings(); print('labels:', s.triage_labels); print('groups:', s.contact_groups); print('mapping keys:', list(s.label_to_category_mapping.keys())); print('required:', sorted(s.required_mailboxes))" 2>&1</automated>
  </verify>
  <done>
    - MailroomSettings has triage_categories field with default factory (no individual label/group fields)
    - model_validator resolves categories and builds lookup at construction time
    - triage_labels returns 5 labels derived from default categories
    - label_to_category_mapping returns dict[str, ResolvedCategory] (renamed)
    - required_mailboxes and contact_groups computed from resolved categories
    - screener.py uses category.contact_group and category.contact_type (typed access)
    - No hardcoded category references remain in config.py or screener.py service logic
  </done>
</task>

<task type="auto">
  <name>Task 2: Update all test files for new config shape and add custom category test</name>
  <files>
    tests/conftest.py
    tests/test_config.py
    tests/test_screener_workflow.py
  </files>
  <action>
**In `tests/conftest.py`:**

1. Update `mock_settings` fixture: The fixture already sets env vars and creates MailroomSettings(). Since defaults now come from `_default_categories()`, it should still work. Verify it produces the right shape. No env var changes needed for defaults.

2. Update `mock_mailbox_ids` fixture: Verify it includes all mailbox names that `required_mailboxes` now returns. The set should be the same as v1.0 defaults since we haven't changed the default categories. If sorted order changes, update accordingly.

**In `tests/test_config.py`:**

1. **Update `MAILROOM_ENV_VARS` list:** Remove the old individual label/group env vars. Add `MAILROOM_TRIAGE_CATEGORIES` to the clean list.

2. **Rewrite `test_defaults`:** Instead of checking individual `label_to_imbox` etc. fields, verify:
   - `settings.triage_categories` has 5 entries
   - Default names are Imbox, Feed, Paper Trail, Jail, Person
   - `settings.triage_labels` matches v1.0 labels

3. **Rewrite `test_triage_labels_property`:** Verify the 5 default labels are returned.

4. **Rewrite `test_label_group_mapping` -> `test_label_category_mapping`:** Use `settings.label_to_category_mapping` and check ResolvedCategory attributes (`.contact_group`, `.contact_type`, `.destination_mailbox`) instead of dict keys.

5. **Update `test_destination_mailbox_in_mapping`:** Access `.destination_mailbox` attribute instead of `["destination_mailbox"]`.

6. **Update Phase 3.1 tests:**
   - `test_label_to_person_default` -> verify via `settings.label_to_category_mapping["@ToPerson"]`
   - `test_toperson_mapping_entry` -> use `.contact_type`, `.contact_group`, `.destination_mailbox`
   - `test_existing_mapping_entries_have_company_contact_type` -> iterate label_to_category_mapping
   - `test_toperson_routes_same_as_toimbox` -> compare ResolvedCategory attributes
   - `test_mapping_has_five_entries_with_toperson` -> check `len(settings.label_to_category_mapping) == 5`

7. **Remove tests for deleted fields:** Remove or rewrite `test_env_override` for label/group env vars that no longer exist.

8. **Add custom category test (CONFIG-05):**
   ```python
   def test_custom_categories_via_env_var(monkeypatch):
       """Custom categories via MAILROOM_TRIAGE_CATEGORIES replaces all defaults."""
       monkeypatch.setenv("MAILROOM_JMAP_TOKEN", "tok")
       monkeypatch.setenv("MAILROOM_TRIAGE_CATEGORIES", json.dumps([
           {"name": "Receipts"},
           {"name": "VIP", "destination_mailbox": "Inbox"},
       ]))
       settings = MailroomSettings()
       assert len(settings.triage_categories) == 2
       assert settings.triage_labels == ["@ToReceipts", "@ToVIP"]
       mapping = settings.label_to_category_mapping
       assert mapping["@ToReceipts"].destination_mailbox == "Receipts"
       assert mapping["@ToVIP"].destination_mailbox == "Inbox"
   ```

9. **Add required_mailboxes and contact_groups derived tests:**
   - Verify `required_mailboxes` includes triage labels AND destination mailboxes from resolved categories
   - Verify `contact_groups` returns unique groups from resolved categories

**In `tests/test_screener_workflow.py`:**

1. Update any test that accesses `mock_settings.label_to_group_mapping` to use `mock_settings.label_to_category_mapping`.
2. Since `mock_settings` is a real MailroomSettings object (from conftest), it should already have the new shape. The workflow tests primarily test behavior (poll returns correct count, conflict detection, etc.) so most should pass without changes.
3. If any test mocks `settings.label_to_group_mapping` directly, update to `settings.label_to_category_mapping`.

**Final verification:** Run the entire test suite to confirm zero failures.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -m pytest tests/ -x -v 2>&1 | tail -40</automated>
  </verify>
  <done>
    - conftest.py fixtures work with new config shape
    - test_config.py tests all pass with updated assertions (no dict key access, uses ResolvedCategory attributes)
    - Custom category test proves CONFIG-05 (user can add custom categories beyond defaults)
    - test_screener_workflow.py tests pass with new label_to_category_mapping
    - Full test suite: 0 failures
    - No references to old field names (label_to_imbox, group_imbox, etc.) remain anywhere in the codebase
  </done>
</task>

</tasks>

<verification>
- `python -m pytest tests/ -x -v` -- full test suite passes with 0 failures
- `grep -rn 'label_to_imbox\|label_to_feed\|label_to_paper_trail\|label_to_jail\|label_to_person\|group_imbox\|group_feed\|group_paper_trail\|group_jail\|label_to_group_mapping' src/ tests/` returns no matches (all old references removed)
- `python -c "from mailroom.core.config import MailroomSettings; import os; os.environ['MAILROOM_JMAP_TOKEN']='t'; s=MailroomSettings(); print(s.triage_labels)"` outputs the 5 default labels
- Custom category env var parses correctly: `MAILROOM_TRIAGE_CATEGORIES='[{"name":"X"}]' MAILROOM_JMAP_TOKEN=t python -c "from mailroom.core.config import MailroomSettings; s=MailroomSettings(); print(s.triage_labels)"` outputs `['@ToX']`
</verification>

<success_criteria>
1. No hardcoded category field names remain in config.py (label_to_imbox, group_imbox, etc. all removed)
2. MailroomSettings.triage_categories is the single source of truth for all category configuration
3. label_to_category_mapping returns typed ResolvedCategory objects (not anonymous dicts)
4. screener.py uses typed attribute access (category.contact_group, not mapping["group"])
5. Zero-config deployment works: default triage_categories matches v1.0 behavior exactly
6. Custom categories work via MAILROOM_TRIAGE_CATEGORIES JSON env var
7. All tests pass across the entire test suite
</success_criteria>

<output>
After completion, create `.planning/phases/06-configurable-categories/06-02-SUMMARY.md`
</output>
