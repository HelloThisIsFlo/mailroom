---
phase: 03.1-person-contact-type-with-toperson-label
verified: 2026-02-25T03:00:00Z
status: passed
score: 5/5 success criteria verified
re_verification: false
human_verification:
  - test: "Run python human-tests/test_11_person_contact.py against live Fastmail"
    expected: "Contact for test sender appears in Fastmail Contacts as a PERSON (first/last name, no company icon)"
    why_human: "vCard field structure is verified by unit tests and the human test script validates against live Fastmail, but Fastmail UI rendering (person icon vs company icon) can only be confirmed visually"
  - test: "Run python human-tests/test_12_company_contact.py against live Fastmail"
    expected: "Contact for test sender appears in Fastmail Contacts as a COMPANY (organization icon, ORG field displayed)"
    why_human: "Same reason as above -- Fastmail UI rendering requires visual confirmation"
---

# Phase 3.1: Person Contact Type with @ToPerson Label Verification Report

**Phase Goal:** Default new contacts to company type (ORG field, empty N). Add @ToPerson triage label that creates person-type contacts (FN + N with first/last name) routed to Imbox group. Introduce @MailroomWarning label for non-blocking alerts (name mismatch on existing contacts).
**Verified:** 2026-02-25T03:00:00Z
**Status:** passed
**Re-verification:** No -- initial verification

## Goal Achievement

### Observable Truths (Success Criteria)

| # | Truth | Status | Evidence |
|---|-------|--------|----------|
| 1 | Triaging with @ToImbox creates a company-type contact (FN + ORG, empty N) | VERIFIED | `create_contact` with `contact_type="company"` sets `card.add("org").value = [name]` and `card.add("n").value = vobject.vcard.Name()` (empty N). 14 carddav tests pass including `test_create_contact_company`. |
| 2 | Triaging with @ToPerson creates a person-type contact (FN + N with first/last, no ORG) routed to Imbox group | VERIFIED | `create_contact` with `contact_type="person"` calls `HumanName(name)` and sets N with given/family, no ORG. Config maps `@ToPerson` to `group_imbox` with `contact_type="person"`. Workflow passes `contact_type` from mapping to `upsert_contact`. |
| 3 | @ToPerson conflicts with @ToImbox and other triage labels (flagged as @MailroomError) | VERIFIED | `_detect_conflicts` flags any sender with multiple labels. Tests `TestToPersonConflictWithToImbox` and `TestToPersonConflictWithToFeed` both PASS. Conflict detection is label-agnostic -- two different labels always conflict. |
| 4 | When @ToPerson encounters existing contact with different name, processing continues but @MailroomWarning is applied | VERIFIED | `upsert_contact` returns `name_mismatch=True` on FN mismatch. `_process_sender` checks `result.get("name_mismatch", False) and self._settings.warnings_enabled` and calls `_apply_warning_label`. Non-blocking via try/except. Tests `TestWarningLabelOnNameMismatchEnabled` and `TestWarningLabelFailureNonBlocking` PASS. |
| 5 | @MailroomWarning label is validated at startup (fail fast if missing and warnings enabled) | VERIFIED | `required_mailboxes` property conditionally appends `self.label_mailroom_warning` when `self.warnings_enabled is True`. Tests `test_startup_validates_warning_label_when_enabled` and `test_startup_succeeds_without_warning_label_when_disabled` both PASS. |

**Score:** 5/5 success criteria verified

### Required Artifacts

| Artifact | Expected | Status | Details |
|----------|----------|--------|---------|
| `src/mailroom/core/config.py` | @ToPerson label, @MailroomWarning label, warnings_enabled toggle, contact_type in mapping, required_mailboxes with conditional warning validation | VERIFIED | All 5 fields present: `label_to_person`, `label_mailroom_warning`, `warnings_enabled`, `contact_type` in all 5 mapping entries, `required_mailboxes` property with conditional append |
| `src/mailroom/clients/carddav.py` | Company/person vCard construction, NOTE append, name mismatch signal | VERIFIED | `from nameparser import HumanName` imported. `create_contact` branches on `contact_type`. `upsert_contact` appends NOTE and returns `name_mismatch` boolean. |
| `src/mailroom/workflows/screener.py` | contact_type routing, @MailroomWarning application, conditional warning validation | VERIFIED | `contact_type = mapping["contact_type"]` at line 305. `upsert_contact(..., contact_type=contact_type)` at line 324. `_apply_warning_label` method exists (lines 236-280). |
| `tests/test_carddav_client.py` | Tests for company/person contact creation, NOTE behavior | VERIFIED | Contains `test_create_contact_company` and person test counterparts. 14 new tests for Phase 3.1 behavior. |
| `tests/test_config.py` | Tests for new config fields and mapping | VERIFIED | Contains `test_label_to_person_default`, `test_toperson_mapping_entry`, `test_existing_mapping_entries_have_company_contact_type`, `test_startup_validates_warning_label_when_enabled`, etc. 10 new tests. |
| `tests/test_screener_workflow.py` | Tests for @ToPerson routing, warning label, contact_type passthrough | VERIFIED | Contains `TestContactTypePassthroughToPerson`, `TestToPersonRoutingPoll`, `TestToPersonConflictWithToImbox`, `TestWarningLabelOnNameMismatchEnabled`, etc. 19 new tests. |
| `human-tests/test_11_person_contact.py` | Live Fastmail validation of @ToPerson person-type contact creation | VERIFIED (syntax) | File exists, parses without errors, follows standalone pattern with step-level PASS/FAIL and interactive pauses. Confirmed passing against live Fastmail per SUMMARY. |
| `human-tests/test_12_company_contact.py` | Live Fastmail validation of company-type contact creation via @ToImbox | VERIFIED (syntax) | File exists, parses without errors, follows standalone pattern. Confirmed passing against live Fastmail per SUMMARY. |

### Key Link Verification

| From | To | Via | Status | Details |
|------|----|-----|--------|---------|
| `src/mailroom/clients/carddav.py` | `nameparser.HumanName` | `from nameparser import HumanName` at line 11 | WIRED | Import present; called in `create_contact` as `HumanName(name)`. `nameparser>=1.1.3` in `pyproject.toml`. |
| `src/mailroom/core/config.py` | `src/mailroom/clients/carddav.py` | `contact_type` key in `label_to_group_mapping` consumed by workflow | WIRED | All 5 mapping entries have `contact_type` key. Workflow reads it at line 305 and passes to `upsert_contact`. |
| `src/mailroom/workflows/screener.py` | `src/mailroom/core/config.py` | `label_to_group_mapping['contact_type']` lookup in `_process_sender` | WIRED | `mapping = self._settings.label_to_group_mapping[label_name]` then `contact_type = mapping["contact_type"]` at lines 303-305. |
| `src/mailroom/workflows/screener.py` | `src/mailroom/clients/carddav.py` | `upsert_contact contact_type` parameter + `name_mismatch` return value | WIRED | `self._carddav.upsert_contact(sender, display_name, group_name, contact_type=contact_type)` at line 324. `result.get("name_mismatch", False)` at line 329. |
| `src/mailroom/workflows/screener.py` | `src/mailroom/clients/jmap.py` | `_apply_warning_label` uses same JMAP Email/set pattern as `_apply_error_label` | WIRED | `_apply_warning_label` calls `self._jmap.call([["Email/set", {...}]])` at lines 252-266, identical pattern to `_apply_error_label`. |
| `human-tests/test_11_person_contact.py` | `src/mailroom/workflows/screener.py` | Exercises full poll cycle with @ToPerson label | WIRED | Imports and calls `workflow.poll()` at line 130. |
| `human-tests/test_12_company_contact.py` | `src/mailroom/workflows/screener.py` | Exercises full poll cycle with @ToImbox label | WIRED | Imports and calls `workflow.poll()` at line 130. |

### Requirements Coverage

The plans declare `CDAV-03 (extended)` and `TRIAGE-02 (extended)` as requirements. These are extensions of existing requirements already marked complete in earlier phases.

| Requirement | Source Plan | Description | Status | Evidence |
|-------------|------------|-------------|--------|----------|
| CDAV-03 (extended) | 03.1-01-PLAN, 03.1-03-PLAN | Service can create a new contact vCard for a sender -- extended to support company/person contact types (ORG + empty N vs N with first/last) | SATISFIED | `create_contact(contact_type=...)` in `carddav.py` fully implemented and tested. 14 new carddav tests pass. |
| TRIAGE-02 (extended) | 03.1-02-PLAN, 03.1-03-PLAN | For each triaged email: extract sender, create/update contact -- extended with @ToPerson label, contact_type routing, and @MailroomWarning on name mismatch | SATISFIED | `_process_sender` passes `contact_type`, `_apply_warning_label` is implemented and non-blocking. 19 new workflow tests pass. |

**Note on REQUIREMENTS.md traceability table:** The traceability table maps CDAV-03 only to Phase 2 and TRIAGE-02 only to Phase 3. Phase 3.1 is not listed in the traceability table. This is a documentation gap only -- the implementation is present and tested. The REQUIREMENTS.md should be updated to include Phase 3.1's extensions, but this does not block goal achievement.

### Anti-Patterns Found

No blockers or stubs found.

| File | Line | Pattern | Severity | Impact |
|------|------|---------|----------|--------|
| None | - | - | - | - |

Scanned files for TODO/FIXME/placeholder, empty returns, and console.log-only implementations. None found in modified files.

### Human Verification Required

The automated checks confirm all unit tests pass (180/180) and human test scripts parse cleanly. The SUMMARY reports both test_11 and test_12 were run against live Fastmail and confirmed passing. However, Fastmail UI rendering (person icon vs company icon) is a visual behavior that should be re-confirmed if the codebase changes.

#### 1. Person Contact UI Rendering

**Test:** Run `python human-tests/test_11_person_contact.py` against live Fastmail, apply @ToPerson to a person's email, follow prompts.
**Expected:** Contact appears in Fastmail Contacts with person icon (not company), first/last name displayed, no organization name.
**Why human:** Fastmail's contact type rendering (person vs company icon) depends on vCard N and ORG field interpretation by the Fastmail UI. Unit tests verify the vCard fields are correct, but only a human can confirm the visual outcome.

#### 2. Company Contact UI Rendering

**Test:** Run `python human-tests/test_12_company_contact.py` against live Fastmail, apply @ToImbox to a company/newsletter sender's email, follow prompts.
**Expected:** Contact appears in Fastmail Contacts with company/organization icon, organization name displayed (not a person name).
**Why human:** Same reason as above.

### Gaps Summary

No gaps. All 5 success criteria verified against the actual codebase:

1. Company-type vCard construction (ORG + empty N) -- fully implemented in `carddav.py`
2. Person-type vCard construction (N first/last via nameparser, no ORG) -- fully implemented
3. @ToPerson conflict detection -- handled by existing `_detect_conflicts` logic (label-agnostic)
4. @MailroomWarning on name mismatch -- implemented in `_process_sender` via `_apply_warning_label`
5. @MailroomWarning startup validation -- implemented in `required_mailboxes` property

All 180 tests pass. All commits verified in git log (d588674, 0315310, c530187, 1c34c6a, 4f3599f). All key links wired. Human test scripts exist and have been confirmed against live Fastmail per SUMMARY.md.

---

_Verified: 2026-02-25T03:00:00Z_
_Verifier: Claude (gsd-verifier)_
