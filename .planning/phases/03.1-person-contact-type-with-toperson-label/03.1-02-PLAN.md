---
phase: 03.1-person-contact-type-with-toperson-label
plan: 02
type: tdd
wave: 2
depends_on: ["03.1-01"]
files_modified:
  - src/mailroom/workflows/screener.py
  - tests/test_screener_workflow.py
autonomous: true
requirements:
  - "TRIAGE-02 (extended)"

must_haves:
  truths:
    - "@ToPerson label routes sender to Imbox group with person-type contact creation"
    - "@ToPerson + @ToImbox on same sender triggers @MailroomError (conflict detection)"
    - "When @ToPerson encounters existing contact with different FN, @MailroomWarning is applied and processing continues"
    - "@MailroomWarning label is validated at startup only when warnings_enabled is True"
    - "All existing triage labels pass contact_type='company' to upsert_contact"
    - "Contact type from label_to_group_mapping is passed through to CardDAV create_contact"
  artifacts:
    - path: "src/mailroom/workflows/screener.py"
      provides: "contact_type routing, @MailroomWarning application, conditional warning validation"
      contains: "contact_type"
    - path: "tests/test_screener_workflow.py"
      provides: "Tests for @ToPerson routing, warning label, contact_type passthrough"
      contains: "test_toperson"
  key_links:
    - from: "src/mailroom/workflows/screener.py"
      to: "src/mailroom/core/config.py"
      via: "label_to_group_mapping['contact_type'] lookup in _process_sender"
      pattern: "contact_type"
    - from: "src/mailroom/workflows/screener.py"
      to: "src/mailroom/clients/carddav.py"
      via: "upsert_contact contact_type parameter + name_mismatch return value"
      pattern: "name_mismatch"
    - from: "src/mailroom/workflows/screener.py"
      to: "src/mailroom/clients/jmap.py"
      via: "_apply_warning_label uses same JMAP Email/set pattern as _apply_error_label"
      pattern: "_apply_warning_label"
---

<objective>
Wire @ToPerson contact type routing through the screener workflow: pass contact_type from config mapping to CardDAV upsert, apply @MailroomWarning on name mismatches, and add conditional startup validation for the warning label.

Purpose: Connects the config and CardDAV changes from Plan 01 into the triage pipeline so the end-to-end flow works: @ToPerson label -> person-type contact created -> warnings applied when needed.

Output: Updated screener.py with contact_type routing and warning support, comprehensive tests for all new behavior paths.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-CONTEXT.md
@.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-RESEARCH.md
@.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-01-SUMMARY.md
@src/mailroom/workflows/screener.py
@src/mailroom/core/config.py
@src/mailroom/clients/carddav.py
@tests/test_screener_workflow.py
@tests/conftest.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Failing tests for @ToPerson routing, @MailroomWarning, and contact_type passthrough</name>
  <files>
    tests/test_screener_workflow.py
  </files>
  <action>
**Contact type passthrough tests:**
- Test `_process_sender` with @ToImbox label: `upsert_contact` called with `contact_type="company"`
- Test `_process_sender` with @ToPerson label: `upsert_contact` called with `contact_type="person"`
- Test `_process_sender` with @ToFeed label: `upsert_contact` called with `contact_type="company"`
- Test `_process_sender` with @ToJail label: `upsert_contact` called with `contact_type="company"`

**@ToPerson routing tests:**
- Test poll() with @ToPerson label processes sender, sweeps emails to Inbox destination, and removes triage label (same as @ToImbox flow)
- Test @ToPerson routes to Imbox contact group (verify `upsert_contact` group argument is "Imbox")

**@ToPerson conflict detection tests:**
- Test @ToPerson + @ToImbox on same sender produces conflict (both appear in triaged, `_detect_conflicts` separates them as conflicted)
- Test @ToPerson + @ToFeed on same sender produces conflict

**@MailroomWarning tests:**
- Test when `upsert_contact` returns `name_mismatch: True` AND `warnings_enabled` is True: `_apply_warning_label` is called (warning mailbox ID added to email via JMAP Email/set)
- Test when `upsert_contact` returns `name_mismatch: True` AND `warnings_enabled` is False: NO warning label applied
- Test when `upsert_contact` returns `name_mismatch: False`: NO warning label applied regardless of warnings_enabled
- Test `_apply_warning_label` failure is caught (non-blocking -- processing continues, only logs warning)
- Test @MailroomWarning is applied to the triggering email(s), not to all emails

**Note:** For mock setup, `upsert_contact` mock must now return dict with `name_mismatch` key. Update ALL existing `upsert_contact` mock return values in the test file to include `name_mismatch: False` to prevent regressions.

All tests MUST fail (RED). Run: `pytest tests/test_screener_workflow.py -x` -- expect failures.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && pytest tests/test_screener_workflow.py -x 2>&1 | tail -5</automated>
    <manual>Verify tests fail for the right reasons (missing contact_type parameter, missing _apply_warning_label, etc.)</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>New workflow tests exist and fail because _process_sender doesn't pass contact_type, _apply_warning_label doesn't exist, and warning-gated behavior is not implemented</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement contact_type routing, @MailroomWarning, and conditional validation in workflow</name>
  <files>
    src/mailroom/workflows/screener.py
  </files>
  <action>
**Step 1: Pass contact_type through _process_sender:**
- In `_process_sender`, extract `contact_type` from `self._settings.label_to_group_mapping[label_name]` (key: `"contact_type"`)
- Pass `contact_type=contact_type` to `self._carddav.upsert_contact()` call
- This requires `upsert_contact` to accept and forward `contact_type` to `create_contact` -- this was done in Plan 01

**Step 2: Add _apply_warning_label method:**
- Copy the pattern from `_apply_error_label` but use `self._settings.label_mailroom_warning` to resolve the warning mailbox ID
- Wrap in try/except like `_apply_error_label` -- warnings are non-blocking
- Log with `structlog` at warning level: include sender, existing contact name, email display name
- Only apply to the triggering email IDs (not all Screener emails from that sender)

**Step 3: Handle name_mismatch in _process_sender:**
- After `upsert_contact` returns, check `result.get("name_mismatch", False)`
- If `name_mismatch is True` AND `self._settings.warnings_enabled is True`:
  - Call `self._apply_warning_label(sender, email_ids)` where email_ids are the triggering email IDs
  - Log warning with sender, existing name (from result if available), email display name
- If `warnings_enabled is False` or `name_mismatch is False`: skip warning

**Step 4: Update upsert_contact call signature:**
- The `upsert_contact` call in `_process_sender` currently passes `(sender, display_name, group_name)`
- Update to pass `contact_type` as well: `self._carddav.upsert_contact(sender, display_name, group_name, contact_type=contact_type)`
- The CardDAV client's `upsert_contact` must accept and forward `contact_type` to `create_contact` -- verify this was done in Plan 01

Run: `pytest tests/ -x` -- ALL tests must pass (GREEN).
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && pytest tests/ -x</automated>
    <manual>Check that no existing tests broke (all prior tests should still pass alongside new workflow tests)</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>_process_sender passes contact_type from config mapping to upsert_contact, _apply_warning_label works (same pattern as error label), name_mismatch triggers warning when enabled, ALL tests pass</done>
</task>

</tasks>

<verification>
- `pytest tests/ -x` passes all tests (existing + new)
- All existing screener workflow tests pass without modification (backward compatible)
- @ToPerson label correctly routes through same Imbox flow as @ToImbox
- @ToPerson + @ToImbox conflict detection works (different labels -> conflicted)
- Warning label application follows same safe pattern as error label (non-blocking)
</verification>

<success_criteria>
- contact_type flows from config -> workflow -> CardDAV for all 5 triage labels
- @ToPerson creates person contacts, all other labels create company contacts
- @MailroomWarning applied on name mismatch (only when warnings_enabled=True)
- Warning failures are non-blocking (processing continues)
- Conflict detection correctly flags @ToPerson + any other triage label
- All tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-02-SUMMARY.md`
</output>
