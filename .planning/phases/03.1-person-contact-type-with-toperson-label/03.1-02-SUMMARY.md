---
phase: 03.1-person-contact-type-with-toperson-label
plan: 02
subsystem: workflows
tags: [screener, contact-type, warning-label, jmap, carddav]

# Dependency graph
requires:
  - phase: 03.1-person-contact-type-with-toperson-label
    provides: Config extensions (contact_type in mapping), CardDAV upsert_contact with contact_type and name_mismatch signal
  - phase: 03-triage-pipeline
    provides: ScreenerWorkflow with _process_sender, _apply_error_label pattern
provides:
  - contact_type routing from config mapping through workflow to CardDAV upsert
  - _apply_warning_label method (same pattern as _apply_error_label, non-blocking)
  - name_mismatch gated warning: only when mismatch=True AND warnings_enabled=True
  - Warning applied only to triggering emails (not swept emails)
  - @ToPerson routing through same Imbox flow as @ToImbox with person contact type
affects: [03.1-03-PLAN.md]

# Tech tracking
tech-stack:
  added: []
  patterns: [contact_type passthrough from config to CardDAV via workflow, non-blocking warning label application]

key-files:
  created: []
  modified:
    - src/mailroom/workflows/screener.py
    - tests/test_screener_workflow.py

key-decisions:
  - "_apply_warning_label follows same pattern as _apply_error_label (per-email Email/set, try/except non-blocking)"
  - "Warning applied only to triggering email_ids, not swept sender emails"
  - "name_mismatch check uses result.get('name_mismatch', False) for backward safety"

patterns-established:
  - "contact_type passthrough: config mapping -> _process_sender -> upsert_contact kwarg"
  - "non-blocking warning: _apply_warning_label catches all exceptions, processing continues"

requirements-completed: ["TRIAGE-02 (extended)"]

# Metrics
duration: 6min
completed: 2026-02-25
---

# Phase 3.1 Plan 02: Workflow Contact Type Routing and @MailroomWarning Summary

**contact_type flows from config mapping through _process_sender to CardDAV upsert, with @MailroomWarning on name mismatches gated by warnings_enabled**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-25T01:12:27Z
- **Completed:** 2026-02-25T01:18:52Z
- **Tasks:** 2
- **Files modified:** 2

## Accomplishments
- contact_type extracted from label_to_group_mapping and passed as kwarg to upsert_contact for all 5 triage labels
- _apply_warning_label method added: same non-blocking pattern as _apply_error_label, applies @MailroomWarning to triggering emails only
- name_mismatch gating: warning label applied only when upsert returns name_mismatch=True AND warnings_enabled=True
- @ToPerson label routes through same Imbox flow as @ToImbox with contact_type="person"
- 19 new tests covering contact_type passthrough, @ToPerson routing/conflicts, and warning label behavior

## Task Commits

Each task was committed atomically:

1. **Task 1: RED -- Failing tests for contact_type passthrough, @ToPerson routing, and @MailroomWarning** - `c530187` (test)
2. **Task 2: GREEN -- Implement contact_type routing, @MailroomWarning, and name mismatch handling** - `1c34c6a` (feat)

_Note: TDD plan with RED/GREEN commits_

## Files Created/Modified
- `src/mailroom/workflows/screener.py` - Added _apply_warning_label method; _process_sender extracts contact_type from mapping and passes to upsert_contact; name_mismatch handling with conditional warning
- `tests/test_screener_workflow.py` - 19 new tests for contact_type passthrough (4 labels), @ToPerson routing (4 tests), conflict detection (4 tests), warning label (7 tests); updated 15 existing mock return values with name_mismatch: False; updated 4 existing assertions with contact_type kwarg

## Decisions Made
- _apply_warning_label follows same pattern as _apply_error_label: per-email Email/set calls wrapped in try/except for non-blocking behavior
- Warning applied only to triggering email IDs (not all swept emails from sender) -- matches the scope of the name mismatch detection
- name_mismatch check uses result.get("name_mismatch", False) for backward safety with any callers that don't return name_mismatch

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated existing test assertions for contact_type kwarg**
- **Found during:** Task 2
- **Issue:** 4 existing tests (test_upsert_contact_called, test_poll_passes_display_name_to_upsert, test_display_name_none_when_missing, test_display_name_none_when_sender_not_in_names) asserted upsert_contact called with 3 positional args but implementation now passes contact_type kwarg
- **Fix:** Added contact_type="company" to assert_called_once_with in affected tests
- **Files modified:** tests/test_screener_workflow.py
- **Verification:** All 180 tests pass
- **Committed in:** 1c34c6a (Task 2 commit)

---

**Total deviations:** 1 auto-fixed (1 bug in existing test assertions due to intentional behavior change)
**Impact on plan:** Necessary consequence of the planned change. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- contact_type flows end-to-end: config -> workflow -> CardDAV for all 5 triage labels
- @MailroomWarning application ready for end-to-end validation in Plan 03
- All 180 tests pass with zero regressions
- @ToPerson label fully integrated into poll cycle (routing, conflicts, contact creation)

## Self-Check: PASSED

- All key files exist on disk
- Both task commits verified in git log (c530187, 1c34c6a)
- 180 tests pass with zero regressions

---
*Phase: 03.1-person-contact-type-with-toperson-label*
*Completed: 2026-02-25*
