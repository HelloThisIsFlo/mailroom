---
phase: 03.1-person-contact-type-with-toperson-label
plan: 01
type: tdd
wave: 1
depends_on: []
files_modified:
  - src/mailroom/core/config.py
  - src/mailroom/clients/carddav.py
  - tests/conftest.py
  - tests/test_config.py
  - tests/test_carddav_client.py
  - pyproject.toml
autonomous: true
requirements:
  - "CDAV-03 (extended)"

must_haves:
  truths:
    - "create_contact with contact_type='company' produces vCard with FN + ORG + empty N and no first/last name"
    - "create_contact with contact_type='person' produces vCard with FN + N(first,last) parsed via nameparser and no ORG"
    - "create_contact with single-word display name produces person vCard with given name only, empty family"
    - "create_contact with no display name uses email prefix as given name for person type"
    - "New contacts get NOTE 'Added by Mailroom on {date}'"
    - "upsert_contact appends 'Updated by Mailroom on {date}' to existing notes without overwriting"
    - "@ToPerson appears in triage_labels and label_to_group_mapping with contact_type='person'"
    - "All existing triage labels have contact_type='company' in label_to_group_mapping"
    - "@MailroomWarning and warnings_enabled config fields exist with correct defaults"
  artifacts:
    - path: "src/mailroom/core/config.py"
      provides: "@ToPerson label, @MailroomWarning label, warnings_enabled toggle, contact_type in mapping"
      contains: "label_to_person"
    - path: "src/mailroom/clients/carddav.py"
      provides: "Company/person vCard construction, NOTE append, name mismatch signal"
      contains: "contact_type"
    - path: "tests/test_carddav_client.py"
      provides: "Tests for company/person contact creation, NOTE behavior"
      contains: "test_create_contact_company"
    - path: "tests/test_config.py"
      provides: "Tests for new config fields and mapping"
      contains: "label_to_person"
  key_links:
    - from: "src/mailroom/clients/carddav.py"
      to: "nameparser.HumanName"
      via: "import and call in create_contact"
      pattern: "from nameparser import HumanName"
    - from: "src/mailroom/core/config.py"
      to: "src/mailroom/clients/carddav.py"
      via: "contact_type key in label_to_group_mapping consumed by workflow"
      pattern: "contact_type"
---

<objective>
Extend config with @ToPerson/@MailroomWarning fields and refactor CardDAV `create_contact()` to produce company-type (ORG + empty N) or person-type (N with first/last via nameparser) vCards. Update NOTE field behavior for upsert. Add nameparser dependency.

Purpose: The foundational layer changes that all workflow routing depends on. Without correct vCard construction, Fastmail cannot distinguish companies from people. Without config fields, the workflow has no labels to route.

Output: Updated config.py with new fields/mapping, refactored carddav.py with contact_type support, nameparser added to dependencies, all tests passing.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-CONTEXT.md
@.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-RESEARCH.md
@src/mailroom/core/config.py
@src/mailroom/clients/carddav.py
@tests/conftest.py
@tests/test_config.py
@tests/test_carddav_client.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: RED -- Failing tests for config extensions and company/person contact creation</name>
  <files>
    tests/test_config.py
    tests/test_carddav_client.py
    tests/conftest.py
  </files>
  <action>
**Config tests (test_config.py):**
- Test `label_to_person` field defaults to `"@ToPerson"`
- Test `label_mailroom_warning` field defaults to `"@MailroomWarning"`
- Test `warnings_enabled` field defaults to `True`
- Test `triage_labels` property includes `@ToPerson` (5 labels total)
- Test `label_to_group_mapping` has `@ToPerson` entry with `contact_type: "person"`, `group: "Imbox"`, `destination_mailbox: "Inbox"`
- Test all existing mapping entries have `contact_type: "company"`
- Test `label_to_group_mapping["@ToPerson"]` routes to same group/destination as `@ToImbox`

**conftest.py:**
- Add `"@ToPerson": "mb-toperson"` and `"@MailroomWarning": "mb-warning"` to `mock_mailbox_ids`

**CardDAV tests (test_carddav_client.py):**

*Company contact creation (default):*
- Test `create_contact(email, display_name, contact_type="company")` produces vCard with `ORG` set to `[display_name]`, `N` empty (`N:;;;;`), `FN` = display_name, no first/last in N
- Test `create_contact(email, None, contact_type="company")` uses email prefix for FN and ORG
- Test company vCard includes `NOTE: "Added by Mailroom on {date}"`

*Person contact creation:*
- Test `create_contact(email, "Jane Smith", contact_type="person")` produces vCard with `N:Smith;Jane;;;`, `FN:Jane Smith`, no ORG field
- Test `create_contact(email, "Jane", contact_type="person")` produces `N:;Jane;;;` (family empty)
- Test `create_contact(email, None, contact_type="person")` uses email prefix as given name, family empty
- Test person vCard includes `NOTE: "Added by Mailroom on {date}"`
- Test person vCard has NO `org` field in card.contents

*NOTE field behavior in upsert:*
- Test `upsert_contact` on existing contact with no note: adds "Added by Mailroom on {date}"
- Test `upsert_contact` on existing contact with existing note: appends "\n\nUpdated by Mailroom on {date}" below existing note (never overwrites)
- Test `upsert_contact` on existing contact with existing note preserves original note content

*Name mismatch signal in upsert:*
- Test `upsert_contact` returns `name_mismatch: True` in result dict when existing contact FN differs from display_name (case-insensitive, stripped comparison)
- Test `upsert_contact` returns `name_mismatch: False` when names match
- Test `upsert_contact` returns `name_mismatch: False` when contact is new (created, not existing)

All tests MUST fail (RED). Run: `pytest tests/test_config.py tests/test_carddav_client.py -x` -- expect failures.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && pytest tests/test_config.py tests/test_carddav_client.py -x 2>&1 | tail -5</automated>
    <manual>Verify tests fail for the right reasons (missing fields, wrong vCard structure, missing contact_type parameter)</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>New tests exist and fail because config fields don't exist yet, create_contact doesn't accept contact_type, upsert_contact doesn't return name_mismatch, and NOTE append logic is not implemented</done>
</task>

<task type="auto">
  <name>Task 2: GREEN -- Implement config extensions, nameparser dependency, and company/person contact creation</name>
  <files>
    src/mailroom/core/config.py
    src/mailroom/clients/carddav.py
    pyproject.toml
  </files>
  <action>
**Step 1: Add nameparser dependency**
```bash
cd /Users/flo/Work/Private/Dev/Services/mailroom && uv add nameparser
```

**Step 2: Config changes (config.py):**
- Add field `label_to_person: str = "@ToPerson"`
- Add field `label_mailroom_warning: str = "@MailroomWarning"`
- Add field `warnings_enabled: bool = True`
- Add `self.label_to_person` to `triage_labels` property return list
- Add `contact_type: "company"` to ALL existing entries in `label_to_group_mapping`
- Add new entry for `self.label_to_person` in `label_to_group_mapping`:
  ```python
  self.label_to_person: {
      "group": self.group_imbox,
      "destination": self.group_imbox,
      "destination_mailbox": "Inbox",
      "contact_type": "person",
  },
  ```

**Step 3: CardDAV create_contact (carddav.py):**
- Add `from nameparser import HumanName` at top of file
- Add `contact_type: str = "company"` parameter to `create_contact()`
- Refactor vCard construction:
  - **Company (default):** `card.add("n").value = vobject.vcard.Name()` (empty N produces `N:;;;;`) + `card.add("org").value = [name]` (ORG is a list per vCard 3.0 spec)
  - **Person:** Parse name with `HumanName(name)`, set `card.add("n").value = vobject.vcard.Name(given=parsed.first, family=parsed.last)`, NO org field
- Keep FN, EMAIL, UID, NOTE behavior the same for both types
- NOTE on new contacts: `"Added by Mailroom on {date.today().isoformat()}"`

**Step 4: CardDAV upsert_contact NOTE behavior (carddav.py):**
- Change the existing NOTE handling in `upsert_contact`:
  - If existing contact has a note with content: append `"\n\nUpdated by Mailroom on {date.today().isoformat()}"` below existing note value
  - If existing contact has no note or empty note: add `"Added by Mailroom on {date.today().isoformat()}"`
  - Remove the `if not note_value:` guard that currently skips notes on existing contacts
  - Always set/update the note for existing contacts (this is new behavior per CONTEXT.md)
  - Mark `changed = True` when note is modified

**Step 5: Name mismatch signal in upsert_contact:**
- Add `name_mismatch: bool` to the returned dict from `upsert_contact`
- For new contacts (action="created"): always `name_mismatch: False`
- For existing contacts: compare `display_name.strip().lower()` against existing `card.fn.value.strip().lower()`
  - If display_name is None or empty: `name_mismatch: False` (nothing to compare)
  - If different: `name_mismatch: True`
  - If same: `name_mismatch: False`

Run: `pytest tests/ -x` -- ALL tests must pass (GREEN), including the new ones from Task 1.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && pytest tests/ -x</automated>
    <manual>Check that no existing tests broke (137 tests from Phase 3 should still pass alongside new tests)</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>nameparser installed, config has all new fields and updated mapping with contact_type, create_contact produces correct company/person vCards, upsert_contact handles NOTE append and returns name_mismatch signal, ALL tests pass</done>
</task>

</tasks>

<verification>
- `pytest tests/ -x` passes all tests (existing + new)
- `python -c "from nameparser import HumanName; print(HumanName('Jane Smith').first)"` prints "Jane"
- `python -c "from mailroom.core.config import MailroomSettings; import os; os.environ['MAILROOM_JMAP_TOKEN']='x'; s=MailroomSettings(); print(len(s.triage_labels), s.label_to_group_mapping[s.label_to_person])"` shows 5 labels and person mapping
</verification>

<success_criteria>
- Config: 5 triage labels, all mapping entries have contact_type, @MailroomWarning + warnings_enabled fields
- CardDAV: company vCards have ORG + empty N, person vCards have N(first,last) + no ORG
- NOTE: new contacts get "Added by", existing contacts get "Updated by" appended
- Upsert: returns name_mismatch boolean
- All tests pass with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-01-SUMMARY.md`
</output>
