---
milestone: v1.1
audited: 2026-03-02T12:00:00Z
status: tech_debt
scores:
  requirements: 18/18
  phases: 5/6
  integration: 14/14
  flows: 4/4
gaps:
  requirements: []
  integration: []
  flows: []
tech_debt:
  - phase: 09.1.1-helm-chart-migration-with-podsecurity-hardening
    items:
      - "Missing VERIFICATION.md (UAT 8/8 passed — no formal requirements assigned, not a requirement blocker)"
  - phase: cross-phase
    items:
      - "human-tests/test_13_docker_polling.py line 95: MAILROOM_POLL_INTERVAL=30 env var silently ignored — config.yaml is now the config source; test intent (30s poll) is nullified"
      - "src/mailroom/setup/sieve_guidance.py line 43: accesses settings._resolved_categories (private attr) — fragile coupling, consider public property"
      - "tests/conftest.py lines 24-31: stale env var cleanup list includes 7 vars that no longer map to any MailroomSettings field"
---

# v1.1 "Push & Config" — Milestone Audit Report

**Milestone Goal:** Replace polling with push notifications, make triage categories user-configurable, and add automated Fastmail setup.

**Audited:** 2026-03-02
**Status:** TECH DEBT (all requirements met, no critical blockers, minor items accumulated)
**Previous Audits:** 2026-02-28 (passed, 4 phases); 2026-02-28 (tech_debt, pre-Phase-9)

## Requirements Coverage (18/18)

### 3-Source Cross-Reference

| REQ-ID | Description | VERIFICATION.md | SUMMARY Frontmatter | REQUIREMENTS.md | Final Status |
|--------|-------------|-----------------|---------------------|-----------------|--------------|
| CONFIG-01 | Triage categories as structured list | Phase 6: SATISFIED | 06-01 | [x] Complete | **satisfied** |
| CONFIG-02 | Configurable via JSON env var | Phase 6: SATISFIED | 06-01 | [x] Complete | **satisfied** |
| CONFIG-03 | Default categories match v1.0 | Phase 6: SATISFIED | 06-01 | [x] Complete | **satisfied** |
| CONFIG-04 | Derived properties from category mapping | Phase 6: SATISFIED | 06-02 | [x] Complete | **satisfied** |
| CONFIG-05 | User can add custom categories | Phase 6: SATISFIED | 06-02 | [x] Complete | **satisfied** |
| CONFIG-06 | Startup validation rejects invalid configs | Phase 6: SATISFIED | 06-01 | [x] Complete | **satisfied** |
| SETUP-01 | Setup creates mailboxes via JMAP | Phase 7: SATISFIED | 07-01, 07-02, 07-04 | [x] Complete | **satisfied** |
| SETUP-02 | Setup creates contact groups via CardDAV | Phase 7: SATISFIED | 07-01, 07-02, 07-04 | [x] Complete | **satisfied** |
| SETUP-03 | Setup is idempotent | Phase 7: SATISFIED | 07-02, 07-03, 07-04 | [x] Complete | **satisfied** |
| SETUP-04 | Setup outputs sieve rule instructions | Phase 7: SATISFIED | 07-03, 07-04 | [x] Complete | **satisfied** |
| SETUP-05 | Setup requires --apply flag | Phase 7: SATISFIED | 07-02, 07-03, 07-04 | [x] Complete | **satisfied** |
| SETUP-06 | Setup reads same config as service | Phase 7: SATISFIED | 07-01, 07-02, 07-04 | [x] Complete | **satisfied** |
| PUSH-01 | SSE connects with Bearer auth | Phase 8: SATISFIED | 08-01 | [x] Complete | **satisfied** |
| PUSH-02 | State events trigger debounced triage | Phase 8: SATISFIED | 08-01, 08-03 | [x] Complete | **satisfied** |
| PUSH-03 | Liveness detection via ping timeout | Phase 8: SATISFIED | 08-01 | [x] Complete | **satisfied** |
| PUSH-04 | Auto-reconnect with exponential backoff | Phase 8: SATISFIED | 08-01, 08-03 | [x] Complete | **satisfied** |
| PUSH-05 | Health endpoint reports SSE status | Phase 8: SATISFIED | 08-02 | [x] Complete | **satisfied** |
| PUSH-06 | Triage latency under 10 seconds | Phase 8: SATISFIED | 08-02, 08-03 | [x] Complete | **satisfied** |

**Orphaned requirements:** None. All 18 REQ-IDs appear in at least one phase VERIFICATION.md and at least one SUMMARY frontmatter.

## Phase Verification Summary (5/6 formally verified)

| Phase | Status | Score | Re-verified | Notes |
|-------|--------|-------|-------------|-------|
| 06 — Configurable Categories | PASSED | 15/15 | No | CONFIG-01..06 all satisfied |
| 07 — Setup Script | PASSED | 23/23 | Yes (Plan 04 gap closure) | SETUP-01..06 all satisfied |
| 08 — EventSource Push | PASSED | 20/20 | Yes (Plan 03 gap closure) | PUSH-01..06 all satisfied |
| 09 — Tech Debt Cleanup | PASSED | 5/5 | No | No formal requirements; all success criteria met |
| 09.1 — Config YAML Migration | PASSED | 6/6 | No | No formal requirements; all success criteria met |
| 09.1.1 — Helm Chart Migration | **UNVERIFIED** | UAT 8/8 | N/A | Missing VERIFICATION.md; UAT confirms all success criteria pass |

**Note on Phase 09.1.1:** Inserted phase with no formal requirement IDs. UAT (8/8 passed) covers: Helm lint, template rendering, PSS restricted security, Setup Job hook, ConfigMap config.yaml, nil-safe secrets, k8s/ cleanup, and .gitignore. Missing VERIFICATION.md is a process gap, not a requirements gap.

## Cross-Phase Integration (14/14 exports wired)

Integration checker verified all cross-phase exports are properly connected.

### Key Integration Points

| From → To | Connection | Requirements | Status |
|-----------|-----------|--------------|--------|
| Phase 6 → Phase 7 | `settings.required_mailboxes`, `triage_labels`, `contact_groups` in provisioner | SETUP-06, CONFIG-01/04 | WIRED |
| Phase 6 → Phase 8 | `label_to_category_mapping` used in screener after SSE trigger | PUSH-02, CONFIG-04 | WIRED |
| Phase 7 ↔ Phase 8 | Both use `MailroomSettings()` — same config.yaml, same config | SETUP-06 | WIRED |
| Phase 9 → Phase 7 | Colors module extracted; imported by reporting.py and sieve_guidance.py | — | WIRED |
| Phase 9.1 → All | Nested config paths used throughout: `settings.polling.*`, `settings.labels.*`, `settings.triage.*` | — | WIRED |
| Phase 9.1.1 → Phase 9.1 | Helm ConfigMap renders config.yaml; Deployment mounts via MAILROOM_CONFIG | — | WIRED |

No orphaned exports. No missing connections.

### E2E Flow Verification (4/4 Complete)

| Flow | Description | Status |
|------|-------------|--------|
| Service startup → SSE push → triage | MailroomSettings → JMAPClient.event_source_url → sse_listener → event_queue → debounce → workflow.poll() → HealthHandler | COMPLETE |
| `mailroom setup` → provision → sieve | CLI → run_setup() → MailroomSettings → plan/apply → create_mailbox/create_group → sieve guidance | COMPLETE |
| Category routing pipeline | screener._process_sender() → label_to_category_mapping → ResolvedCategory attrs | COMPLETE |
| Helm deploy → service | values.yaml → configmap.yaml template → volume mount → MAILROOM_CONFIG → MailroomSettings | COMPLETE |

## Tech Debt (4 items, non-blocking)

### Phase 09.1.1 — Process Gap
- **Missing VERIFICATION.md:** UAT 8/8 covers equivalent ground. No formal requirements assigned. Not a requirement blocker.

### Cross-Phase — Stale Test Artifact
- **`human-tests/test_13_docker_polling.py` line 95:** Passes `MAILROOM_POLL_INTERVAL=30` as env var to Docker container. Post-Phase-9.1, polling interval is read from `config.yaml` only — the env var is silently ignored. Test still passes but at 60s instead of intended 30s.

### Cross-Phase — Fragile Coupling
- **`src/mailroom/setup/sieve_guidance.py` line 43:** Accesses `settings._resolved_categories` (private attribute). Works correctly but would break silently if renamed. Consider adding a public `resolved_categories` property.

### Cross-Phase — Stale Test Hygiene
- **`tests/conftest.py` lines 24–31:** Env var cleanup list scrubs 7 names that no longer map to any `MailroomSettings` field. Harmless but stale documentation.

### Previous Audit Tech Debt — All Resolved

The 2026-02-28 audit identified 11 tech debt items. Phase 9 resolved all of them:

| Item | Resolution |
|------|-----------|
| Human tests 3, 7-12 stale API references | Phase 09-01: Updated to `label_to_category_mapping` |
| `.env.example` had 9 deleted env vars | Phase 09-01: Replaced with current vars |
| `k8s/configmap.yaml` stale env vars | Phase 09-01: Synced (later superseded by Helm chart) |
| `JMAPClient.session_capabilities` dead code | Phase 09-01: Property, field, and tests removed |
| Duplicate ANSI color helpers | Phase 09-02: Extracted to `mailroom.setup.colors` |

## Milestone Definition of Done

| Goal | Status | Evidence |
|------|--------|----------|
| Replace polling with push notifications | ACHIEVED | SSE listener + queue-based debounced loop; fallback polling preserved; health endpoint reports SSE status |
| Make triage categories user-configurable | ACHIEVED | config.yaml triage.categories (evolved from JSON env var); custom categories work end-to-end |
| Add automated Fastmail setup | ACHIEVED | `mailroom setup --apply` provisions mailboxes + contact groups; sieve guidance included |

All three pillars achieved. All 18 formal requirements satisfied. Config system evolved from env vars (Phase 6) through config.yaml (Phase 9.1) to Helm chart (Phase 9.1.1).

---

_Audited: 2026-03-02T12:00:00Z_
_Auditor: Claude (gsd-audit-milestone)_
_Previous: 2026-02-28T02:00:00Z (passed, 4-phase scope)_
