---
phase: 03.1-person-contact-type-with-toperson-label
plan: 03
type: execute
wave: 3
depends_on: ["03.1-02"]
files_modified:
  - human-tests/test_11_person_contact.py
  - human-tests/test_12_company_contact.py
autonomous: false
requirements:
  - "CDAV-03 (extended)"
  - "TRIAGE-02 (extended)"

must_haves:
  truths:
    - "Human test verifies @ToPerson creates a person-type contact in Fastmail (FN + N with first/last, no ORG)"
    - "Human test verifies @ToImbox creates a company-type contact in Fastmail (FN + ORG, empty N)"
    - "Human test verifies @ToPerson routes to Imbox group and sweeps emails like @ToImbox"
    - "Human test verifies NOTE field is set on new contacts"
  artifacts:
    - path: "human-tests/test_11_person_contact.py"
      provides: "Live Fastmail validation of @ToPerson person-type contact creation"
    - path: "human-tests/test_12_company_contact.py"
      provides: "Live Fastmail validation of company-type contact creation via @ToImbox"
  key_links:
    - from: "human-tests/test_11_person_contact.py"
      to: "src/mailroom/workflows/screener.py"
      via: "Exercises full poll cycle with @ToPerson label"
      pattern: "poll()"
    - from: "human-tests/test_12_company_contact.py"
      to: "src/mailroom/workflows/screener.py"
      via: "Exercises full poll cycle with @ToImbox label"
      pattern: "poll()"
---

<objective>
Create human integration tests that validate person-type and company-type contact creation against live Fastmail. These verify the end-to-end flow: apply triage label -> poll -> contact created with correct type -> emails swept.

Purpose: The unit tests prove the code logic is correct, but only live Fastmail validation proves the vCard fields render correctly (company icon vs person icon, ORG display, N field parsing). Human tests are first-class citizens in this project.

Output: Two new human test scripts ready to run against live Fastmail.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-CONTEXT.md
@.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-01-SUMMARY.md
@.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-02-SUMMARY.md
@human-tests/test_7_screener_poll.py
@human-tests/test_5_carddav_contacts.py
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create human test scripts for person and company contact types</name>
  <files>
    human-tests/test_11_person_contact.py
    human-tests/test_12_company_contact.py
  </files>
  <action>
Follow the existing pattern from `test_7_screener_poll.py` -- standalone scripts with own connection/validation, step-level PASS/FAIL reporting, interactive pauses for visual verification.

**Prerequisites (document at top of each script):**
- @ToPerson label must exist in Fastmail (as a sublabel or standalone)
- @MailroomWarning label must exist in Fastmail
- Test sender emails must be in Screener mailbox with appropriate triage label applied

**test_11_person_contact.py:**
1. Connect JMAP + CardDAV clients
2. Resolve mailboxes (including @ToPerson and @MailroomWarning)
3. Instruct user: "Apply @ToPerson label to an email from a known sender (e.g., a person) in Screener. Press Enter when done."
4. Run `poll()` once
5. Verify via CardDAV search: new contact exists with correct email
6. Fetch the contact vCard and verify:
   - FN field is set (display name from email)
   - N field has given name and/or family name (not empty `N:;;;;`)
   - No ORG field present
   - NOTE contains "Added by Mailroom"
7. Verify via JMAP: @ToPerson label removed, emails swept from Screener
8. Print PASS/FAIL for each check
9. Pause for visual verification: "Check Fastmail Contacts -- sender should appear as a PERSON (not a company). Press Enter when done."

**test_12_company_contact.py:**
1. Connect JMAP + CardDAV clients
2. Resolve mailboxes
3. Instruct user: "Apply @ToImbox label to an email from a known sender (e.g., a newsletter/company) in Screener. Press Enter when done."
4. Run `poll()` once
5. Verify via CardDAV search: new contact exists with correct email
6. Fetch the contact vCard and verify:
   - FN field is set
   - N field is empty (`N:;;;;` -- all components empty)
   - ORG field is present and matches FN
   - NOTE contains "Added by Mailroom"
7. Verify via JMAP: @ToImbox label removed, emails swept from Screener
8. Print PASS/FAIL for each check
9. Pause for visual verification: "Check Fastmail Contacts -- sender should appear as a COMPANY (with organization icon). Press Enter when done."

Both scripts should follow existing human test patterns:
- Load credentials from env vars (dotenv)
- Each test is standalone (own client connections)
- Manual cleanup instructions at the end (delete test contacts)
- Clear PASS/FAIL output per step
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -c "import ast; ast.parse(open('human-tests/test_11_person_contact.py').read()); ast.parse(open('human-tests/test_12_company_contact.py').read()); print('Both scripts parse OK')"</automated>
    <manual>Run scripts against live Fastmail and verify person/company contacts appear correctly</manual>
    <sampling_rate>run after this task commits, before next task begins</sampling_rate>
  </verify>
  <done>Two human test scripts exist, parse without errors, and follow existing patterns. Ready for manual execution against live Fastmail.</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify person and company contacts render correctly in Fastmail</name>
  <action>
Human integration tests for person-type (@ToPerson) and company-type (@ToImbox) contact creation against live Fastmail.

Steps:
1. Ensure @ToPerson and @MailroomWarning labels exist in Fastmail
2. Run `python human-tests/test_11_person_contact.py` -- follow prompts to apply @ToPerson label and verify person contact
3. Run `python human-tests/test_12_company_contact.py` -- follow prompts to apply @ToImbox label and verify company contact
4. Check Fastmail Contacts for correct rendering (person icon vs company icon)
5. Verify NOTE field on created contacts
6. Clean up test contacts after verification
  </action>
  <verify>User confirms PASS on both test scripts and visual Fastmail verification</verify>
  <done>Person contacts render as people (with name), company contacts render as companies (with org icon) in Fastmail UI</done>
</task>

</tasks>

<verification>
- Both human test scripts parse without syntax errors
- Scripts follow existing patterns (standalone, dotenv, step-level reporting)
- When run against live Fastmail: person contacts show as persons, company contacts show as companies
- NOTE field correctly set on new contacts
</verification>

<success_criteria>
- test_11_person_contact.py validates @ToPerson creates person-type contact
- test_12_company_contact.py validates @ToImbox creates company-type contact
- Both scripts produce clear PASS/FAIL output per step
- User confirms correct Fastmail rendering after visual inspection
</success_criteria>

<output>
After completion, create `.planning/phases/03.1-person-contact-type-with-toperson-label/03.1-03-SUMMARY.md`
</output>
