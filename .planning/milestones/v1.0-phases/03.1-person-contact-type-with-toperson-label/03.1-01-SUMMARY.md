---
phase: 03.1-person-contact-type-with-toperson-label
plan: 01
subsystem: contacts
tags: [nameparser, vcard, carddav, config, pydantic-settings]

# Dependency graph
requires:
  - phase: 02-carddav-client-validation-gate
    provides: CardDAV client with create_contact, upsert_contact, vCard construction
  - phase: 03-triage-pipeline
    provides: ScreenerWorkflow with triage label routing via label_to_group_mapping
provides:
  - contact_type field in label_to_group_mapping (company/person routing)
  - Company vCard construction (ORG + empty N)
  - Person vCard construction (N first/last via nameparser, no ORG)
  - @ToPerson triage label config and mapping
  - @MailroomWarning label and warnings_enabled toggle
  - required_mailboxes property for conditional startup validation
  - name_mismatch signal in upsert_contact result
  - NOTE append behavior (never overwrite existing notes)
affects: [03.1-02-PLAN.md, 03.1-03-PLAN.md]

# Tech tracking
tech-stack:
  added: [nameparser]
  patterns: [contact_type dispatch in vCard construction, NOTE append-never-overwrite, name_mismatch signal for upstream warning]

key-files:
  created: []
  modified:
    - src/mailroom/core/config.py
    - src/mailroom/clients/carddav.py
    - tests/test_config.py
    - tests/test_carddav_client.py
    - tests/test_screener_workflow.py
    - tests/conftest.py
    - pyproject.toml

key-decisions:
  - "Company vCard uses empty vobject.vcard.Name() for N:;;;; and ORG as list [name] per vCard 3.0 spec"
  - "Person vCard uses nameparser.HumanName for first/last parsing, single-word names get given only"
  - "NOTE append: existing contacts get '\\n\\nUpdated by Mailroom on {date}' appended, never overwrite"
  - "name_mismatch: case-insensitive stripped comparison of FN vs display_name, False for new contacts"
  - "required_mailboxes collects all startup-required mailboxes including conditional @MailroomWarning"

patterns-established:
  - "contact_type dispatch: create_contact branches on contact_type param for company vs person vCard fields"
  - "NOTE append-never-overwrite: always update note on existing contacts, preserving original content"
  - "name_mismatch signal: boolean in upsert result dict for upstream warning decisions"

requirements-completed: ["CDAV-03 (extended)"]

# Metrics
duration: 6min
completed: 2026-02-25
---

# Phase 3.1 Plan 01: Config Extensions and Company/Person Contact Creation Summary

**Config with @ToPerson/@MailroomWarning fields, CardDAV company/person vCard dispatch via nameparser, NOTE append behavior, and name_mismatch signal**

## Performance

- **Duration:** 6 min
- **Started:** 2026-02-25T01:02:27Z
- **Completed:** 2026-02-25T01:08:45Z
- **Tasks:** 2
- **Files modified:** 7

## Accomplishments
- Config extended with @ToPerson label, @MailroomWarning label, warnings_enabled toggle, and contact_type in all mapping entries
- CardDAV create_contact refactored to produce company vCards (ORG + empty N) or person vCards (N first/last via nameparser)
- NOTE field behavior changed: existing contacts always get "Updated by Mailroom" appended, never overwriting original notes
- upsert_contact returns name_mismatch boolean for upstream warning decisions
- required_mailboxes property added for centralized startup mailbox validation

## Task Commits

Each task was committed atomically:

1. **Task 1: RED -- Failing tests for config extensions and company/person contact creation** - `d588674` (test)
2. **Task 2: GREEN -- Implement config extensions, nameparser dependency, and company/person contact creation** - `0315310` (feat)

_Note: TDD plan with RED/GREEN commits_

## Files Created/Modified
- `src/mailroom/core/config.py` - Added @ToPerson, @MailroomWarning, warnings_enabled fields; contact_type in mapping; required_mailboxes property
- `src/mailroom/clients/carddav.py` - Added nameparser import; contact_type dispatch in create_contact; NOTE append in upsert; name_mismatch signal
- `tests/test_config.py` - 10 new tests for config extensions; updated existing tests for 5-entry mapping with contact_type
- `tests/test_carddav_client.py` - 14 new tests for company/person creation, NOTE append, name mismatch; updated existing tests for NOTE behavior
- `tests/test_screener_workflow.py` - Updated triage label count assertion (4 -> 5)
- `tests/conftest.py` - Added @ToPerson and @MailroomWarning to mock_mailbox_ids
- `pyproject.toml` - Added nameparser dependency

## Decisions Made
- Company vCard uses empty `vobject.vcard.Name()` for `N:;;;;` and ORG as list `[name]` per vCard 3.0 spec
- Person vCard uses `nameparser.HumanName` for first/last parsing; single-word names produce given-only
- NOTE append uses `\n\n` separator between original note and Mailroom update marker
- name_mismatch comparison is case-insensitive and stripped; None/empty display_name returns False
- required_mailboxes uses set comprehension for unique destination mailboxes

## Deviations from Plan

### Auto-fixed Issues

**1. [Rule 1 - Bug] Updated existing tests for new NOTE behavior**
- **Found during:** Task 2
- **Issue:** Three existing tests (test_upsert_existing_contact_adds_to_group, test_upsert_existing_contact_no_overwrite, test_upsert_existing_contact_merge_cautious) expected old NOTE skip behavior; now NOTE always appends on existing contacts
- **Fix:** Added contact update PUT mocks and updated assertions to expect NOTE append
- **Files modified:** tests/test_carddav_client.py
- **Verification:** All 161 tests pass
- **Committed in:** 0315310 (Task 2 commit)

**2. [Rule 1 - Bug] Updated existing tests for new mapping structure**
- **Found during:** Task 2
- **Issue:** test_label_group_mapping expected 4 entries without contact_type; test_triage_labels_property expected 4 labels; test_queries_all_triage_labels expected 4 queries
- **Fix:** Updated assertions to match 5 entries/labels with contact_type field
- **Files modified:** tests/test_config.py, tests/test_screener_workflow.py
- **Verification:** All 161 tests pass
- **Committed in:** 0315310 (Task 2 commit)

---

**Total deviations:** 2 auto-fixed (2 bugs in existing tests due to intentional behavior changes)
**Impact on plan:** Both fixes are necessary consequences of the planned changes. No scope creep.

## Issues Encountered
None

## User Setup Required
None - no external service configuration required.

## Next Phase Readiness
- Config foundation complete: @ToPerson and @MailroomWarning labels, contact_type routing, required_mailboxes
- CardDAV company/person vCard creation ready for workflow integration
- name_mismatch signal ready for @MailroomWarning application in Plan 02
- All 161 tests pass with zero regressions

## Self-Check: PASSED

- All key files exist on disk
- Both task commits verified in git log (d588674, 0315310)
- 161 tests pass with zero regressions

---
*Phase: 03.1-person-contact-type-with-toperson-label*
*Completed: 2026-02-25*
