---
phase: 04-packaging-and-deployment
plan: 03
type: execute
wave: 2
depends_on:
  - 04-01
  - 04-02
files_modified:
  - human-tests/test_5_docker_polling.py
autonomous: false
requirements:
  - DEPLOY-01
  - DEPLOY-02
  - DEPLOY-03
  - DEPLOY-04

must_haves:
  truths:
    - "Docker image builds and starts the polling loop against real Fastmail"
    - "Health endpoint responds to GET /healthz with 200 while container runs"
    - "Container shuts down gracefully on docker stop (SIGTERM)"
    - "Triaging a test email from the Fastmail app is processed by the containerized service"
  artifacts:
    - path: "human-tests/test_5_docker_polling.py"
      provides: "End-to-end Docker container verification script"
      min_lines: 40
  key_links:
    - from: "human-tests/test_5_docker_polling.py"
      to: "Dockerfile"
      via: "docker build + docker run commands"
      pattern: "docker"
---

<objective>
Verify the complete Docker packaging and deployment configuration with a human integration test against real Fastmail.

Purpose: Confirm that the Docker image builds, starts the polling loop, responds to health checks, processes triage labels from the real Fastmail account, and shuts down gracefully -- the end-to-end acceptance test for Phase 4.

Output: `human-tests/test_5_docker_polling.py` (integration test script), verified Docker image behavior
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/PROJECT.md
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/04-packaging-and-deployment/04-01-SUMMARY.md
@.planning/phases/04-packaging-and-deployment/04-02-SUMMARY.md

@src/mailroom/__main__.py
@Dockerfile
@k8s/configmap.yaml
@k8s/secret.yaml.example
@human-tests/
</context>

<tasks>

<task type="auto">
  <name>Task 1: Create Docker integration test script</name>
  <files>human-tests/test_5_docker_polling.py</files>
  <action>
Create `human-tests/test_5_docker_polling.py` following the existing human test pattern (standalone, step-level PASS/FAIL, dotenv for credentials). The script tests the Docker container end-to-end:

**Script structure:**
1. Load `.env` for Fastmail credentials (same as other human tests)
2. Build the Docker image: `docker build -t mailroom:human-test .`
3. Run the container with env vars from `.env` passed via `--env-file` or individual `-e` flags
4. Verify health endpoint: `curl http://localhost:8080/healthz` returns 200
5. Pause for user to apply a triage label in Fastmail iOS/web app
6. Wait for the next poll cycle (up to poll_interval + buffer)
7. Verify the triage was processed (check logs with `docker logs`)
8. Stop the container gracefully: `docker stop` (sends SIGTERM)
9. Verify graceful shutdown in logs: look for `service_stopped`

Use `subprocess.run` for Docker commands. Use `httpx` or `urllib.request` for health checks.

Follow existing human test conventions:
- Standalone script with `if __name__ == "__main__":`
- Step-level print with PASS/FAIL
- Interactive pauses with `input()` for manual verification steps
- Load dotenv at top

Set poll_interval to 30 seconds (via MAILROOM_POLL_INTERVAL env var) for faster test cycles.

Include cleanup: `docker rm -f mailroom-human-test` at start and end.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && python -c "import ast; ast.parse(open('human-tests/test_5_docker_polling.py').read()); print('syntax ok')"</automated>
    <manual>Run the script manually: python human-tests/test_5_docker_polling.py</manual>
  </verify>
  <done>human-tests/test_5_docker_polling.py exists as a standalone Docker integration test following the project's human test conventions</done>
</task>

<task type="checkpoint:human-verify" gate="blocking">
  <name>Task 2: Verify Docker container processes triage end-to-end</name>
  <files>human-tests/test_5_docker_polling.py</files>
  <action>
Human verification checkpoint. Complete Docker packaging has been built: __main__.py polling loop, Dockerfile, k8s manifests, and human test script. The containerized service should poll Fastmail, process triage labels, and respond to health checks.

The user must run the human test script to validate Phase 4 Docker packaging:

1. Run the human test: `python human-tests/test_5_docker_polling.py`
2. When prompted, apply a triage label (e.g., @ToImbox) to a test email in Fastmail
3. Wait for the script to detect processing (poll interval set to 30s for testing)
4. Verify the script reports:
   - Docker build: PASS
   - Health endpoint: PASS
   - Triage processing: PASS (check docker logs for poll_complete with processed > 0)
   - Graceful shutdown: PASS (service_stopped in logs)
5. Verify in Fastmail that the test email was moved to the correct destination

Type "approved" if all checks pass, or describe any issues.
  </action>
  <verify>
    <automated>cd /Users/flo/Work/Private/Dev/Services/mailroom && test -f human-tests/test_5_docker_polling.py && echo "human test exists"</automated>
    <manual>Run python human-tests/test_5_docker_polling.py and verify all steps PASS</manual>
  </verify>
  <done>Docker container builds, starts polling loop, responds to health checks, processes triage labels from real Fastmail, and shuts down gracefully on SIGTERM</done>
</task>

</tasks>

<verification>
1. Docker image builds successfully from the Dockerfile
2. Container starts and the polling loop begins (service_started in logs)
3. Health endpoint on port 8080 returns 200
4. A triage label applied in Fastmail is processed by the containerized service
5. `docker stop` triggers graceful shutdown (service_stopped in logs, no SIGKILL)
</verification>

<success_criteria>
- The containerized Mailroom service processes triage labels end-to-end against real Fastmail
- Health probes work correctly for k8s readiness/liveness
- SIGTERM graceful shutdown completes within the termination grace period
- Human test script is a first-class citizen in human-tests/ following existing conventions
</success_criteria>

<output>
After completion, create `.planning/phases/04-packaging-and-deployment/04-03-SUMMARY.md`
</output>
