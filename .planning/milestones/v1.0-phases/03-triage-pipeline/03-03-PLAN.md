---
phase: 03-triage-pipeline
plan: 03
type: tdd
wave: 1
depends_on: ["03-02"]
files_modified:
  - src/mailroom/clients/jmap.py
  - src/mailroom/workflows/screener.py
  - tests/test_jmap_client.py
  - tests/test_screener_workflow.py
autonomous: true
requirements: [TRIAGE-01, TRIAGE-02, TRIAGE-03, TRIAGE-04, TRIAGE-05, TRIAGE-06]
gap_closure: true

must_haves:
  truths:
    - "get_email_senders() returns both sender email AND sender display name from the JMAP From header"
    - "Contact created via the triage pipeline uses the sender's real display name from the email, not the email prefix"
    - "Existing tests continue to pass after the return type change (backward compatible call sites updated)"
  artifacts:
    - path: "src/mailroom/clients/jmap.py"
      provides: "get_email_senders returning dict[str, tuple[str, str | None]]"
      contains: "from_list[0].get(\"name\")"
    - path: "src/mailroom/workflows/screener.py"
      provides: "_collect_triaged returning sender_names dict, _process_sender using display name"
      contains: "sender_names"
    - path: "tests/test_jmap_client.py"
      provides: "Tests verifying name extraction from get_email_senders"
      contains: "test_get_senders_returns_name"
    - path: "tests/test_screener_workflow.py"
      provides: "Tests verifying display name flows from collection to upsert_contact"
      contains: "display_name"
  key_links:
    - from: "jmap.py get_email_senders"
      to: "screener.py _collect_triaged"
      via: "return value tuple unpacking"
      pattern: "senders\\[email_id\\]"
    - from: "screener.py _collect_triaged"
      to: "screener.py _process_sender"
      via: "sender_names dict passed through poll()"
      pattern: "sender_names"
    - from: "screener.py _process_sender"
      to: "carddav.py upsert_contact"
      via: "display_name parameter"
      pattern: "upsert_contact\\(sender.*display_name"
---

<objective>
Fix sender display name propagation from JMAP From header through the triage pipeline to contact creation.

Purpose: UAT Test 6 found that contacts are created with email prefix as name (e.g., "hello" for hello@domain.com) instead of the sender's actual display name from the From header. The root cause is that `get_email_senders()` discards `from[0]['name']` and `_process_sender()` passes `None` for display_name to `upsert_contact()`.

Output: Updated `get_email_senders()` returning `(email, name)` tuples, updated `_collect_triaged()` and `_process_sender()` propagating display names, all existing tests updated and new tests added.
</objective>

<execution_context>
@/Users/flo/.claude/get-shit-done/workflows/execute-plan.md
@/Users/flo/.claude/get-shit-done/templates/summary.md
</execution_context>

<context>
@.planning/ROADMAP.md
@.planning/STATE.md
@.planning/phases/03-triage-pipeline/03-UAT.md
@.planning/phases/03-triage-pipeline/03-02-SUMMARY.md
@src/mailroom/clients/jmap.py
@src/mailroom/workflows/screener.py
@tests/test_jmap_client.py
@tests/test_screener_workflow.py
@tests/conftest.py
</context>

<feature>
  <name>Sender display name propagation</name>
  <files>
    src/mailroom/clients/jmap.py
    src/mailroom/workflows/screener.py
    tests/test_jmap_client.py
    tests/test_screener_workflow.py
  </files>
  <behavior>
    The From header in JMAP emails contains both `name` and `email` fields:
    ```json
    {"from": [{"name": "Alice Smith", "email": "alice@example.com"}]}
    ```

    Currently `get_email_senders()` returns `dict[str, str]` (email_id -> email).
    It must return `dict[str, tuple[str, str | None]]` (email_id -> (email, name_or_None)).

    Cases:
    - From header `{"name": "Alice Smith", "email": "alice@example.com"}` -> `("alice@example.com", "Alice Smith")`
    - From header `{"name": "", "email": "hello@domain.com"}` -> `("hello@domain.com", None)` (empty name treated as None)
    - From header `{"name": null, "email": "hello@domain.com"}` -> `("hello@domain.com", None)`
    - From header with no name key `{"email": "hello@domain.com"}` -> `("hello@domain.com", None)`
    - No From header -> email skipped (existing behavior)

    In `_collect_triaged()`:
    - Build a `sender_names: dict[str, str | None]` alongside the `raw` dict
    - For each sender, store the first non-None/non-empty display name seen across their emails
    - Return both the triaged dict and the sender_names dict (change return type to a tuple)

    In `poll()`:
    - Unpack the new return from `_collect_triaged()`
    - Pass `sender_names` to `_process_sender()`

    In `_process_sender()`:
    - Accept `sender_names: dict[str, str | None]` parameter
    - Look up `display_name = sender_names.get(sender)`
    - Pass it to `self._carddav.upsert_contact(sender, display_name, group_name)` instead of `None`

    All call sites in `poll()` and `_detect_conflicts()` must be updated for the new `_collect_triaged()` return shape.
  </behavior>
  <implementation>
    **jmap.py changes:**
    1. Update `get_email_senders()` return type annotation from `dict[str, str]` to `dict[str, tuple[str, str | None]]`
    2. Update docstring to document the new return shape
    3. Extract `from_list[0].get("name")` alongside `from_list[0]["email"]`
    4. Normalize empty/whitespace-only names to None: `name = from_list[0].get("name") or None; if name and not name.strip(): name = None`
    5. Store as tuple: `result[email["id"]] = (from_list[0]["email"], name)`

    **screener.py _collect_triaged() changes:**
    1. Change return type to `tuple[dict[str, list[tuple[str, str]]], dict[str, str | None]]`
    2. Add `sender_names: dict[str, str | None] = {}` alongside `raw`
    3. After calling `get_email_senders()`, unpack tuples: `sender_email, sender_name = senders[email_id]`
    4. Store first non-None name: `if sender not in sender_names or (sender_names[sender] is None and sender_name is not None): sender_names[sender] = sender_name`
    5. Use `sender_email` (not the whole tuple) as the dict key in `raw`
    6. Return `(raw, sender_names)` at end (and `({}, {})` for early returns)
    7. Also return `(filtered, sender_names)` for the errored-email filtered path

    **screener.py poll() changes:**
    1. Unpack: `triaged, sender_names = self._collect_triaged()`
    2. Update early return: check `not triaged` (still works, it's a dict)
    3. Pass `sender_names` to `_process_sender(sender, emails, sender_names)`

    **screener.py _process_sender() changes:**
    1. Add `sender_names: dict[str, str | None]` parameter
    2. Look up: `display_name = sender_names.get(sender)`
    3. Replace `self._carddav.upsert_contact(sender, None, group_name)` with `self._carddav.upsert_contact(sender, display_name, group_name)`

    **test_jmap_client.py changes:**
    1. Update all existing `TestGetEmailSenders` test assertions from `{"e1": "alice@example.com"}` to `{"e1": ("alice@example.com", "Alice Smith")}` (or appropriate name)
    2. Add `test_get_senders_returns_name` -- verifies name is extracted
    3. Add `test_get_senders_empty_name_returns_none` -- empty string name -> None
    4. Add `test_get_senders_missing_name_returns_none` -- no name key -> None

    **test_screener_workflow.py changes:**
    1. Update all `jmap.get_email_senders.return_value` from `{"e1": "alice@example.com"}` to `{"e1": ("alice@example.com", "Alice Smith")}` across ALL test classes (this is a bulk find-and-replace with test-specific name values)
    2. Add test: `test_display_name_passed_to_upsert` -- verifies _process_sender passes the sender's display name from sender_names to upsert_contact
    3. Add test: `test_display_name_none_when_missing` -- verifies None is passed when no name available
    4. Verify existing behavior tests still pass with new tuple format
  </implementation>
</feature>

<verification>
```bash
uv run pytest tests/test_jmap_client.py tests/test_screener_workflow.py -v
```

Full suite regression check:
```bash
uv run pytest tests/ -q
```

All 125+ tests must pass with zero failures.
</verification>

<success_criteria>
- get_email_senders() returns (email, name) tuples where name is extracted from JMAP From header
- Empty/whitespace names are normalized to None
- _collect_triaged() builds and returns sender_names dict
- _process_sender() passes sender display name to upsert_contact() instead of None
- All existing tests updated for new return type and still pass
- New tests verify name extraction and propagation
- Full test suite passes with zero regressions
</success_criteria>

<output>
After completion, create `.planning/phases/03-triage-pipeline/03-03-SUMMARY.md`
</output>
